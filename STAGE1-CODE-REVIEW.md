# Code Review: feature/gpt5-stage1

**Дата**: 2025-11-20  
**Ветка**: `feature/gpt5-stage1`  
**Ревьюер**: AI Assistant  
**Scope**: Stage 1 — базовая клиентская сборка (M2.3-PLAN.md)

---

## Исполнительное резюме

Ветка реализует минимальный TypeScript-клиент на Vite, который получает server snapshots и рисует сцену в стиле «рисованный космический роман». Архитектура чистая, слои разделены. Готово к дальнейшей доработке (Stage 2), но есть технические долги: нет unit-тестов по клиентской логике, дублируются физические константы, ряд магических чисел нужно вынести в конфиг. Градиенты в рендере уже оптимизированы (кэшируются).

**Итоговая оценка**: 8.5/10

---

## Основные компоненты

### 1. GameClient.ts
Точка входа: инициализирует TransportLayer, InputManager, SnapshotRenderer. Игровой цикл делит опрос ввода, сеть и рендер.

**Замечания**: fixedDeltaTime жестко задаётся в TransportLayer (1/60); если сервер работает на другой частоте, лучше вынести в конфиг. Параметр `_timestamp` в loop не используется.

### 2. NetworkClient.ts
Обертка над WebSocket: реконнект с backoff, отправка/приём protobuf. Rate limiting (30 Hz). Добавлен счётчик decode-ошибок (3 ошибки → disconnect).

**Замечания**: sendInput при rate limiting возвращает 0 — стоит задокументировать контракт. Magic numbers backoff’а жёстко заданы.

### 3. NetworkManager.ts
Координатор NetworkClient ↔ PredictionEngine. Reconciliation по lastProcessedSequence.

**Замечания**: protoToState дублирует конвертацию — можно вынести в общий util.

### 4. PredictionEngine.ts
Клиентская физика с историей и перемоткой.

**Риски**: физические константы (DEFAULT_PHYSICS) захардкожены и могут разойтись с сервером. Нужно вынести в shared источник (M3 план).

### 5. InputManager.ts
Нормализует ввод, поддерживает toggles (online/hud/mode/autopilot/impulse), yaw от мыши.

**Замечания**: чувствительность yaw (0.0025) захардкожена; лучше в конфиг.

### 6. SnapshotRenderer.ts
Canvas 2D рендер, кэширует градиенты, звёзды генерируются один раз.

**Замечания**: viewRadius = 900 захардкожен (масштаб/zoom не настраивается).

### 7. SnapshotStore.ts
Хранит последний snapshot, теперь делается лёгкое копирование полей (без structuredClone).

### 8. TransportLayer.ts
Управляет lifecycle NetworkManager, очищает старый менеджер перед реконнектом, подавляет фантомные callbacks.

**Замечания**: формула backoff — набор magic numbers; стоит вынести в конфиг.

---

## Потенциальные проблемы

1) Дублирование физики (P0 для M3): DEFAULT_PHYSICS в PredictionEngine не синхронизированы с сервером. Требуется общий источник (JSON/TS+C#).

2) Магические числа (P2): yawSensitivity, viewRadius, reconnect base/max/backoff, fixedDeltaTime (1/60). Вынести в client config.

3) Отсутствие unit-тестов (P1): нет тестов на PredictionEngine (FA:ON/OFF лимиты, reconcile), InputManager (конфликтующие клавиши), SnapshotStore (данные неизменяемы), транспорт (backoff/статусы).

4) Обработка мусорных данных (P2): decode error threshold фиксирован на 3, но не конфигурируем. Возможно, нужно логировать «дроп» пакетов.

---

## Code smells (минор)

- loop в GameClient принимает `_timestamp`, но не использует.
- protoToState дублируется — можно вынести.
- drawEntity принимает развернутый объект вместо RenderEntity.
- Логирование напрямую через console в некоторых местах — пригодится инъекция logger для тестов.

---

## Метрики качества

| Метрика                 | Значение           | Цель       | Статус          |
|-------------------------|--------------------|------------|-----------------|
| TypeScript strict       | strict             | strict     | ✔               |
| ESLint errors           | 0                  | 0          | ✔               |
| Unit tests              | частично (1 spec)  | >60%       | ✖ (недостаточно) |
| Integration tests       | требуют поднять .NET сервер (последний прогон упал по таймауту старта) | 4/4 зелёные при работающем сервере | ⏳ |
| Bundle size             | ~90 KB             | <150 KB    | ✔               |
| Build time              | ~300 ms            | <500 ms    | ✔               |

---

## Что работает хорошо
- Чёткое разделение слоёв: GameClient → TransportLayer → NetworkManager → NetworkClient.
- Prediction/reconciliation реализованы корректно и используют lastProcessedSequence.
- Рендер быстрый и стилистически выраженный; градиенты теперь кэшируются.
- Алиасы Vite/TS настроены, строгая типизация без any.

---

## Рекомендации

**До Stage 2 (высокий приоритет)**  
1. Вынести физические константы в shared файл и подключить и в C#, и в TS.  
2. Добавить unit-тесты: PredictionEngine (лимиты/перемотка), InputManager (конфликтные клавиши, yaw), SnapshotStore (иммутабельность), TransportLayer backoff (можно моками).  
3. Параметризовать magic numbers (yawSensitivity, viewRadius, backoff-параметры, fixedDeltaTime) через конфиг.

**Средний приоритет**  
- Сделать порог decode-ошибок конфигурируемым и логировать «дроп» соединения.  
- Использовать timestamp в loop или убрать параметр.  
- Вынести protoToState в общий util и использовать там, где нужно.

---

## Соответствие M2.3-PLAN Stage 1

| Требование (Stage 1)                   | Статус | Примечание                                     |
|----------------------------------------|--------|------------------------------------------------|
| TypeScript-проект на Vite              | ✔      | Алиасы настроены                               |
| Транспортный слой (WebSocket)          | ✔      | Реконнект, логирование                         |
| Сериализация (protobuf.js)             | ✔      | Типы сгенерированы                             |
| Рендеринг (Canvas 2D)                  | ✔      | «Космический роман» стилистика                 |
| Ввод (InputManager)                    | ✔      | WASD + мышь + хоткеи                           |
| Сборка/проверка                        | ⏳     | Интеграции проходят при поднятом сервере; локально нужен запуск dotnet сервера |

---

## Следующие шаги
1. Поднять общий источник физических констант (M3 задача).
2. Добавить юнит-тесты на клиентскую логику (особенно PredictionEngine).
3. Вынести параметры ввода/рендера/сети в клиентский конфиг.
4. Повторно прогнать интеграционные тесты с запущенным .NET сервером.***
