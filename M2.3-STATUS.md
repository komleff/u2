# Отчет о статусе M2.3

**Дата**: 2025-11-20
**Майлстоун**: M2.3 Предсказание на стороне клиента (Client-Side Prediction)
**Статус**: ✅ M2.3 DoD Выполнен (Все задачи завершены)

---

## Сводка

Майлстоун M2.3 завершен. Мы реализовали полный цикл предсказания и согласования (reconciliation) на стороне клиента, проверенный строгими интеграционными тестами с симуляцией сетевой задержки.

**Ключевые достижения**:

- **WebSocket Relay**: Надежная двусторонняя связь между браузером и UDP-сервером.
- **Поток данных согласования**: Сквозное отслеживание порядковых номеров (`lastProcessedSequence`).
- **Тесты задержки**: Подтверждена ошибка предсказания < 1м (RTT 50мс) и сходимость < 2с (RTT 200мс).
- **Исправление ошибок**: Устранены критические проблемы с маппингом EntityId во всем стеке.

---

## Детали реализации

### Созданные компоненты

1. **`src/server/Network/WebSocketRelay.cs`** (210 строк)
   - WebSocket-сервер на базе HttpListener
   - ConcurrentDictionary для маппинга эндпоинтов (WebSocket ↔ Виртуальный IPEndPoint)
   - Принимает соединения на `ws://localhost:8080/`
   - Маршрутизирует бинарные сообщения в UdpServer через `ProcessReceivedDataAsync()`

2. **`src/server/Network/UdpServer.cs`** (модификации)
   - Добавлен внутренний метод `ProcessReceivedDataAsync()` для инъекции WebSocket
   - Добавлен `AttachWebSocketRelay()` для двусторонней маршрутизации
   - Модифицирован `SendAsync()` для обнаружения виртуальных эндпоинтов (порт >= 50000) и маршрутизации в WebSocket

3. **`src/server/Program.cs`** (модификации)
   - Инициализирует WebSocketRelay в RunNetworkMode()
   - Подключает реле к UdpServer для двусторонней связи
   - Логирует URL WebSocket-сервера при запуске

### Ключевые проектные решения

**Паттерн виртуальных эндпоинтов**:

- Каждое WebSocket-соединение → `IPEndPoint(IPAddress.Loopback, 50000+)`
- ConnectionManager обрабатывает WebSocket-клиентов идентично UDP-клиентам
- Не требуются изменения в MessageProcessor, NetworkGameLoop или ECS-системах

**Почему HttpListener вместо ASP.NET Core WebSockets**:

- Более простой граф зависимостей (нет рантайма ASP.NET Core)
- Архитектура консольного приложения (нет веб-хост билдера)
- Прямой контроль над жизненным циклом WebSocket
- Достаточно для MVP M2.3 (в продакшене можно использовать Kestrel/YARP)

---

## Результаты тестов

### Задержка и согласование (2025-11-20)

**Тест RTT 50мс**:

- **Средняя ошибка предсказания**: 0.043м (Цель: < 1.0м) ✅
- **Макс. ошибка**: 0.936м
- **Выборки**: 76

**Тест RTT 200мс**:

- **Время сходимости**: 62мс (Цель: < 2000мс) ✅
- **Макс. расхождение**: 0.600м

**Тест стабильности**:

- **Длительность**: 5с @ 200мс RTT
- **Ввод**: 108 отправлено
- **Снэпшоты**: 74 получено
- **Результат**: Стабильное соединение, без разрывов ✅

### Тест соединения

**Логи сервера**:

```log
info: U2.Server.Network.WebSocketRelay[0]
      WebSocket relay listening on ws://localhost:8080/
      
info: U2.Server.Network.WebSocketRelay[0]
      WebSocket connected: [::1]:55375 -> Virtual 127.0.0.1:50001
      
info: U2.Server.Network.UdpServer[0]
      New client connected: 1 from 127.0.0.1:50001
```

**Клиент**:

- Браузер успешно подключился к `ws://localhost:8080/`
- Назначен виртуальный эндпоинт: `127.0.0.1:50001`
- ConnectionManager зарегистрировал клиента (всего: 1)

**Валидация Protobuf**:

- Отправлены сырые тестовые байты `[0x01, 0x02, 0x03, 0x04]`
- Ожидаемая ошибка: `InvalidProtocolBufferException` (невалидное сообщение Protobuf)
- ✅ Подтверждает, что маршрутизация сообщений работает сквозным образом
- ✅ MessageProcessor корректно отклоняет невалидные сообщения

**Статус сборки**:

- ✅ `dotnet build -c Release` → 0 ошибок
- ⚠️ 36 предупреждений (Entitas v1.13.0 нацелен на .NET Framework, ожидаемо)

---

## Прогресс M2.3 P0

| Задача | Статус | Примечания |
|--------|--------|------------|
| **1. WebSocket relay server** | ✅ ГОТОВО | Протестировано, двусторонняя маршрутизация подтверждена |
| **2. Integration test (connect + input + snapshot)** | ✅ ГОТОВО | `network.spec.ts` проходит (4/4) |
| **3. Connect NetworkManager to sandbox** | ✅ ГОТОВО | Песочница работает онлайн |
| **4. Reconciliation Data Flow** | ✅ ГОТОВО | `lastProcessedSequence` реализован |
| **5. Audit Findings Fixes** | ✅ ГОТОВО | Все замечания устранены |
| **8. RTT Latency Tests** | ✅ ГОТОВО | `latency.spec.ts` проходит (3/3) |

---

## Следующие шаги

1. **Слияние в Main**:
   - PR готов к финальному ревью и слиянию.
   - Тегирование релиза `v0.2.3`.

2. **Начало M3.0 (Игровой цикл)**:
   - Фокус на боевых механиках и подсчете очков.
   - Реализация спавна и разрушения астероидов.
