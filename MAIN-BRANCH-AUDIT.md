# Аудит ветки `main` (2025-11-19)

## Краткое резюме

- Линтер проходит без ошибок (`npm run lint`), но интеграционные тесты падают, потому что окружение не содержит .NET SDK/`dotnet` для серверной части.
- Клиентская часть по умолчанию конфигурирована на `ws://localhost:8080/` и ожидает поднятый .NET сервер; без него онлайн‑режим и интеграционные тесты недоступны.
- Пререквизиты и шаги запуска backend`а не задокументированы в README, что делает ветку фактически непроходимой для CI/локального запуска без ручных догадок.

## Наблюдения по сборке и тестам

- `npm run lint` — ✅ (без предупреждений).  
- `npm test` — ❌: оба интеграционных набора (`tests/integration/network.spec.ts`, `tests/integration/latency.spec.ts`) падают на этапе `beforeAll` с ошибкой `spawn dotnet ENOENT`, т.к. в окружении нет `dotnet` и не настроен путь к серверу.

## Ключевые проблемы

### 1) Неявная зависимость от .NET сервера ломает интеграционные тесты

- Тесты поднимают C# сервер через `dotnet run --project src/server/U2.Server.csproj` и считают успешным старт по логам, но процесс не может быть создан без установленного .NET SDK.
- README перечисляет только Node.js/npm как пререквизиты и не описывает установку/запуск backend`а, поэтому воспроизводимость «из коробки» отсутствует.
- **Риск:** любые CI/CD среды без предварительно установленного .NET или без явного шага публикации сервера будут всегда «красными».

**Рекомендации:**

- Обновить README с явным перечнем зависимостей (.NET 8 SDK) и шагами запуска `dotnet run --project src/server/U2.Server.csproj -- --network` перед тестами.
- Добавить guard в интеграционные тесты (skip/soft-fail), если `dotnet` недоступен, либо предоставить mock/stub сервера для фронтенд-интеграций.
- Рассмотреть публикацию собранного self-contained сервера в `scripts/` или Docker для CI.

### 2) Жёстко закодированный адрес сервера и отсутствующие fallback`и

- Клиентский код использует фиксированный `ws://localhost:8080/` и клавишу `O` для включения онлайн-режима; при отсутствии сервера пользователь сразу получает ошибку подключения.
- Нет конфигурации через окружение/файлы (Vite env), и нет graceful fallback`а (например, отключение кнопки или сообщение о недоступности онлайн-режима).

**Рекомендации:**

- Вынести сетевые параметры в `.env`/`import.meta.env` и давать разумные default`ы.
- Добавить уведомление/баннер при недоступности сервера и переключать UI в offline, не оставляя пользователя в неопределённом состоянии.

### 3) Тестовое покрытие фактически отсутствует без backend`а

- Из трёх тестовых файлов только smoke-тест проходит; две интеграции полностью зависят от внешнего сервера и не выполняют проверок бизнес-логики без него.
- Нет unit-тестов для сетевого клиента/менеджера и предикции, хотя код содержит нетривиальную логику (рейт-лимитинг, reconciliation).

**Рекомендации:**

- Добавить чистые unit-тесты для `NetworkClient`/`NetworkManager`/`PredictionEngine` с моками WebSocket/протокола.
- Для интеграций использовать lightweight mock-сервер (например, Node + ws) или контрактные тесты с фиктивными protobuf-сообщениями, чтобы не требовать .NET.

## Итог

Ветка `main` формально собирается и линтится, но остаётся неработоспособной без дополнительной .NET инфраструктуры, о которой не сказано в документации. До внесения корректировок CI будет падать, а пользователи не смогут воспроизвести онлайн-функциональность и интеграционные тесты.
