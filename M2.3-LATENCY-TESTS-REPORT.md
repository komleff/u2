# M2.3 RTT Latency Tests - Updated Report

**Status**: ✅ UPDATED (Task #8 from M2.3 DoD)  
**Branch**: `codex-m2.3-physics-sync`  
**Date**: 2025-11-21  

---

## Summary

Обновлены метрики интеграционных тестов с общим physics.json и новой структурой клиента:
- ✅ RTT 50ms: средняя ошибка предсказания **1.51 m** (max 3.64 m) по 75 снапшотам
- ✅ RTT 200ms: конвергенция за **528 ms** (max ошибка 0.91 m)
- ✅ Stability 200ms: 108 inputs / 74 snapshots за 5 s, disconnects = 0

По умолчанию интеграционные тесты пропускаются; запуск при `U2_RUN_INTEGRATION=1` или `U2_EXTERNAL_SERVER=1` (и работающем `dotnet run --project src/server/U2.Server.csproj -- --network`).

---

## Test Results

### Test 1: RTT 50ms — Prediction Error
```
Duration: 5000ms
Inputs Sent: 103
Samples Captured: 75
Average Error: 1.51m
Max Error: 3.64m
Status: ✅ PASS
```

### Test 2: RTT 200ms — Convergence Time
```
Duration: 5000ms
Inputs Sent: 10 (burst)
Convergence Time: 528ms
Max Divergence Observed: 0.91m
Status: ✅ PASS
```

### Test 3: Connection Stability (200ms RTT)
```
Duration: 5000ms
Inputs Sent: 108
Snapshots Received: 74
Connection: Stable (no disconnects)
Status: ✅ PASS
```

---

## Notes and Gaps
- Модель задержки детерминирована (one-way 25/100ms), без jitter/packet loss/reorder. Нужны добавки для WAN-профилей.
- Тесты одно-клиентские; нужно покрыть ≥2 клиента для проверки fairness и независимости lastProcessedSequence.
- Сбор артефактов: стоит логировать histogram RTT / prediction error для регрессий.

---

## How to Run

**Latency only**:
```powershell
U2_RUN_INTEGRATION=1 npm test -- tests/integration/latency.spec.ts
```

**All integration tests**:
```powershell
U2_RUN_INTEGRATION=1 npm test -- tests/integration/
```

Если сервер поднят отдельно:
```powershell
U2_EXTERNAL_SERVER=1 npm test -- tests/integration/latency.spec.ts
# сервер: dotnet run --project src/server/U2.Server.csproj -- --network
```

**Ожидаемо**: 7/7 интеграционных тестов проходят при работающем сервере.

---

## Next Steps
1) Добавить jitter/loss/reorder в LatencySimulator и метрики (histogram) в логи.  
2) Запускать ≥2 клиентов одновременно и проверять независимость снапшотов и error bounds.  
3) Включить latency suite в CI (nightly/manual) с флажком, артефакты — таблица ошибок/конвергенции.  
