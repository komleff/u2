# Рекомендации по исправлению тестов Flight Assist

## Статус текущей проблемы

**Ветка:** `feature/gpt5-fa-physics`  
**Статус:** 209/213 тестов прошли, 4 теста с атрибутом `[Ignore]`  
**Файл с проблемой:** `src/shared/Tests/ECS/FlightAssistSystemTests.cs`

## Ignored тесты (требуют переработки)

Следующие 4 теста отмечены как `[Ignore]` потому что новая реализация Flight Assist работает иначе:

### 1. FA_ON_DampsLinearVelocity_WhenIdle (line 153)

**Проблема:** Новая реализация не дампирует линейную скорость при отсутствии ввода

- **Ожидание старого теста:** После 300 frames (~5s) скорость должна снизиться до < 30% от начальной
- **Реальное поведение:** Скорость остаётся ~268 м/с (остаётся высокая)
- **Причина:** Новая реализация использует exponential damping с более низким коэффициентом

**Рекомендация:** Либо удалить этот тест (не соответствует дизайну), либо обновить реализацию

### 2. FA_ON_DoesNotDampAngularVelocity_WhenYawActive (line 131)

**Проблема:** Angular velocity немного меняется при active yaw input

- **Ожидание старого теста:** velocity.Angular должна быть точно равна исходной (Within 0.01f)
- **Реальное поведение:** velocity меняется на ~0.029 (Off by 0.029088854)
- **Причина:** Physics system добавляет angular acceleration при yaw input

**Рекомендация:** Изменить assertion на более мягкое (Allow > 90% от исходной)

### 3. FA_ON_LimitsForwardSpeed (line 52)

**Проблема:** Скорость не ограничивается до maxSpeed за 300 frames

- **Ожидание:** finalSpeed <= maxSpeed * 1.05f (262.6 м/с)
- **Реальное поведение:** finalSpeed ~ 277.2 м/с (выше лимита)
- **Причина:** Новая реализация использует более градуальное замедление

**Рекомендация:** Увеличить время сходимости до 600+ frames или изменить tolerance

### 4. FA_Toggle_ON_OFF_ChangesLimitingBehavior (line 191)

**Проблема:** Когда FA:OFF, скорость не сохраняется на высоком уровне

- **Ожидание:** speedWithFA_OFF > maxSpeed * 1.5f (390 м/с)
- **Реальное поведение:** speedWithFA_OFF ~ 251.6 м/с (меньше ожидаемого)
- **Причина:** После переключения FA и нескольких frames physics система влияет на скорость

**Рекомендация:** Увеличить начальную скорость или уменьшить время ожидания

## Стратегия исправления

### Вариант A: Обновить реализацию Flight Assist (РЕКОМЕНДУЕТСЯ)

Новая реализация слишком "мягкая" в плане ограничений скорости и damping. Нужно:

1. **Увеличить скорость damping при idle** в `ApplyAxisAssist()`
   - Текущее: использует медленный damping
   - Новое: должно быть более агрессивным, ~50% от текущей скорости за 60 frames

2. **Более агрессивно ограничивать forward speed** в `ApplyAxisAssist()`
   - Когда velocity > posLimit, нужно быстрее применять reverse thrust
   - Текущее: ComputeDecelInput() может быть недостаточным

3. **Проверить логику FA:OFF** в методе `Execute()`
   - Должна полностью отключить ограничения
   - Убедиться что physics система не переопределяет ввод

### Вариант B: Переписать тесты (АЛЬТЕРНАТИВА)

Если новое поведение - это намеренный дизайн, тесты должны быть обновлены:

1. **FA_ON_DampsLinearVelocity_WhenIdle:**
   - Удалить или изменить assertion на проверку что скорость хотя бы немного снизилась
   - Или признать что damping при idle не входит в M3.0 scope

2. **FA_ON_DoesNotDampAngularVelocity_WhenYawActive:**
   - Изменить на `Assert.That(ship.velocity.Angular, Is.GreaterThan(initialAngularVel * 0.9f))`
   - Это позволит небольшим изменениям из-за physics acceleration

3. **FA_ON_LimitsForwardSpeed:**
   - Увеличить convergence time до 600 frames
   - Или изменить tolerance на `maxSpeed * 1.15f`
   - Или добавить активный thrust=0 input

4. **FA_Toggle_ON_OFF_ChangesLimitingBehavior:**
   - Использовать более высокую начальную скорость (например `maxSpeed * 3.0f`)
   - Или уменьшить количество frames между переключением FA и проверкой скорости

## Ключевые файлы для изменений

- **`src/shared/ECS/Systems/FlightAssistSystem.cs`** (реализация)
  - Методы: `ApplyAxisAssist()`, `ComputeDecelInput()`, `ComputeYawDamping()`
  - Параметры damping, которые могут быть отрегулированы

- **`src/shared/Tests/ECS/FlightAssistSystemTests.cs`** (тесты)
  - Строки с `[Ignore]` атрибутами
  - Assertions которые нужны обновить

- **M3.0-PLAN.md** (документация)
  - Spec для damping, limiting, brake режимов

## Принципы исправления

**ДЕЛАЙ:**

- Проверь все 4 ignored теста и выясни их истинное назначение
- Запусти каждый тест с добавленным логированием чтобы увидеть реальное поведение
- Обнови либо реализацию, либо тесты - но консистентно
- Убедись что FA:ON и FA:OFF имеют явно разные поведения
- Проверь что все остальные 209 тестов остаются green

**НЕ ДЕЛАЙ:**

- Не просто добавляй [Ignore] ко всем failing тестам
- Не меняй тесты чтобы они проходили без понимания реального поведения
- Не игнорируй конфликт между дизайном и реализацией
- Не забывай про g-limit при ограничении ускорений

## Справочная информация

**M3.0 Scope:**

- Flight Assist режимы: FA:ON / FA:OFF (переключение на Z)
- FA:ON должна ограничивать скорость, ускорение, соблюдать g-limit
- FA:OFF должна быть свободным управлением (только thrust, no restrictions)
- Brake (SPACE) должна гасить скорости используя thruster/torque limits

**Physics конфиг (physics.json):**

- forward_accel_mps2: 90.0
- reverse_accel_mps2: 67.5
- crew_g_limit: 11.0
- linear_speed_max_mps.forward: 260.0

**Тайминг:**

- Physics tick: 30 Hz (dt = 1/30 ≈ 0.0333s)
- Tests используют: 1/60 ≈ 0.0167s (double frequency для точности)

## Следующие шаги для ИИ-агента

1. Прочитай все 4 ignored теста внимательно
2. Запусти каждый с дополнительным логированием
3. Определи какой паттерн верный:
   - Реализация правильная, тесты неправильные? → Обнови тесты
   - Тесты правильные, реализация неправильная? → Обнови реализацию
4. Обновленные тесты должны остаться в коде (не с [Ignore])
5. Убедись что полный test suite проходит (213/213)

## Критерии успеха

✅ Все 213 тестов проходят (0 failures, 0 ignores) ИЛИ

✅ Все ignores имеют ясные комментарии почему они отложены на будущее ИЛИ

✅ Поведение Flight Assist явно соответствует M3.0 спецификации
