# U2 — План для ИИ‑агентов

Версия: 0.8.6 (Merged from ChatGPT and Claude Sonnet)\
Дата: 2025‑11‑15

Документ описывает план разработки с участием ИИ‑агентов для прототипа космического симулятора **Universe Unlimited**. Версия 0.8.6 учитывает:

- актуальную архитектуру (U2 — Архитектура 0.8.6);
- вынесение тактико‑технических характеристик кораблей в отдельный документ **«U2 — ТТХ кораблей v0.8»**;
- рекомендации по упрощению и удешевлению реализации;
- переход на готовое ECS‑решение (Entitas);
- фиксированную скорость света c′ для каждой локации;
- смягчённые требования к детерминизму;
- один базовый режим ассистента (Stabilized) для этапов M0–M5;
- упрощённый HUD без «голограммы будущего» и дополнительных визуальных слоёв;
- отказ от режима Coupled в M0–M8.

Документ адресован:

- архитекторам и программистам клиент‑серверных приложений;
- техническим дизайнерам;
- ИИ‑агентам, которым нужны чёткие задачи, интерфейсы и критерии готовности.

---

## 0. Система единиц

Во всех расчётах используется система СИ:

- масса — килограммы (тонны для удобства записи);
- расстояние — метры;
- скорость — метры в секунду;
- ускорение — метры в секунду в квадрате;
- тяга — ньютон (или меганьютон для крупных кораблей);
- перегрузка: 1 g = 9,81 м/с².

Это явно фиксируется, чтобы ИИ‑агенты и разработчики одинаково понимали, в каких единицах задавать и интерпретировать параметры.

---

## 1. Исходные допущения

### 1.1. Мир, физика и скорость света

1. Игра стартует в одной звёздной системе в двумерной проекции (вид сверху). В дальнейшем возможно расширение до трёхмерной модели.
2. Сервер мира авторитетен: он хранит истинное состояние объектов и проверяет все команды игроков.
3. Используется замедленный свет с эффективной скоростью **c′**, которая в рамках одной локации/сценария считается **постоянной** и задаётся в конфигурации мира.
4. Эффекты относительности учитываются через коэффициент γ. Любые варианты поля скорости света c′(x), зависящего от координат или нагрузки, **не реализуются** в M0–M8.

### 1.2. Модель сессий и целевая нагрузка

1. Базовая модель сессий для M0–M8:
   - **PvE‑кооператив**: 1–4 игрока (хозяин сессии + до трёх приглашённых друзей) в рамках персональной вселенной;
   - основное внимание уделяется исследованию, полёту, базовым боям против ботов и кооперации.
2. PvP‑арены (например, 4 на 4) и корпоративные войны (десятки и более кораблей) рассматриваются как **расширение после M8 (M9+)**.
3. Целевая нагрузка для минимальной версии:
   - до 4 живых игроков;
   - до 8 ботов;
   - всего порядка 12 активных кораблей, из которых до 8 могут находиться в зоне близкого контакта.

### 1.3. Офлайн‑режим

1. Офлайн‑режим предназначен **для разработчиков и тестировщиков**, а не для игроков.
2. Цели офлайн‑режима:
   - воспроизведение и отладка полётных и боевых сценариев без сервера и сети;
   - ускоренная проверка изменений в физике, управлении, ассистентах, визуализации.
3. Офлайн‑режим не обязан давать побитово тот же результат, что и онлайн. Важно:
   - чтобы соблюдались ключевые инварианты (ограничения скоростей, устойчивость симуляции);
   - чтобы поведение в целом было схожим и пригодным для отладки.

### 1.4. Управление и ассистент

1. Источники команд управления:
   - локальный игрок (Local Input);
   - удалённый оператор (для беспилотных и захваченных кораблей);
   - автопилот (маршруты, стандартные манёвры);
   - сценарные и отладочные скрипты (для ботов и тестов).
2. Ассистенты пилота **не являются отдельным источником команд**. Они — промежуточный слой между источниками управления и двигателями.
3. В M0–M5 реализуется и настраивается **один режим ассистента**:
   - **Stabilized** — основной режим; гашение лишних вращений, сглаживание команд, контроль перегрузок, jerk‑лимитирование.
4. Свободный режим, Decoupled и сложный Coupled рассматриваются как расширения **после M8** (M9+), и в минимальный план не входят.

### 1.5. ТТХ кораблей

1. Все численные характеристики кораблей (масса, тяга, пределы перегрузок, геометрия корпуса, сигнатуры, щиты, броня, запас прочности и др.) вынесены в отдельный документ **«U2 — ТТХ кораблей v0.8»**.
2. В настоящем плане и в архитектуре используются только:
   - ссылки на документ ТТХ;
   - формулы и зависимости, объясняющие, как параметры участвуют в расчётах.

---

## 2. Технические решения по умолчанию

Если в планах этапов явно не указано иное, предполагаются следующие технические решения:

1. **Движок и платформы**
   - Клиент: Unity LTS, 2D top‑down режим.
   - Сервер: .NET 8, headless.
   - Общий код: физика, ECS‑компоненты, сетевые протоколы.

2. **ECS**
   - M0–M8: используется готовое ECS‑решение **Entitas** (Unity/ .NET).
   - Миграция на Unity DOTS рассматривается только при масштабировании до 50+ кораблей в бою.

3. **Сеть и протокол**
   - Транспорт: UDP для ПК/мобилок, WebSocket для WebGL.
   - Протокол: Protobuf (расширяемые сообщения).
   - Частоты обмена:
     - команды манёвра от клиента: 30 Гц;
     - снимки состояния и наблюдения от сервера: 15 Гц (адаптивно 10–20 Гц).

4. **Шаги симуляции и рендеринга**
   - Сервер: фиксированный шаг симуляции 30 Гц;
   - Клиент: предсказатель 60 Гц, рендер 60 кадров/сек.

5. **Числовая точность**
   - Сервер: double;
   - Клиент: float;
   - различия округления допустимы, сглаживаются reconciliation.

6. **Арбитраж источников управления**
   - Приоритет: Local > Remote > Autopilot > сценарии.
   - Плавное переключение между источниками: 150–200 мс.
   - Ассистент: пост‑обработка команд с возможностью эскалации влияния при авариях.

7. **Ассистент**
   - M0–M8: только режим Stabilized (PD‑контроллер + jerk‑лимитирование).
   - M9+: опциональные режимы Decoupled и Coupled (разрабатываются отдельно).

8. **Бой**
   - Стрельба только по захваченной цели (lock‑target);
   - вероятность попадания P_hit и урон считаются на сервере;
   - система HP/Shield/Armor привязана к ТТХ кораблей.

9. **Скорость света c′**
   - c′ фиксирована для каждой локации/сценария;
   - типичные значения: 1 000–10 000 м/с для боёв, до 100 000 м/с для «быстрого» межзвёздного пространства;
   - динамическое изменение c′ в зависимости от нагрузки **не используется**.

10. **Детерминизм**
    - строгий побитовый детерминизм **не требуется**;
    - достаточно статистической близости результатов (погрешность порядка 1%) при соблюдении инвариантов;
    - сервер авторитетен, client‑side prediction и reconciliation обязательны.

---

## 3. Базовые частоты и значения по умолчанию

### 3.1. Частоты работы системы

Для M0–M8 принимаются целевые значения:

- шаг физики на сервере: **30 Гц** (фиксированный);
- сетевые снимки состояния: **15 Гц** (диапазон 10–20 Гц);
- команды от клиента к серверу: **30 Гц**;
- отрисовка на клиенте: **60 кадров в секунду**.

Асинхронные уровни обновления:

- каждый тик (30 Гц): физика, управление, коллизии;
- каждый второй тик (15 Гц): нагрев и охлаждение, распределение тяги;
- каждый третий тик (10 Гц): искусственный интеллект и автопилот.

### 3.2. Скорость света c′

Для разных сценариев используются разные значения c′, но в рамках одной сессии c′ остаётся постоянной:

- тестовые сценарии и PoC: **c′ ≈ 1 000 м/с**;
- боевые сценарии M0–M8: **c′ ≈ 5 000 м/с** (допустим диапазон 3 000–10 000 м/с);
- экспериментальные сценарии: c′ до 100 000–300 000 м/с.

Точные значения фиксируются в конфигурации локации.

---

## 4. Сквозные правила этапирования

1. **Фиксация интерфейсов по этапам.** После завершения этапа интерфейсы считаются замороженными. В дальнейшем можно только добавлять новые поля, не ломая существующие.
2. **Воспроизводимость, а не строгий детерминизм.** Логика физики и ассистентов использует фиксированный шаг времени. Для офлайн‑тестов можно фиксировать генератор случайных чисел, но в онлайне строгий детерминизм не требуется. Клиент предсказывает своё движение, сервер остаётся источником истины.
3. **Тесты до UI.** Прежде чем выводить новую функцию в пользовательский интерфейс, должны быть готовы модульные и интеграционные тесты.
4. **Отладка как часть готовности.** Для каждого этапа фиксируется минимальный набор телеметрии и отладочных инструментов.
5. **Постоянная скорость света на локацию.** В M0–M8 не реализуется поле скорости света c′(x), зависящее от координат или нагрузке.

---

## 5. Этапы и задачи для ИИ‑агентов

Ниже перечислены основные этапы M0–M8 и ключевые задачи для ИИ‑агентов и разработчиков.

### M0. База проекта и валидация данных

#### M0.1. Репозиторий и сборка

- настроить структуру `shared/`, `server/`, `client/`;
- настроить автоматическую сборку и запуск тестов;
- оформить базовые правила оформления кода.

Результат: проект собирается «с нуля» одной командой, базовые тесты выполняются автоматически.

#### M0.2. Релятивистская математика и валидация номиналов

- реализовать в `shared/` базовые операции векторной математики и функции работы с c′ и γ;
- импортировать данные кораблей (nominals) в общий модуль;
- ввести проверки:
  - формулы тяги (`F = m × a` для маршевого ускорения);
  - диапазонов параметров (масса, ускорения, сигнатуры и др.);
  - вычисление радиуса корпуса по геометрии;
  - расчёт ориентировочных HP, щитов и брони по формальным правилам.

Результат: все корабли из nominals проходят проверки, а базовые формулы согласованы.

#### M0.3. Интеграция Entitas ECS

- подключить Entitas в клиент и сервер;
- описать базовые компоненты — положение, скорость, масса, тепловое состояние, состояние управления;
- завести пустые системы: физики, тепла, управления;
- реализовать сериализацию простых состояний объектов через Protobuf.

Результат: ECS‑каркас готов, создание/удаление объектов работает, системы обновляются в правильном порядке.

### M1. Физика и автономный клиент

#### M1.1. Серверная физика с фиксированным c′

- реализовать классическую ньютоновскую модель на сервере;
- добавить релятивистскую надстройку (γ) на основе фиксированного c′, взятого из конфигурации локации;
- убедиться в соблюдении инвариантов (скорость не превышает допустимую долю c′, симуляция устойчива).

Результат: модуль физики одинаково работает на сервере и в офлайн‑клиенте, параметры кораблей берутся из ТТХ.

#### M1.2. Офлайн‑клиент для разработчиков

- создать простую 2D‑сцену (фон, корабль, несколько объектов);
- вывести на HUD скорость, долю c′, γ, температуру, базовую телеметрию;
- обеспечить запуск локальной симуляции без сервера.

Результат: разработчик может локально воспроизводить сценарии разгона, торможения и разворотов.

### M2. Сеть, снапшоты и reconciliation

#### M2.1. Протокол и транспорт

- описать форматы сообщений (команды управления, снимки состояния, служебные сообщения) в Protobuf;
- реализовать минимальный обмен по UDP/WebSocket;
- обеспечить эволюцию протокола без поломки старых клиентов.

#### M2.2. Предсказание и reconciliation

- реализовать на клиенте предсказание своего движения между снимками сервера;
- реализовать мягкую корректировку (reconciliation) по серверным данным;
- ввести очередь будущих состояний чужих кораблей с задержкой порядка 100–200 мс.

Критерии:

- среднее расхождение позиции своего корабля относительно сервера — менее метра;
- среднее расхождение скорости — менее 0,1 м/с;
- при RTT до 200 мс движение выглядит плавным, нет резких «телепортов» собственного корабля.

Строгий детерминизм **не проверяется**: разрешены различия в числовой точности, reconciliation активен всегда.

### M3. Управление, арбитраж и базовый ассистент

#### M3.1. Источники управления и приоритеты

- формализовать источники: игрок, удалённый оператор, автопилот, сценарии;
- зафиксировать приоритеты: Local > Remote > Autopilot > сценарии;
- реализовать плавное переключение между источниками:
  - если игрок активно управляет, Local имеет приоритет;
  - если игрок отпустил управление на заданное время, управление может перейти автопилоту;
  - удалённый оператор может перехватить только у автопилота;
  - переходы между источниками сглаживаются за 150–200 мс.

Ассистент всегда работает поверх выбранного источника, а не вместо него.

#### M3.2. Ассистент: только Stabilized

- реализовать режим Stabilized, включающий:
  - стабилизацию вращения (PD‑контроллер);
  - jerk‑лимитирование по линейным и угловым ускорениям;
  - базовую эскалацию влияния ассистента при опасных режимах.

Критерии:

- при отпускании органов управления корабль останавливает вращение менее чем за 2 секунды без заметных перекрутов;
- линейное ускорение не меняется рывком (jerk ограничен);
- ассистент работает корректно для всех базовых архетипов из ТТХ.

Свободный, Decoupled и Coupled режимы выводятся за рамки M0–M5.

### M4. Наблюдение, задержка света и HUD

#### M4.1. Наблюдение с учётом задержки света

- сервер для каждого тика знает положения всех кораблей;
- для пары (наблюдатель, цель) рассчитывается:
  - расстояние;
  - время пролёта света как `t_flight = distance / c′` (c′ — константа локации);
- наблюдение маркируется временем показа `t_show = t_tick + t_flight + сетевой лаг`;
- клиент складывает наблюдения в очередь будущих состояний и показывает в момент t_show.

В один и тот же момент разные цели могут отображаться в разных моментах «своего прошлого» в зависимости от расстояния.

#### M4.2. HUD: базовая информация

HUD содержит:

- скорость (модуль и доля от c′);
- ускорение (модуль в g);
- ориентацию (курс, крен);
- температуру и долю от критической;
- состояние ассистента (нормальный режим / перехват управления);
- выбранную цель (тип, дистанция, задержка света, относительная скорость);
- состояние корабля (прочность корпуса, щиты по граням, броня);
- состояние вооружения (готовность к стрельбе, боезапас).

Отладочные показатели (RTT, jitter, размер очереди будущих состояний, FPS) по умолчанию скрыты и включаются отдельной комбинацией.

«Голограмма будущего» и похожие сложные визуальные слои **не используются**.

### M5. Эскалация ассистента и аварийные режимы

- настроить эскалацию влияния ассистента при:
  - чрезмерных угловых скоростях (потеря контроля);
  - перегреве;
  - опасном сближении с объектами;
  - критических повреждениях корпуса;
- реализовать плавный рост влияния ассистента до полного перехвата в экстренных ситуациях и плавный спад после стабилизации;
- вывести понятную индикацию перехвата в HUD.

Режим Coupled на этом этапе не реализуется.

### M5.5. Интеграция управления и прицеливания

Промежуточный этап между настройкой ассистента и боём:

- связать раскладку управления полётом и боем (полёт — WASD/стик, вращение — мышь/стик, стрельба и захват целей — отдельные кнопки);
- реализовать захват цели (клик/выбор по списку), индикацию выбранной цели и круг упреждения;
- связать состояние оружия с HUD (готовность, перезарядка, режим ведения огня).

Урон и детальная баллистика реализуются на M6.

### M6. Бой и боты

#### M6.1. Бой с lock‑target и P_hit

- реализовать механизмы захвата цели и стрельбы только по захваченной цели;
- реализовать на сервере расчёт вероятности попадания P_hit с учётом:
  - базовой точности оружия;
  - отношения характерного калибра к сигнатуре цели;
  - дистанции до цели;
  - относительной скорости;
  - γ‑фактора для быстро движущихся целей;
- при попадании рассчитывать урон на основе ТТХ оружия и защиты цели (щиты, броня, корпус).

Критерий: в оптимальном диапазоне дистанций и скоростей P_hit попадает в разумный диапазон (40–60 % для боёв «истребитель против истребителя»).

#### M6.2. Простые боты

- боты принимают решения с частотой порядка 10 Гц:
  - анализ ситуации (враги, союзники, препятствия);
  - выбор режима: патруль, атака, отступление;
  - расчёт целевых параметров движения и решения «стрелять/не стрелять»;
- каждый тик (30 Гц) ассистент и системы управления ведут корабль к целевым параметрам.

Базовое поведение:

- патруль по точкам;
- сближение и огонь по цели при достаточной вероятности попадания;
- отход при критическом уровне прочности.

Сложные манёвры, кооперация и учёт сложных препятствий выносятся за пределы M0–M8.

### M7. Нагрев, повреждения и распределение тяги

- задать рабочие диапазоны температур и перегрузок для подсистем корабля;
- связать нагрев с работой двигателей и оружия, охлаждение — с конструкцией корабля;
- реализовать последствия выхода за пределы (ограничение тяги, отказ подсистем);
- реализовать упрощённое распределение тяги:
  - на первых этапах — модель «виртуального двигателя»;
  - для сложных конфигураций — отдельный распределитель по реальным двигателям на основе их расположения и состояния.

### M8. Оптимизация и платформы

- собрать телеметрию по производительности и искать узкие места;
- оптимизировать наиболее тяжёлые участки (физика, коллизии, ИИ);
- подготовить и протестировать сборки для ПК, WebGL и мобильных устройств;
- реализовать минимальный набор аудио (двигатели, выстрелы, попадания, предупреждения).

---

## 6. Вехи и оценка сроков

Обновлённая оценка сроков с учётом упрощений:

- **M0 (база проекта, ECS, валидация номиналов, офлайн‑клиент)**: ~10 недель;
- **M1–M3 (серверная физика, сеть, ввод, ассистент)**: ~10 недель;
- **M4–M6 (наблюдение, HUD, эскалация ассистента, боёвка, боты)**: ~10 недель;
- **M7–M8 (нагрев, повреждения, тяга, оптимизация, платформы)**: ~4–6 недель.

Итого: **24–30 недель** (примерно 6–7 месяцев) до играбельного прототипа с 4 игроками и 8 ботами в PvE‑кооперативе.