# U2 — Архитектура игрового мира

Версия: 0.8.6 (Merged from ChatGPT and Claude Sonnet)

Документ описывает архитектуру прототипа космического симулятора **Universe Unlimited** для минимальной линейки версий M0–M8.

Архитектура согласована:
- с планом разработки **«U2 — План для ИИ‑агентов 0.8.6 (Merged)»**;
- с документом **«U2 — ТТХ кораблей v0.8»**, где хранятся все численные характеристики кораблей;
- с упрощённой моделью мира: двумерная проекция (вид сверху), авторитетный сервер, замедленный и фиксированный в локации свет.

Текст написан так, чтобы его мог понять технически подкованный читатель, не являющийся специалистом по физике, сетевому коду или игровой индустрии.

---

## 0. Система единиц

Во всех расчётах используется система СИ:

- масса — килограммы (для удобства записи часто используем тонны);
- расстояние — метры;
- скорость — метры в секунду;
- ускорение — метры в секунду в квадрате;
- тяга — ньютон (для крупных кораблей — меганьютон);
- перегрузка — в долях ускорения свободного падения: 1 g = 9,81 м/с².

Это важно для согласованной работы клиентской части, сервера, инструментов разработки и автоматических тестов.

---

## 1. Общая картина мира

### 1.1. Масштаб мира и нагрузка

Исходная версия игры работает в одной звёздной системе в виде двумерной карты «вид сверху».

Целевая нагрузка для минимальной версии (M0–M8):
- до 4 игроков в одной сессии (ведущий игрок и до трёх приглашённых друзей);
- до 8 управляемых компьютером кораблей (боты);
- всего около 12 активных кораблей, из них до 8 могут находиться в зоне плотного взаимодействия одновременно.

Модель сессий:
- **PvE‑кооператив** — основная модель: «персональная вселенная» ведущего игрока, куда он может пригласить друзей;
- **PvP‑арены 4 на 4** и **масштабные корпоративные войны** (десятки кораблей) рассматриваются как будущие расширения и в эту архитектурную версию не входят.

Такой масштаб упрощает физику, сетевой код и работу ассистентов, но уже даёт ощущение насыщенного боя и совместного полёта.

### 1.2. Клиент, сервер и авторитетность

- Мир рассчитывается на сервере. Сервер хранит «истинное» состояние всех кораблей и объектов.
- Клиент отображает мир, принимает ввод игрока, делает краткосрочные прогнозы движения и подтверждает свои решения данными сервера.
- Любые важные решения по физике, урону и проверке правил принимаются на сервере. Это защищает игру от ошибок и читерства.

### 1.3. Офлайн‑режим

Отдельный офлайн‑режим нужен только разработчикам и тестировщикам.

- В нём можно запускать отдельные сценарии полёта и боя без сервера и сети.
- В офлайн‑режиме **не требуется** побитовое совпадение с онлайном. Важно, чтобы выполнялись инварианты (ограничения скорости и перегрузок, устойчивость симуляции) и поведение было достаточно похожим для отладки.

Игрокам офлайн‑режим в этой архитектурной версии **не предоставляется**.

---

## 2. Время, частоты и производительность

### 2.1. Основные частоты

Для согласованной работы всех подсистем фиксируются следующие частоты:

- шаг физики на сервере: **30 раз в секунду**;
- сетевые снимки состояния от сервера к клиенту: **примерно 15 раз в секунду** (допустим диапазон 10–20);
- команды управления от клиента к серверу: **30 раз в секунду**;
- отрисовка на клиенте: **60 кадров в секунду**.

Асинхронные уровни обновления на сервере:

- каждый шаг (30 Гц): расчёт движения, применение команд управления, проверка столкновений;
- каждый второй шаг (15 Гц): расчёт нагрева и охлаждения, распределение тяги по двигателям;
- каждый третий шаг (10 Гц): принятие решений искусственным интеллектом и работа автопилота.

### 2.2. Бюджет производительности

Архитектура исходит из того, что при нагрузке «4 игрока + 8 ботов» сервер успевает выполнить все необходимые расчёты в пределах одного шага (примерно 33 миллисекунды).

При увеличении числа кораблей в будущем (масштабные бои) потребуются дополнительные оптимизации и, возможно, другие технологии. В рамках этой версии мы сознательно ограничиваемся небольшими группами кораблей.

---

## 3. Мир с замедленным светом

### 3.1. Идея

В реальном мире свет распространяется очень быстро, поэтому задержка между событием и его наблюдением обычно незаметна. В игре мы искусственно **снижаем скорость света** до значений, при которых задержка становится чувствительной и может использоваться как элемент игрового процесса и маскировка сетевых задержек.

### 3.2. Фиксированная скорость света в локации

В каждой конкретной локации (боевой арене, зоне астероидов и т.п.) задаётся **одно фиксированное значение скорости света c′**.

Примеры:
- тестовые полигоны: c′ ≈ 1 000 м/с — задержка заметна особенно сильно, удобно для отладки;
- основные боевые зоны: c′ около 5 000 м/с (возможен диапазон 3 000–10 000 м/с);
- будущие «быстрые» области дальнего космоса: c′ до сотен тысяч метров в секунду.

В пределах одной локации c′ **не меняется** ни по координатам, ни по времени, ни в зависимости от нагрузки на сервер. При переходе в другую локацию можно использовать другое значение c′.

Преимущества такой модели:
- простая и предсказуемая физика;
- отсутствие сложных эффектов синхронизации при изменении c′;
- снижение нагрузки на сервер (нет необходимости каждый раз пересчитывать поле c′).

### 3.3. Задержка наблюдения

Для любого объекта в мире можно посчитать **время пролёта света** до наблюдателя:

- измеряется расстояние между кораблём наблюдателя и целью;
- вычисляется время `t_света = расстояние / c′`;
- наблюдатель видит цель не в её «текущем» состоянии, а такой, какой она была `t_света` назад.

Это позволяет серверу и клиенту использовать очередь состояний, «залаживая» в будущее поправку на задержку света и сетевой обмен.

---

## 4. Конфигурация мира

### 4.1. Описание локаций

Каждая локация описывается конфигурацией, где задаются:

- размер области (например, квадрат 100×100 км);
- значение скорости света c′;
- наличие и параметры крупных объектов (астероиды, станции и т.п.);
- фоновые параметры (гравитация, если используется).

Эти параметры хранит сервер, клиент получает их в виде настроек и визуализирует соответствующую сцену.

### 4.2. Связь с документом ТТХ

Конфигурация мира не содержит детальной информации о кораблях. Масса, ускорения, сигнатуры, щиты и прочие параметры судёнышек описаны отдельно в документе **«U2 — ТТХ кораблей v0.8»**.

---

## 5. Корабли и физическая модель

### 5.1. Основные физические параметры корабля

У каждого корабля есть набор физических характеристик (подробно — в ТТХ):

- масса пустого корабля и с топливом;
- максимальная тяга главных двигателей и маневровых двигателей;
- максимальные ускорения по основным направлениям (вперёд, назад, в стороны);
- максимальные угловые скорости (скорость поворотов вокруг осей);
- допустимые перегрузки для экипажа;
- размеры корпуса (длина, ширина), по которым рассчитывается эффективный радиус для столкновений.

Эти параметры используются сервером для расчёта движения и реакции на управление.

### 5.2. Перегрузки и безопасность пилота

Пилотируемые корабли ограничены по перегрузкам.

- Лёгкие спортивные корабли и истребители допускают более высокие перегрузки.
- Пассажирские и тяжёлые грузовые корабли — менее устойчивы к резким манёврам.

Ассистент пилота следит за тем, чтобы заданные командой ускорения не приводили к превышению допустимых перегрузок. В крайних случаях пилот может отключить такую защиту (например, в критической боевой ситуации), но базовое поведение ориентировано на безопасность.

Конкретные значения перегрузок и порядок их применения описаны в ТТХ.

### 5.3. Архетипы кораблей

Для упрощения планирования и балансировки используются несколько типовых архетипов:

- лёгкий истребитель;
- лёгкий грузовой корабль;
- средний боевой корабль сопровождения;
- более тяжёлые классы для будущих версий.

Каждый архетип имеет характерный диапазон массы, ускорения, сигнатуры и прочности. Это позволяет настроить разные «ощущения» от управления кораблями разных классов.

### 5.4. Параметры кораблей: краткая сводка

Подробные таблицы параметров кораблей приведены в документе **«U2 — ТТХ кораблей v0.8»**.

В архитектуре важно зафиксировать основные соотношения:

- масса кораблей изменяется от лёгких аппаратов до тяжёлых судов;
- ускорения — от плавных (несколько метров в секунду в квадрате) до очень резких (десятки м/с²);
- угловые скорости — от медленных поворотов до быстрых разворотов;
- сигнатура — от малозаметных «тихих» кораблей до крупных и ярко светящихся целей.

Для оценки тяги используется простая формула:
- сила тяги `F` равна произведению массы корабля на заданное ускорение (`F = m × a`);
- для удобства можно хранить тягу в меганьютонах, деля результат на тысячу.

### 5.5. Столкновения

Для упрощения проверок столкновений используется приближённая модель:

- из геометрии корпуса (длины и ширины) вычисляется эффективный радиус корабля;
- два корабля считаются столкнувшимися, если расстояние между их центрами меньше суммы этих радиусов.

При столкновении:

- скорости скорректируются так, чтобы корабли «отскочили» друг от друга с частичным сохранением импульса;
- наносится урон, зависящий от массы и относительной скорости: чем тяжелее корабли и чем выше скорость столкновения, тем сильнее повреждения.

Точные коэффициенты и пороги описываются в ТТХ и документе по бою.

### 5.6. Системы защиты

Защита корабля строится в несколько слоёв:

1. **Защитное поле (щит)** — первая линия обороны. Щит может состоять из нескольких «граней» по направлениям; он частично или полностью восстанавливается со временем.
2. **Броня** — материалы корпуса и дополнительные защитные слои, которые уменьшают часть входящего урона.
3. **Корпус** — собственно прочность конструкции. Когда запас прочности корпуса падает до нуля, корабль превращается в обломки.

Численные формулы для подсчёта прочности, щитов и брони, а также их взаимодействия с разными типами вооружения, описаны в ТТХ.

---

## 6. Управление кораблём и ассистент пилота

### 6.1. Источники команд и приоритеты

Команда на движение корабля может поступать из разных источников:

- от игрока, который управляет кораблём напрямую;
- от удалённого оператора (например, при дистанционном управлении беспилотником);
- от автоматической системы (автопилота), которая ведёт корабль по маршруту или выполняет стандартные манёвры;
- от сценарных скриптов (например, для ботов или обучающих сцен).

Приоритеты:

1. прямое управление игрока;
2. управление удалённого оператора;
3. автопилот;
4. сценарные скрипты.

Переключение между источниками происходит плавно. Если игрок длительное время не трогает органы управления, система может передать управление автопилоту. При любом новом вводе от игрока контроль возвращается ему.

### 6.2. Роль ассистента пилота

Ассистент пилота — это отдельный слой обработки команд, который работает **после** выбора источника управления.

В минимальной версии реализуется один режим ассистента:

- **стабилизирующий режим**:
  - гасит неконтролируемое вращение корабля;
  - сглаживает резкие изменения ускорения (ограничивает «рывок»);
  - следит за перегрузками и может уменьшать команду, если та ведёт к превышению допустимых значений;
  - в опасных ситуациях может временно усилить своё влияние и почти полностью взять управление на себя.

Ассистент не заменяет игрока, а помогает ему не потерять контроль над кораблём и не «сломать» пилотов и конструкцию чрезмерными манёврами.

Режимы «свободного» управления, полного разнесения осей и сложного «управляемого заноса» планируются как дальнейшее развитие и в рамках этой архитектурной версии не реализуются.

---

## 7. Сетевая модель и наблюдение

### 7.1. Авторитетный сервер

Сервер хранит полное состояние мира:

- положение и скорости всех кораблей;
- состояние двигателей, систем защиты и вооружения;
- статические объекты локации.

Сервер шаг за шагом обновляет состояние в соответствии с законами физики и поступившими командами управления.

### 7.2. Снимки состояния и задержка

Периодически (примерно 15 раз в секунду) сервер отправляет на клиент **снимки состояния**:

- в снимке содержится информация о положении и других параметрах ближайших и важных для игрока объектов;
- у каждого снимка есть отметка времени на сервере.

Для каждой пары «наблюдатель — цель» сервер может рассчитывать время пролёта света `t_света`, используя фиксированную скорость света c′. На основе этого времени формируется момент, когда клиент должен показать игроку соответствующее состояние цели.

Клиент хранит эти состояния в очереди и показывает их игроку с учётом задержки света и сетевых задержек. В результате перемещение чужих кораблей выглядит плавным и правдоподобным, несмотря на неизбежные сетевые задержки.

---

## 8. Бой и урон

### 8.1. Захват цели

Стрельба в минимальной версии ведётся **только по захваченной цели**.

- Игрок выбирает цель (например, щёлчком по кораблю в зоне видимости или через список целей).
- На экране отображаются основные параметры по цели: тип, расстояние, величина задержки света, относительная скорость.
- Органы управления оружием работают только при наличии выбранной цели.

Вероятность попадания и наносимый урон зависят от характеристик атакующего корабля, оружия и цели. В первую очередь — от калибра оружия и сигнатуры цели (её «заметности»).

### 8.2. Вероятность попадания

На сервере рассчитывается вероятность попадания по упрощённой формуле, учитывающей:

- базовую точность конкретного вида оружия;
- соответствие калибра оружия и сигнатуры цели (насколько цель «подходит» этому виду оружия);
- расстояние до цели (чем дальше, тем сложнее попасть);
- относительную скорость (сложнее попасть по быстро движущейся цели);
- релятивистский коэффициент γ для целей, летящих на долях скорости света.

Точные формулы и численные коэффициенты описаны в связке с документом ТТХ и планом по бою.

### 8.3. Расчёт урона

Если выстрел признан успешным, сервер рассчитывает урон и распределяет его между щитом, бронёй и корпусом корабля.

Общий принцип:

- часть урона полностью поглощается щитом (особенно у энерго‑оружия);
- часть проходит сквозь щит и попадает сразу в корпус (особенно у снарядов и ракет);
- броня уменьшает тот урон, который до неё «доходит»;
- корпус имеет конечный запас прочности. Когда он исчерпан, корабль превращается в обломки и больше не управляется.

Конкретные формулы и коэффициенты, а также их привязка к видам вооружения и корабля, определяются в документе ТТХ.

---

## 9. Отображение: HUD и камера

### 9.1. Панель приборов (HUD)

Минимальный набор индикаторов на экране пилота:

1. **Скорость** — текущая скорость корабля и её доля от скорости света c′ в данной локации.
2. **Ускорение** — величина ускорения в долях g, чтобы игрок мог оценить перегрузки.
3. **Ориентация** — курс и крен корабля.
4. **Температура** — текущая температура основных систем и её отношение к критическому уровню.
5. **Состояние ассистента** — нормальный режим или режим повышенного вмешательства (перехват управления).
6. **Выбранная цель** — тип, расстояние, задержка света, относительная скорость.
7. **Состояние корабля** — прочность корпуса, состояние щитов по направлениям, состояние брони.
8. **Вооружение** — готовность к стрельбе, режим ведения огня, перезарядка, количество боеприпасов (для снарядного оружия).

Для отладки могут отображаться дополнительные показатели: задержка до сервера, нестабильность этой задержки, размер очереди будущих состояний и другие служебные данные. По умолчанию такой режим скрыт.

### 9.2. Индикация с учётом задержки

Для выбранной цели дополнительно отображается:

- текущая дистанция;
- оценка времени пролёта света `t_света = расстояние / c′`;
- круг упреждения — точка, куда нужно направить оружие с учётом движения цели и времени подлёта снаряда;
- оценочная вероятность попадания.

Игрок всегда видит цель с задержкой, но интерфейс помогает компенсировать этот эффект.

### 9.3. Камера

В минимальной версии используется вид сверху с привязкой к кораблю игрока:

- корабль игрока ориентирован вверх экрана;
- мир поворачивается вокруг корабля при изменении курса;
- есть несколько уровней приближения (масштаба), между которыми игрок может переключаться.

Технически камера реализуется через сочетание сдвига и поворота сцены относительно координат корабля.

---

## 10. Искусственный интеллект ботов

### 10.1. Общие принципы

Боты управляются не напрямую «магическими» силами, а через те же системы, что и корабль игрока:

- у бота есть свои команды управления (аналог органов управления игрока);
- команды проходят через ассистента пилота и затем в движки;
- применяются те же ограничения по перегрузкам, скорости и защите.

Решения бота принимаются реже (примерно 10 раз в секунду), а ассистент и физика отрабатывают их на каждом шаге.

### 10.2. Структура поведения

Для описания логики ботов используется простая древовидная структура поведения.

Основные уровни:

1. **Стратегия** — общий режим: патруль, атака, отход.
2. **Тактика** — выбор цели, подходящая дистанция, тип манёвра.
3. **Исполнение** — формирование команд управления для достижения выбранной цели.

Ограничения для минимальной версии:

- боты не выполняют сложных групповых манёвров;
- не согласуют действия между собой;
- не учитывают сложные препятствия.

Этого достаточно для простых боёв «игрок против одного или нескольких ботов».

---

## 11. Аудио (минимальный набор)

Аудио‑подсистема для M0–M8 содержит только необходимый минимум:

- звук работы двигателей, меняющийся в зависимости от тяги и режима;
- звук выстрелов и попаданий по щитам и корпусу;
- звуковые предупреждения: перегрев, серьёзные повреждения, срабатывание аварийных режимов ассистента.

Музыка, голосовая озвучка и сложные фоновые звуки относятся к более поздним этапам и в эту архитектурную версию не входят.

---

## 12. Воспроизводимость и детерминизм

### 12.1. Что требуется

Для отладки важна **воспроизводимость** тестовых сценариев:

- при одинаковых начальных условиях система должна вести себя ожидаемо;
- должны выполняться инварианты: скорость не превышает допустимую долю от c′, коэффициент γ не опускается ниже единицы, симуляция не «взрывается» за длительное время.

Строгий **побитовый** детерминизм (полное совпадение всех чисел на разных машинах) **не требуется**. Сервер всегда остаётся источником истины, а клиент подстраивается под него.

### 12.2. Проверяемые свойства

При тестировании обращаем внимание на:

- соблюдение основных ограничений (скорости, перегрузки, температура, прочность);
- отсутствие численных «срывов» (взлетающих до бесконечности скоростей и координат);
- разумную устойчивость результатов: небольшие изменения условий не должны приводить к полностью разным картинам.

Для сетевой игры важнее комфорт и предсказуемость, чем абсолютное совпадение всех промежуточных значений на клиенте и сервере.

---

## 13. Значения по умолчанию

Для удобства проектирования и тестирования фиксируются типичные значения по умолчанию:

- скорость света в боевой зоне: около 5 000 м/с;
- шаг физики на сервере: 30 раз в секунду;
- частота сетевых снимков: около 15 раз в секунду;
- частота отрисовки на клиенте: 60 кадров в секунду;
- базовый лёгкий истребитель и средний боевой корабль сопровождения берутся из документа ТТХ как типичные representatives.

Точные значения для конкретных локаций и кораблей задаются в конфигурации мира и в документе ТТХ.

---

## 14. Глоссарий

**Авторитетный сервер** — сервер, который хранит истинное состояние мира и окончательно решает, что происходит в игре.

**Ассистент пилота** — программный модуль, который помогает пилоту управлять кораблём, сглаживает команды и не даёт выйти за опасные параметры.

**Автопилот** — программа, которая может временно управлять кораблём вместо пилота по заранее заданным целям (маршрут, типовой манёвр).

**Время пролёта света** — время, за которое свет преодолевает расстояние от объекта до наблюдателя. В игре вычисляется как расстояние, делённое на c′.

**Инвариант** — условие, которое система не имеет права нарушать (например, ограничение скорости).

**Компонентная система** — способ описания игровых объектов как набора небольших частей (компонент), каждая из которых отвечает за один аспект поведения.

**Коэффициент γ (гамма)** — числовой множитель, который учитывает релятивистские эффекты при скоростях, близких к скорости света.

**Очередь будущих состояний** — последовательность состояний объектов, которые клиент показывает с задержкой, чтобы компенсировать сетевую задержку и время пролёта света.

**Панель приборов (HUD)** — часть экрана, где пилот видит основные параметры корабля и цели.

**Сигнатура** — численная мера «заметности» корабля для систем наблюдения и наведения.

**Снимок состояния** — набор данных о мире в определённый момент времени, который сервер отправляет клиенту.

**Тяга** — сила, с которой двигатели корабля разгоняют его.

**Щит** — энергетическое или иное защитное поле, которое первым принимает на себя урон.

**Броня** — защитный слой, который уменьшает урон, дошедший до корпуса.

**Корпус** — конструкция корабля, имеющая конечный запас прочности.

**Reconciliation** — механизм исправления клиентского прогноза по данным сервера, чтобы траектория на экране игрока была согласована с расчётами сервера.

**RTT** — время, за которое сетевой запрос проходит от клиента до сервера и обратно.

**Нестабильность задержки (jitter)** — изменчивость RTT во времени, показатель «дрожания» сети.

**Lock‑target (захват цели)** — выбор конкретного объекта для прицеливания и стрельбы.

**Обломки** — состояние корабля после разрушения корпуса, когда он больше не управляется, но остаётся физическим объектом в мире.</content>
<parameter name="filePath">d:\GitHub\u2\docs\specs\u2-architecture-v086.md