# U2 — Архитектура

Версия: 0.8.6 (Merged from ChatGPT and Claude Sonnet)

Дата: 2025‑11‑16

Документ описывает архитектуру прототипа космического симулятора **Universe Unlimited**: как устроен игровой мир с замедленной скоростью света, как взаимодействуют клиент и сервер, как рассчитывается физика, управление и помощник пилота, как работают бой, интерфейс и наблюдаемость системы.

Текст рассчитан на архитекторов и разработчиков клиент‑серверных приложений, но написан более простым и понятным языком, чтобы его можно было прочитать без глубоких знаний в игровой разработке и физике. Специализированные термины вынесены в глоссарий (см. раздел «Глоссарий»).

Архитектура согласована:

- с планом разработки **«U2 — План для ИИ‑агентов 0.8.6 (Merged)»**;
- с документом **«U2 — ТТХ кораблей v0.8»**, где хранятся все численные характеристики кораблей;
- с упрощённой моделью мира: двумерная проекция (вид сверху), авторитетный сервер, замедленный и фиксированный в локации свет.

---

## Система единиц

Все расчёты ведутся в **СИ** (Международная система единиц):

| Величина | Единица | Обозначение |
|----------|---------|-------------|
| Расстояние | метр | м |
| Время | секунда | с |
| Масса | килограмм (тонны) | кг (т) |
| Скорость | метр в секунду | м/с |
| Ускорение | метр на секунду² | м/с² |
| Сила/тяга | ньютон (меганьютон) | Н (МН) |
| Энергия/тепло | джоуль | Дж |
| Мощность | ватт (мегаватт) | Вт (МВт) |

**Перегрузка (g):**
- Используется для удобства восприятия
- 1g = 9.81 м/с²
- Перегрузка = ускорение / 9.81

**Скорость света:**
- Измеряется в м/с
- Типичные значения: 1,000 – 10,000 м/с (зоны боя)
- Высокие значения: до 100,000 м/с (межзвёздные области)
- Реальная скорость света: ~300,000,000 м/с (не используется в игре)

---

## **0\. Назначение и границы документа**

Цели документа:

1. Зафиксировать целевую архитектуру минимальной версии игры (далее **минимальная версия** или **M0**).  
2. Описать ключевые технические решения простым языком: как устроен мир с замедленным светом, как считается движение кораблей, как устроен бой и интерфейс.  
3. Дать общую картину для всех участников команды: гейм‑дизайнеров, программистов, художников и тестировщиков.

Документ **не** описывает:

* Детали реализации пользовательского интерфейса (конкретный визуальный стиль, иконки, анимации).  
* Полный перечень видов оружия, кораблей и экономических механик.  
* Конкретный выбор библиотек и фреймворков для сети, визуализации и хранения данных.

Эти детали оформляются в отдельных документах по дизайну, техническим заданиям и спецификациям.

---

## **1\. Итоговое видение минимальной версии**

Минимальная версия нужна, чтобы как можно раньше проверить «скелет» игры: физику полёта, управление, сеть и помощников пилота.

### **1.1. Масштаб мира и нагрузка**

* Одна звёздная система, представляемая в двумерной плоскости (вид сверху). В будущем предполагается расширение до трёхмерной модели.  
* Один сервер мира обслуживает небольшой «остров» вселенной (шард).  
* Целевая нагрузка для минимальной версии:
  * **4 игрока** (хозяин + до 3 приглашённых друзей)
  * **8 ботов** (4 в зоне активного боя + 4 в резерве)
  * **Итого: 12 кораблей**, из них 8 в близком контакте одновременно

**Модель сессий:**
* **PvE кооператив:** персональная вселенная игрока с приглашением до 3 друзей
* **PvP арена:** 4v4 (отдельный режим, вне минимальной версии)
* **Корпоративные войны:** 25v25 (будущее расширение, требует шардирования)

**Обоснование модели:**  
90% игроков в космосимах занимаются PvE и избегают PvP. Модель "персональная вселенная + кооп" (как в Genshin Impact, SnowRunner) позволяет сфокусироваться на качестве геймплея без требований к масштабированию MMO-уровня.

Этого достаточно, чтобы проверить:

* стабильность физики и управления;  
* корректность сетевого обмена и скрытие задержек;  
* работу боевой системы и помощника пилота.

### **1.2. Игровой цикл и офлайн‑режим**

Для разработки и отладки важен **офлайн‑режим**:

* симуляция мира и управление кораблём работают на одной машине;  
* разработчик может воспроизводить сложные полётные ситуации без поднятия сервера и без сети;  
* поведение корабля в офлайн‑режиме должно быть близким к онлайн‑режиму при тех же входных данных.

**Офлайн-режим доступен ТОЛЬКО разработчикам, не игрокам.**

**Важно:** Офлайн-режим не обязан побитово совпадать с онлайн-режимом. Допустимы упрощения (например, отключение reconciliation), если они не влияют на отладку физики и управления. Цель офлайн-режима — быстрая итерация при разработке, а не тренировка игроков.

### 1.3. Клиент, сервер и авторитетность

Онлайн‑режим использует ту же физику и логику, но вводит:

* Мир рассчитывается на сервере. Сервер хранит «истинное» состояние всех кораблей и объектов.
* Клиент отображает мир, принимает ввод игрока, делает краткосрочные прогнозы движения и подтверждает свои решения данными сервера.
* Любые важные решения по физике, урону и проверке правил принимаются на сервере. Это защищает игру от ошибок и читерства.

---

## **2\. Частоты работы системы, задержки и буферы**

Разные части системы работают с разной частотой. Это позволяет экономить ресурсы и при этом обеспечивать плавный полёт и приемлемые задержки.

### **2.1. Основные частоты**

Условные целевые значения частот для минимальной версии:

**Шаг физики на сервере:** 30 Hz (фиксировано для минимальной версии)

**Асинхронные уровни обновления:**
* **Каждый тик (30 Hz):** физика движения, управление, коллизии
* **Каждый 2-й тик (15 Hz):** тепловая модель, thrust allocation
* **Каждый 3-й тик (10 Hz):** AI/автопилот, обновление окружения

**Обновление состояния по сети:**
* **Базовая частота:** 15 Hz (сетевые снимки от сервера к клиентам)
* **Адаптивное снижение:** до 10 Hz при RTT > 200 мс
* **Адаптивное повышение:** до 20 Hz при критических событиях (бой, докинг)
* Клиент всегда интерполирует между пришедшими снапшотами

**Команды управления от клиента:** 30 Hz

**Кадры изображения на клиенте:** 60 FPS

**Клиентский предсказатель:** 60 Hz для сглаживания движения между серверными состояниями

**Принцип:** Сервер считает физику часто (30 Hz), сеть отправляет состояния реже (15 Hz), клиент дорисовывает движение между состояниями (60 FPS).

### **2.2. Задержки и очереди состояний**

Задержка между сервером и клиентом состоит из:

* времени передачи данных по сети;  
* времени обработки пакета на сервере и клиенте;  
* времени до ближайшего шага браузера или игрового цикла.

Чтобы при этом движение кораблей казалось плавным, клиент использует **очередь будущих состояний**:

* состояния чужих кораблей отображаются с небольшой задержкой (например, 50–150 миллисекунд),  
* за это время клиент успевает заранее получить несколько состояний и плавно интерполировать движение.

Свой корабль клиент при необходимости **предсказывает** (см. глоссарий: «предсказание»). При расхождении с серверным состоянием применяется мягкая подтяжка, а не резкий скачок.

Архитектура исходит из того, что при нагрузке «4 игрока + 8 ботов» сервер успевает выполнить все необходимые расчёты в пределах одного шага (примерно 33 миллисекунды).

---

## **3\. Мир с замедленным светом**

В игре используется модель, где **скорость света значительно ниже привычной**.

### **3.1. Базовая скорость света**

В реальном мире свет распространяется очень быстро, поэтому задержка между событием и его наблюдением обычно незаметна. В игре мы искусственно **снижаем скорость света** до значений, при которых задержка становится чувствительной и может использоваться как элемент игрового процесса и маскировка сетевых задержек.

* Для удобства расчётов базовая скорость света в игре принимается порядка **10 000 метров в секунду** (10 километров в секунду).  
* Это значение достаточно велико, чтобы корабли могли разгоняться до значительных скоростей и чувствовать эффекты относительности, но достаточно мало, чтобы задержки сигналов и видимые эффекты от них были заметны игроку.

### **3.2. Фиксированная скорость света в локации**

В минимальной версии скорость света **фиксирована для каждой локации**:

* **Тестовые локации:** c′ = 1,000 м/с (для отладки)
* **Зоны боя / околопланетное пространство:** c′ = 3,000–10,000 м/с
* **Открытый космос:** c′ = 30,000–100,000 м/с (для будущих версий)

В пределах одной локации c′ **не меняется** ни по координатам, ни по времени, ни в зависимости от нагрузки на сервер. При переходе в другую локацию можно использовать другое значение c′.

**Преимущества фиксированного c′:**

* Упрощённая физика (γ зависит только от скорости корабля)
* Нет проблем синхронизации при переходах между зонами
* Предсказуемое поведение для игрока

**Смена c′ происходит только:**
* При переходе в другую локацию (с перезагрузкой сессии)
* Через изменение серверных настроек (требует рестарт шарда)

**Формула для γ** соответствует классической формуле специальной теории относительности:

γ = 1 / √(1 − v² / c′²)

Важное **инвариантное условие** (см. глоссарий: «инвариант»): **скорость корабля не может превышать 0,999 от местной скорости света**.

### 3.3. Задержка наблюдения

Для любого объекта в мире можно посчитать **время пролёта света** до наблюдателя:

- измеряется расстояние между кораблём наблюдателя и целью;
- вычисляется время `t_света = расстояние / c′`;
- наблюдатель видит цель не в её «текущем» состоянии, а такой, какой она была `t_света` назад.

Это позволяет серверу и клиенту использовать очередь состояний, «залаживая» в будущее поправку на задержку света и сетевой обмен.

### 3.4. Описание локаций

Каждая локация описывается конфигурацией, где задаются:

- размер области (например, квадрат 100×100 км);
- значение скорости света c′;
- наличие и параметры крупных объектов (астероиды, станции и т.п.);
- фоновые параметры (гравитация, если используется).

Эти параметры хранит сервер, клиент получает их в виде настроек и визуализирует соответствующую сцену.

---

## **4\. Сетевая модель: кто прав, что видно и когда**

Основной принцип: **сервер хранит «истину», клиент показывает удобное для игрока приближение**.

### **4.1. Роли сервера и клиента**

* **Сервер мира**:  
  * хранит точное состояние всех объектов (положение, скорость, тепло, состояние систем);  
  * принимает команды манёвра от игроков;  
  * рассчитывает их последствия по физической модели;  
  * проверяет команды на корректность и соблюдение ограничений игры.  
* **Клиент игрока**:  
  * собирает ввод (управление кораблём, выбор целей, действия интерфейса);  
  * отправляет команды на сервер;  
  * получает от сервера состояния объектов;  
  * дорисовывает движение между полученными состояниями.

### **4.2. Маскировка сетевых задержек**

Чтобы сетевые задержки были менее заметны, применяются следующие приёмы:

1. **Интерполяция**. Для чужих кораблей клиент отображает движение с небольшой задержкой, якобы обусловленной низкой скоростью света, плавно перемещая корабль между известными состояниями.  
2. **Предсказание своего корабля**. Собственный корабль при необходимости рассчитывается на клиенте вперёд на один‑два шага. Когда приходит серверное состояние, клиент мягко подстраивает движение.  
3. **Сглаживание ошибок**. Резкие отличия между прогнозируемым и серверным состоянием выравниваются за несколько кадров, чтобы игрок не видел резких скачков.

При этом сервер остаётся единственным источником истины: при существенном расхождении клиент обязан доверять серверу.

#### **4.2.1. Роль задержки света в маскировке сети**

Задержка распространения света **не привязана** к сетевым задержкам, но используется как **физический буфер**.

**Принцип работы:**
1. При дистанции 5 км и c′ = 10,000 м/с → задержка света = 500 мс
2. Типичный RTT игрока: 50-150 мс
3. Сервер отправляет снапшоты заранее с меткой времени показа
4. Клиент накапливает буфер на 3-5 будущих состояний (~100-200 мс вперёд)

**Что происходит при разных сетевых условиях:**

| RTT | Буфер | Результат |
|-----|-------|-----------|
| 50 мс | 150 мс | ✅ Плавное отображение, задержка света полностью маскирует сеть |
| 100 мс | 100 мс | ✅ Плавное, буфер держится |
| 200 мс | 50 мс | ⚠️ Буфер истощается, включается экстраполяция |
| 500 мс+ | 0 мс | ❌ Видимые лаги, стандартная интерполяция как в других играх |

**Вывод:** Задержка света маскирует ~80% сетевых задержек у ~80% игроков, но при плохом соединении система откатывается к классическим методам сглаживания лагов.

---

## **5\. Корабли и физическая модель**

Физическая модель должна быть достаточно простой для вычислений и достаточно выразительной, чтобы игрок чувствовал разницу между кораблями.

Масса, ускорения, сигнатуры, щиты и прочие параметры судёнышек описаны отдельно в документе **«U2 — ТТХ кораблей v0.8»**.

### 5.0. Основные физические параметры корабля

У каждого корабля есть набор физических характеристик (подробно — в ТТХ):

- масса пустого корабля;
- максимальные ускорения по основным направлениям (вперёд, назад, в стороны);
- максимальные угловые скорости (скорость поворотов вокруг осей);
- допустимые перегрузки для экипажа;
- размеры корпуса (длина, ширина), по которым рассчитывается эффективный радиус для столкновений.

Эти параметры используются сервером для расчёта движения и реакции на управление.

### **5.1. Движение корабля**

В основе движения — классический закон изменения импульса:

* изменение импульса равно приложенной силе;  
* скорость корабля получается из импульса и массы с учётом фактора γ.

Ускорение делится на две составляющие:

* вдоль направления скорости (продольное);  
* поперёк направления скорости (поперечное).

Это позволяет задать разные пределы для разгона «вперёд» и для боковых манёвров и крена. Истребитель может иметь высокие поперечные ускорения, а грузовой корабль — более тяжёлый и медленный в поворотах.

### **5.2. Ограничения по перегрузке и скоростям**

Каждый корабль имеет:

* максимально допустимую продольную перегрузку;  
* максимально допустимую поперечную перегрузку.

Если расчетное ускорение превышает эти значения, система либо уменьшает тягу двигателей, либо растягивает манёвр по времени, чтобы не выходить за пределы.

Для пилотируемых кораблей пределы перегрузки зависят от архетипа и задаются в их тактико-технических характеристиках: самые высокие значения — у спортивных кораблей, далее идут боевые истребители, самые низкие — у пассажирских и грузовых судов. В критической ситуации пилот может получить возможность временно отключить ограничение по перегрузке, осознанно рискуя кораблём и экипажем.

Каждый корабль в режиме Flight Assist = On имеет:

* максимально допустимую для экипажа перегрузку;
* максимально допустимую скорость вперед;  
* максимально допустимую скорость назад;  
* максимально допустимую вертикальную (вверх-вниз) скорость.
* максимально допустимую боковую (поперечную) скорость.

### **5.3. Тепло и охлаждение**

В текущем плане тепловыделение не учитывается.

### **5.4. Параметры кораблей**

Подробные ТТХ (тактико-технические характеристики) см. в документе **"U2 — ТТХ кораблей v0.8"**.

**Краткая сводка диапазонов:**

* **Масса:** 8 т (snub shuttle) – 50,000 т (capital dreadnought)
* **Ускорение:** 4 м/с² (capital) – 90 м/с² (small sport)
* **Угловая скорость:** 10-150 °/с

**Типичные корабли для M0-M8:**
* **small fighter** (55 т, 80 м/с²) — базовый истребитель
* **small freighter** (80 т, 35 м/с²) — грузовой
* **medium gunship** (180 т, 40 м/с²) — боевой с экипажем

**Формулы расчёта:**
```
F = m × a
main_thrust_MN = (mass_t × accel_mps2) / 1000
rcs_budget_MN = main_thrust_MN × 0.30  (для small/medium)
```

### **5.5. Физические размеры и коллизии**

Каждый корабль имеет:
* **Геометрию корпуса:** length, width, height (из конфига)
* **Радиус коллизии:** рассчитывается автоматически

**Формула радиуса коллизии (для упрощения в 2D):**
```
hull_radius_m = Math.hypot(length_m, width_m) / 2
```

**Примеры радиусов:**

| Корабль | Length × Width (м) | Радиус коллизии (м) |
|---------|-------------------|---------------------|
| snub shuttle | 9 × 7 | 5.7 |
| small sport | 16 × 10 | 9.4 |
| small fighter | 18 × 13 | 11.1 |
| small freighter | 30 × 26 | 19.9 |
| medium gunship | 45 × 30 | 27.0 |
| heavy fighter | 38 × 25 | 22.8 |
| capital corvette | 155 × 82 | 87.6 |

**Обработка коллизий:**

Проверка: `distance_between_centers < (radius_A + radius_B)`

При коллизии:
1. Упругий отскок с коэффициентом restitution = 0.3
2. Урон пропорционален:
   ```
   damage = k × (relative_velocity)² × min(mass_A, mass_B)
   где k ≈ 0.001 (калибровочный коэффициент)
   ```

**Важно:** В минимальной версии коллизии корабль-корабль вызывают отскок + урон, но не мгновенное разрушение.

### **5.6. Системы защиты**

Каждый корабль имеет три уровня защиты:

**1. Щиты (Shields):**
* Не используется в текущей Архитектуре и Плане

**2. Броня (Armor):**
* Не используется в текущей Архитектуре и Плане

**3. Корпус (Hull HP):**
* Основные очки прочности, заданы в ТТХ
* Восстановление только при докинге/ремонте

**Механика урона:**
1. Урон сразу применяется к Hull HP 
1. Hull HP уменьшается

При Hull HP ≤ 0: корабль уничтожен → wreck (обломки)

**Сенсоры:**

* Радиус обнаружения: 5-50 км (сигнатура указана в ТТХ корпуса корабля)
* Радиус захвата цели: 80% от радиуса обнаружения
* Прямая видимость не требуется в минимальной версии (упрощение)

**Когда корабль уничтожен:**
* HP ≤ 0 → корабль становится "wreck" (обломок)
* Игрок видит экран "DESTROYED"
* Респавн через 30 секунд на ближайшей станции (или конец миссии в PvE)

---

## **6\. Управление: источники команд и арбитраж**

Кораблём управляют несколько типов источников команд:

1. Игрок (ручное управление из кабины).  
2. Удалённый оператор (для беспилотных кораблей и кораблей, временно захваченных или переданных на дистанционное управление).  
3. Автопилот (например, следование по маршруту или выполнение стандартного манёвра).  
4. Сценарные или отладочные скрипты (для тестов и ботов).

### **6.1. Правила приоритета**

Чтобы не возникало конфликтов, вводится **арбитраж команд**:

* на каждой оси управления (продольное ускорение, боковые манёвры, поворот) может быть **только один активный источник команд**;  
* Приоритеты:

  1. прямое управление игрока;
  2. управление удалённого оператора;
  3. автопилот;
  4. сценарные скрипты.
* при отсутствии прямого управления активным источником могут быть удалённый оператор, автопилот  или сценарий в зависимости от выбранного режима.

Ассистенты пилота при этом **не считаются отдельным источником управления**. Они образуют промежуточный слой между источниками команд и контроллерами двигателей: принимают команды от любого источника, сглаживают их, ограничивают по перегрузкам и теплу и следят за тем, чтобы корабль не уходил в неконтролируемое вращение или чрезмерный занос. Подробные схемы см. в документе «U2 — Управление».

Когда игрок отпускает органы управления, активный источник может переключиться (например, с прямого управления на автопилот или удалённого оператора), а ассистенты пилота обеспечивают плавный переход без резких скачков.

### **6.2. Плавное переключение**

Переключение между источниками должно быть **плавным**:

* запрещены резкие скачки ускорений при смене источника;  
* исходное состояние (скорость, угловая скорость) всегда учитывается новой системой управления;  
* переход может растягиваться на несколько кадров, чтобы игрок не чувствовал «подмены».

### **6.3. Тяга, ускорения и скорости**

Для упрощения расчетов используется упрощенная физическая модель полета и конфигурации корабля:

- У корабля в ТТХ заданы максимальные линейные и угловые ускорения
- У корабля есть масса

Дополнительно для режима Flight Assist On заданы:

- Максимально допустимые для экипажа перегрузки
- Максимально допустимые линейные и угловые скорости

## **7\. Помощники пилота**

Помощник пилота облегчает управление кораблём, особенно в режиме с высокой скоростью и в бою.

### **7.1. Стабилизация и удержание курса**

Основные функции помощника пилота:

* упрощение управления кораблем 
* предназначено для новичков, казуальных игроков и пилотов на мобильных устройствах с виртуальными джойстиками

### **7.2. Режимы ассистента пилота в минимальной версии**

В M0-M5 реализуются два базовых режима:

**1. Flight Assist Off (свободный полет):**

* Оси управления независимы
* Прямая передача команд игрока на двигатели с ограничением по перегрузке
* Максимальные линейные и угловые ускорения задаются ТТХ корабля
* Ограничений на линейные и угловые скорости нет
* Минимальная помощь, максимальный контроль со стороны пилота

**2. Flight Assist On (стабилизированный полет):**

* PD-демпфер угловой скорости (подавление вращения)
* Jerk-limiting для плавности трансляционного движения
* Максимальные линейные и угловые ускорения ограничиваются максимально допустимой перегрузкой для экипажа
* Максимальные линейные и угловые скорости ограничиваются ТТХ корабля 
* Автоматическое выравнивание при отпускании стиков

**3. Режим Coupled (управляемый занос)** выносится за рамки минимальной версии и планируется для M9+ как "advanced flight model".

**Причины отказа от Coupled в M0-M5:**
* Сложность настройки (6-12 недель на один архетип корабля)
* Риск нестабильности при разных c′ и массах
* Не критичен для проверки базовой физики и сети

---

## **8\. Боевая модель и захват цели**

Игроки и боты могут сражаться между собой с помощью бортового вооружения.

### **8.1. Захват цели**

Система захвата цели выполняет:

* выбор объекта (корабль, станция, снаряд) как активной цели;  
* отслеживание цели во времени;  
* передачу данных о цели в прицел, помощник пилота и оружие.

При захвате цели могут отображаться дополнительные подсказки:

* вероятность попадания по текущей траектории;  
* рекомендуемое упреждение;  
* указатель на цель, если она вышла из поля зрения.

Стрельба бортовым оружием в базовой модели ведётся только по захваченной цели. Расчёт вероятности попадания и ожидаемого нанесённого урона зависит от тактико-технических характеристик атакующего корабля и цели, в первую очередь от калибра выбранного оружия и величины сигнатуры цели.

### **8.2. Ограничения на боевые манёвры**

При расчёте боевых манёвров учитываются:

* физические ограничения по перегрузке и теплу;  
* локальная скорость света и фактор γ;  
* сетевые задержки (чтобы исключить использование задержек связи в качестве преимущества).

Сервер проверяет:

* допустимость команд стрельбы по дистанции, углу и скорости сближения;  
* превышение физических ограничений корабля;  
* попытки явно невозможных манёвров.

При нарушении условий команда может быть отвергнута или скорректирована.

### **8.3. Расчёт урона**

При попадании (если `random() < P_hit`):

**1. Базовый урон:**
```
raw_damage = weapon.base_damage 
           × (weapon.size / 2)^0.8
           × sqrt(gamma_shooter)

где:
- base_damage: базовый урон оружия (50-500 HP)
- weapon.size: S1-S5 (размер оружия)
- gamma_shooter: релятивистский бонус атакующего
```

**2. Взаимодействие со щитами:**
```
if (target.shield_HP > 0) {
  if (weapon.type === "energy") {
    shield_damage = raw_damage × 1.0  // 100% в щит
    hull_damage = 0
  } else if (weapon.type === "ballistic") {
    shield_damage = raw_damage × 0.7  // 70% в щит
    hull_damage = raw_damage × 0.3    // 30% проходит
  }
  
  target.shield_HP -= shield_damage
  if (target.shield_HP < 0) {
    hull_damage += abs(target.shield_HP)  // остаток в корпус
    target.shield_HP = 0
  }
}
```

**3. Применение брони:**
```
actual_hull_damage = hull_damage × (1 - target.armor / 100)
```

**4. Финальный урон:**
```
target.hull_HP -= actual_hull_damage
```

**Weapon.type:**
* **energy:** Lasers, plasma (лучи, плазма)
* **ballistic:** Bullets, shells (пули, снаряды)
* **missile:** Управляемые ракеты (отдельная механика)

**Примеры урона:**

| Оружие | Base | Size | @ γ=1 | @ γ=2 |
|--------|------|------|-------|-------|
| Light Laser | 50 | S1 | 50 | 71 |
| Heavy Cannon | 200 | S3 | 303 | 428 |
| Missile | 150 | S2 | 150 | 212 |

**Критические попадания:**
* При `random() < crit_chance` (5-15%) урон удваивается
* Визуальный эффект и звук отличаются

---

## **9\. Интерфейс пилота и сенсоры**

Интерфейс пилота показывает информацию о состоянии корабля и окружающего мира.

### **9.1. Основные элементы интерфейса**

На экране пилота должны быть видны:

* скорость и направление движения;  
* угловая скорость и ориентация корабля;  
* текущая перегрузка (продольная и поперечная);  
* уровни тепла и состояния систем охлаждения;  
* выбранная цель и её основные параметры (дистанция, относительная скорость);  
* сетевые показатели (задержка до сервера, разброс задержки).

### **9.2. Индикация задержки наблюдения**

Бортовой компьютер показывает игроку:

**Для выбранной цели:**
* Дистанция в километрах
* Время задержки света: `t_light = distance / c′`
* Относительная скорость (сближение/удаление)
* Вектор относительной скорости (направление движения цели)

**Упрощённые подсказки прицеливания:**
* Круг упреждения (где цель будет через `t_light + t_projectile`)
* Вероятность попадания (на основе сигнатуры цели и калибра)
* Оптимальная дистанция для выбранного оружия

**Без "голограмм":** Клиент не пытается реконструировать "истинное текущее положение" объектов. Все визуальные подсказки основаны на известных данных с учётом задержки.

### **9.3. Камера и управление обзором**

**Режим камеры в минимальной версии:**
* **Тип:** Top-down с фиксацией на корабле
* **Позиция:** Камера центрирована на корабле игрока
* **Ориентация:** Корабль **ВСЕГДА направлен вверх экрана** (нос к верхней границе)
* **Вращение мира:** Мир (звёзды, другие корабли, объекты) вращается и смещается относительно корабля игрока
* **Zoom:** 3 уровня (близко/средне/далеко), переключение колёсиком мыши

**Аналогия:** Как в классических аркадах-шутерах (Geometry Wars, Asteroids с современной камерой).

**Преимущества:**
* Интуитивное управление: "вперёд" всегда означает "к верху экрана"
* Игрок не теряет ориентацию при поворотах
* Проще прицеливаться (нос корабля = направление стрельбы)

**Технические детали:**
* Камера привязана к `ship.position` и `ship.orientation`
* Матрица вида: `View = Translate(-ship.pos) × Rotate(-ship.yaw)`
* Все объекты мира трансформируются относительно корабля игрока

**Дополнительные режимы (будущие версии):**
* **Free camera:** Камера отвязана от корабля (для осмотра поля боя)
* **Chase camera:** Камера за кораблём, вращается вместе с ним
* **Cinematic camera:** Автоматические ракурсы при важных событиях

---

## **10. Искусственный интеллект ботов**

### **10.1. Архитектура AI**

Боты используют **Behavior Tree** (дерево поведения) с тремя уровнями:

1. **Стратегический:** Выбор общего режима (патруль/атака/отступление)
2. **Тактический:** Выбор цели и манёвра
3. **Исполнительный:** Генерация команд управления (через те же ассистенты, что у игроков)

### **10.2. Режимы поведения**

**Патруль:**
* Следование по маршруту (waypoints)
* Сканирование на наличие угроз/целей
* При обнаружении врага → переход в "Атака"

**Атака:**
* Выбор ближайшего врага как цели
* Манёвр сближения до оптимальной дистанции (3-5 км)
* Открытие огня при `P_hit > 0.4`
* При HP < 30% → переход в "Отступление"

**Отступление:**
* Выбор направления от ближайшего врага
* Ускорение на максимальной тяге
* При дистанции > 15 км → переход в "Патруль"

### **10.3. Ограничения AI в минимальной версии**

* Боты НЕ используют сложные манёвры (barrel roll, split-S)
* Боты НЕ кооперируются между собой
* Боты НЕ учитывают препятствия (астероиды)

Эти ограничения допустимы для M6, усложнение AI планируется в будущих версиях.

---

## **11. Аудио**

### **11.1. Аудио в минимальной версии**

**Минимальная версия включает:**
* Звук двигателей (меняется с уровнем тяги)
* Звук выстрелов (разный для разных типов оружия)
* Звук попадания (когда попадают по твоему кораблю)
* Звук уничтожения корабля
* Предупреждающие сигналы (перегрев, низкий HP)

**НЕ включено в M0-M8:**
* Фоновая музыка (добавится позже)
* Голоса персонажей
* Амбиентные звуки космоса

**Технические требования:**
* Формат: OGG или WAV
* 2D звук (без 3D позиционирования в минимальной версии)
* Регулировка громкости: мастер, эффекты, музыка (отдельные ползунки)

---

## **12\. Схемы данных и сообщения**

В архитектуре выделяются несколько типов данных, которые постоянно передаются между клиентом и сервером и сохраняются.

Основные группы:

1. **Профиль корабля и игрока.** Масса, тяга двигателей, пределы перегрузки, тепловые характеристики и другие статические параметры. Эти параметры меняются редко: при ремонте и модернизации корабля на верфи или при получении серьёзных боевых повреждений. В обычном полёте они не обновляются по сети, что позволяет экономить трафик. Игрок привязан к выбранному при вылете со станции кораблю; при изменении профиля корабля сервер отправляет клиенту обновлённые данные.  
2. **Снимки состояния мира.** Положение, скорость, ориентация и состояние систем всех активных объектов.  
3. **Команды управления.** Запросы манёвров, активация вооружения, смена цели, действия по интерфейсу.  
4. **Телеметрия и отладка.** Данные для анализа: задержки, частоты, расхождения между клиентом и сервером, события ошибок.

Сами форматы (поля, типы, двоичное или текстовое представление) описываются в отдельных технических спецификациях. Важно, чтобы:

* форматы были компактными по размеру;  
* были устойчивы к расширению (возможность добавить поле без поломки старых клиентов);  
* одинаково интерпретировались на сервере и клиенте.

---

## **13\. Проверка и защита от нарушений правил**

Сервер осуществляет базовую защиту от нарушений правил игры (античит).

Основные направления проверок:

* **физические ограничения:** скорость, ускорение, перегрузка, тепло не выходят за допустимые рамки;  
* **честность управления:** команды приходят с разумной частотой и не противоречат предыдущим состояниям;  
* **целостность данных:** сообщения не повреждены и не содержат невозможных комбинаций.

При обнаружении нарушений сервер может:

* отклонить конкретную команду;  
* переслать клиенту исправленное состояние;  
* зафиксировать событие в журнале для анализа и, при повторении, применить санкции к игроку.

---

## **14\. Тестирование и повторяемость**

Для уверенности в корректности работы системы важна **воспроизводимость тестовых сценариев** в офлайн-режиме.

**Требования к детерминизму смягчены:**
* **Строгий детерминизм НЕ требуется**, так как используется авторитарный сервер
* Клиент предсказывает только своё движение; при расхождении с сервером применяется reconciliation
* Для отладки достаточно, чтобы офлайн-симуляция давала **статистически близкие результаты** (допуск ε ≈ 1%)

**Что проверяется в тестах:**
* Инварианты физики: `|v| < 0.999·c′`, `γ ≥ 1`, сохранение энергии (в пределах ε)
* Стабильность: нет "взрывов" скорости/позиции за 10⁶ тиков
* Воспроизводимость сценариев: одинаковый ввод → результат в пределах допуска

**Для чего НЕ нужен детерминизм:**
* Не используется lockstep синхронизация
* Клиент не валидирует других игроков
* Replay-система необязательна в M0-M5

На основе этого строится набор приёмочных тестов:

* стандартные сценарии полёта и боя;  
* серии переключений между режимами управления;  
* воспроизведение записанных сессий.

---

## **15\. Развёртывание и наблюдаемость**

Даже для минимальной версии важна наблюдаемость работы системы.

### **15.1. Развёртывание минимальной версии**

Минимальный набор для развёртывания:

* один сервер мира;  
* один или несколько компонентов, отвечающих за приём подключений и балансировку нагрузки;  
* система хранения журналов и телеметрии.

### **15.2. Наблюдаемость**

Сервер и клиенты должны передавать телеметрию:

* частоты шагов симуляции и отрисовки;  
* задержки и их разброс;  
* расход процессорного времени и памяти;  
* количество активных объектов в мире.

Это позволяет вовремя обнаруживать проблемные места и оценивать, как меняются характеристики системы при росте числа игроков.

---

## **16\. Значения «по умолчанию» для минимальной версии**

Для ускорения разработки вводятся типовые значения, которые можно использовать «из коробки» и изменять по мере необходимости.

**Скорость света (фиксирована для локации):**
* Тестовая локация: c′ = 1,000 м/с
* Околопланетный бой: c′ = 5,000 м/с
* Астероидные поля: c′ = 10,000 м/с
* Открытый космос: c′ = 50,000 м/с (для будущих версий)

**Частоты симуляции:**
* Шаг физики сервера: **30 Hz** (33.3 мс на тик)
* Обновления по сети: 15 Hz (66.7 мс между снапшотами)
* Команды управления от клиента: 30 Hz
* Отрисовка клиента: 60 FPS

**Асинхронные системы:**
* Тепловая модель: **15 Hz** (каждый 2-й тик сервера)
* AI/автопилот: **10 Hz** (каждый 3-й тик)
* Thrust allocation: **15 Hz** (интерполяция между обновлениями)

**Сетевые буферы:**
* Буфер будущих состояний на клиенте: 100-150 мс
* Задержка отображения чужих кораблей: подстраивается под `distance/c′ + RTT/2`

**Типичные корабли для тестов:**
* small sport (30 т, 90 м/с²): быстрый и манёвренный
* small fighter (55 т, 80 м/с²): базовый истребитель
* small freighter (80 т, 35 м/с²): медленный грузовой
* medium gunship (180 т, 40 м/с²): тяжёлый боевой

**Рекомендуемые значения c′ для тестов:**
* c′ = 1,000 м/с: для отладки (макс. скорость ~900 м/с)
* c′ = 5,000 м/с: для боя (макс. скорость ~4,500 м/с)
* c′ = 10,000 м/с: для гонок (макс. скорость ~9,000 м/с)

**При c′ = 5,000 м/с и accel = 80 м/с²:**
* Время до 0.5c′ (2,500 м/с): ~31 секунда
* Время до 0.8c′ (4,000 м/с): ~50 секунд
* γ при 0.8c′: ~1.67

Эти значения задаются в конфигурационных файлах и могут быть изменены без изменения архитектуры.

---

## **17\. Что можно выбирать и менять без изменения архитектуры**

Некоторые решения относятся к уровню архитектуры и зафиксированы в этом документе (например, принцип «сервер хранит истину» или разделение частот). Другие решения можно менять без изменения архитектуры:

* конкретный формат кодирования сообщений (двоичный или текстовый);  
* библиотеку для отправки и приёма сетевых пакетов;  
* способ хранения журналов и телеметрии;  
* конкретные приёмочные тесты и их набор.

Всё это можно дорабатывать в ходе разработки, не ломая договорённости между клиентом, сервером, физикой и интерфейсом.

---

## **Глоссарий**

Ниже приведены термины, которые часто используются в документе.

**Игровой мир**  
Математическая модель космоса, в которой рассчитываются положение и движения кораблей, действие сил и скорость света.

**Шаг симуляции**  
Один цикл вычислений физики и логики на сервере. На каждом шаге пересчитываются положения и состояния объектов.

**Кадр визуализации**  
Один цикл отрисовки изображения на клиенте. Кадры могут идти чаще, чем шаги симуляции, чтобы движение выглядело плавно.

**Сервер мира**  
Программа, которая хранит и обновляет состояние игрового мира, принимает команды от игроков и рассылает им новые состояния.

**Клиент**  
Программа на стороне игрока. Показывает мир, принимает ввод управления и обменивается данными с сервером.

**Скорость света c′**  
Эффективная скорость распространения сигналов в игровом мире. Намеренно занижена по сравнению с реальной и фиксирована для каждой локации в минимальной версии.

**Местная скорость света**  
Текущее значение скорости света c′ в данной локации.

**Фактор γ (гамма)**  
Число, показывающее, насколько сильно проявляются эффекты относительности при данной скорости и скорости света. Чем ближе скорость к скорости света, тем больше γ.

**Инвариант**  
Величина или условие, которое не должно нарушаться при работе системы. В нашем случае — ограничение скорости корабля сверху относительно местной скорости света.

**Перегрузка**  
Отношение ускорения к ускорению свободного падения. Показывает, насколько «давит» манёвр на корабль и экипаж.

**Тепловой режим**  
Состояние корабля с точки зрения нагрева и охлаждения: сколько тепла выделяют двигатели и оружие и как быстро системы охлаждения его отводят.

**Очередь будущих состояний**  
Небольшой буфер на клиенте, в котором хранятся будущие состояния объектов, уже полученные от сервера. Используется для плавного отображения движения с небольшой задержкой.

**Предсказание состояния**  
Расчёт клиентом своего состояния вперёд во времени на основе последних известных данных и команд. Нужен, чтобы уменьшить заметность задержки сети.

**Reconciliation (согласование)**  
Процесс корректировки клиентского предсказания при получении авторитарного состояния от сервера. Клиент плавно подтягивает своё состояние к серверному за несколько кадров, чтобы избежать резких скачков.

**Snapshot (снимок состояния)**  
Полное или частичное состояние игрового мира в определённый момент времени, отправляемое сервером клиентам. Содержит позиции, скорости, ориентации и другие параметры объектов.

**Ассистент пилота**  
Подсистема, которая помогает управлять кораблём: стабилизирует его, удерживает курс, выполняет стандартные манёвры и сглаживает управление.

**RTT (Round-Trip Time)**  
Время прохождения сигнала от клиента до сервера и обратно. Измеряется в миллисекундах. Типичные значения: 50-150 мс для хорошего соединения.

**Jitter (дрожание)**  
Вариация задержки сети. При высоком jitter пакеты приходят нерегулярно, что усложняет интерполяцию.

**Thrust (тяга)**  
Сила, создаваемая двигателями корабля. Измеряется в ньютонах (Н) или килоньютонах (кН).

**Signature (сигнатура)**  
Характеристика корабля, определяющая его "заметность" для систем наведения. Cross Section (CS) — физический размер (1-5).

**Caliber (калибр)**  
Характеристика оружия, размер (S1-S5).

**Захват цели (Lock-target)**  
Процесс выбора объекта в качестве цели для оружия и помощника пилота. После захвата система отслеживает цель и показывает подсказки для наведения.

**Wreck (обломки)**  
Неактивный объект, остающийся после уничтожения корабля.

**Waypoint (путевая точка)**  
Координата в пространстве, используемая для навигации и AI.

**Shield Face (грань щита)**  
Одна из 4-6 секций щита корабля (front/back/left/right/top/bottom).

**Hull HP (очки корпуса)**  
Основные очки прочности корабля.

**Armor (броня)**  
Процентное снижение урона.

**Телеметрия**  
Служебные данные о работе системы: задержки, скорости, частоты, загрузка процессора, число объектов. Используется для анализа и оптимизации.

**Детерминизм**  
Свойство системы, при котором при одинаковых исходных данных результат симуляции всегда один и тот же.

**Развёртывание**  
Процесс установки и настройки серверов и вспомогательных компонентов игры в рабочей среде.

---

## **ПРИЛОЖЕНИЕ: Связанные документы**

Для полной картины архитектуры и разработки см. также:

1. **"U2 — ТТХ кораблей v0.8"** — Подробные тактико-технические характеристики кораблей с примерами
2. **"U2 — План разработки для ИИ-агентов"** — Пошаговый план реализации с этапами M0-M8
3. **"U2 — Управление"** (будущий документ) — Детальное описание систем управления и ассистентов

---

**Конец документа**