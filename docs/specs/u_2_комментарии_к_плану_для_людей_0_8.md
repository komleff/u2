# U2 — План разработки для ИИ-агентов
Версия: 0.8.6 (упрощённая)
Назначение: план для ИИ-агентов под руководством гейм-дизайнера и продюсера

---

## 1. Цели и рамки

1. Построить фундамент онлайн-игры:
   - авторитарный сервер;
   - 2D-физика в плоскости, с замедленным светом;
   - клиент с отображением задержки света;
   - минимальный помощник пилота;
   - минимальный HUD;
   - самая простая модель урона и очень простой ИИ ботов.

2. Осознанно НЕ делать в версии 0.8.6:
   - моделирование тепла и охлаждения;
   - щиты и броню;
   - проработанные характеристики оружия;
   - сложные формулы попаданий;
   - «голограммы будущего», сложную визуализацию боёв;
   - сложные режимы ассистента (Coupled и т.п.);
   - сложный ИИ с продвинутой тактикой.

3. Всё перечисленное выше считается «будущими подсистемами» и закладывается только через точки расширения (интерфейсы, параметры), без реализации.

---

## 2. Сквозные принципы для ИИ-агентов

1. **Малые шаги.** Каждый этап даёт рабочий, запускаемый результат, который можно протестировать в игре.
2. **Простые заглушки вместо сложных систем.**  
   Например:
   - урон — фиксированное число по корпусу;
   - ИИ — выбор случайного или ближайшего врага и простое поведение.
3. **Минимум внешних зависимостей.** Вся критичная логика (физика, сеть, помощник пилота) — в собственном коде проекта.
4. **Чёткие точки «заморозки» интерфейсов.**  
   После этапа:
   - нельзя без крайней необходимости ломать формат сетевых сообщений;
   - нельзя ломать структуру состояния корабля.
5. **Одинаковые модели данных на клиенте и сервере.**  
   Общая библиотека типов для состояния корабля, локации и сообщений.

---

## 3. Этапы разработки

### M0. База проекта и офлайн-полёт одного корабля

**Цель:** рабочий офлайн-прототип с одним кораблём, общей математикой и структурой проекта.

**Содержание:**

1. Структура репозитория:
   - серверный проект;
   - клиентский проект;
   - общая библиотека (типы, математика, протокол сообщений).
2. Общие типы:
   - векторы, углы, состояние корабля (позиция, скорость, ориентация);
   - состояние локации (размер, скорость света c′, границы).
3. Простейшая 2D-физика:
   - без релятивистских эффектов;
   - F = m·a, интегрирование по шагу времени;
   - нет коллизий, нет урона.
4. Клиент:
   - простая топ-даун камера;
   - отрисовка своего корабля;
   - управление с клавиатуры/геймпада:
     - вперёд/назад;
     - боковое смещение;
     - поворот.

**Готово (DoD):**

- Проект собирается одной командой.
- Локально можно управлять кораблём и видеть его движение.
- Есть единая структура данных для состояния корабля и локации.

---

### M1. Релятивистская физика и коллизии на сервере

**Цель:** серверная физика с замедленным светом (только γ-фактор) и простейшими коллизиями.

**Содержание:**

1. Скорость света:
   - скорость света c′ задаётся в настройках локации одной константой;
   - никаких полей c′(x), скорость света не меняется внутри локации.
2. Релятивистская поправка:
   - расчёт β = v / c′;
   - расчёт γ = 1 / √(1 − β²);
   - ограничение скорости: |v| < 0.99·c′.
3. Коллизии:
   - каждый корабль имеет радиус корпуса (по длине и ширине);
   - столкновение, если расстояние между центрами меньше суммы радиусов;
   - при столкновении — упругий отскок с пониженным коэффициентом;
   - урон корпусу: простая функция от относительной скорости и массы.
4. Корпус (прочность):
   - у корабля есть параметр «прочность корпуса» (Hull HP);
   - при нуле или отрицательном значении — состояние «уничтожен» (без щитов, без брони, без специальных эффектов).
5. Клиент:
   - по-прежнему локальная симуляция, но использует те же формулы, что сервер.

**Готово (DoD):**

- Серверная библиотека физики умеет обновлять состояние кораблей с учётом γ.
- Столкновения приводят к отскоку и уменьшению прочности корпуса.
- Нет щитов, брони и тепла — только Hull HP и урон от столкновений.

---

### M2. Сеть и авторитарный сервер (2 игрока, без задержки света)

**Цель:** первый рабочий онлайн-режим: два клиента подключаются к серверу и видят друг друга без моделирования задержки света.

**Содержание:**

1. Сетевой слой:
   - авторитарный сервер (истина — на сервере);
   - клиенты посылают команды управления;
   - сервер периодически рассылает состояние мира.
2. Формат сообщений:
   - команда управления (ввод игрока);
   - периодический снимок состояния (позиция, скорость, ориентация, прочность корпуса);
   - сообщения о подключении/отключении.
3. Клиент:
   - предсказание движения собственного корабля;
   - выравнивание с серверным состоянием (плавная корректировка);
   - отображение других кораблей согласно последнему полученному состоянию.
4. Пока нет:
   - задержки света;
   - помощника пилота;
   - HUD, кроме самых простых отладочных чисел.

**Готово (DoD):**

- Два клиента могут подключиться к серверу и видеть движение друг друга.
- При нормальном времени отклика (RTT) движение плавное, без резких «прыжков».
- При умеренных потерях пакетов симуляция не разваливается.

---

### M3. Управление и помощник пилота (один режим)

**Цель:** ввести слой управления и один простой режим помощника пилота, без сложных режимов.

**Содержание:**

1. Источники управления:
   - локальный игрок;
   - задел под автопилот (может быть пустой заглушкой);
   - возможность добавить удалённого оператора позже.
2. Арбитраж:
   - при наличии ввода от игрока — приоритет за ним;
   - при отсутствии ввода дольше заданного времени — можно передавать управление автопилоту (пока автопилот может ничего не делать, важно само место в архитектуре).
3. Помощник пилота (один режим «Стабилизированный»):
   - гасит неконтролируемое вращение;
   - ограничивает рывки ускорения, сглаживает резкие изменения;
   - работает поверх любых команд управления.
4. Эскалация влияния помощника:
   - при слишком высокой угловой скорости или близком столкновении усиливает своё влияние;
   - после стабилизации постепенно возвращает больший контроль игроку.
5. Реализация одинакова на клиенте и на сервере, чтобы упрощать отладку.

**Готово (DoD):**

- При отпускании органов управления корабль сам выравнивается и перестаёт вращаться.
- В аварийной ситуации (например, при слишком быстрых вращениях) помощник временно берёт на себя большую часть управления.
- Поведение помощника воспроизводимо в офлайн-режиме.

---

### M4. Наблюдение с учётом задержки света

**Цель:** перейти от «мгновенного» наблюдения к наблюдению с задержкой света, без сложных визуальных эффектов.

**Содержание:**

1. На сервере:
   - для каждой пары «наблюдатель — цель» вычислять задержку света:
     - t_light = расстояние / c′;
   - время показа состояния цели для наблюдателя:
     - t_показа = t_серверного_типа + t_light;
   - для каждого наблюдателя формировать очередь будущих состояний целей, привязанных ко времени показа.
2. На клиенте:
   - хранить небольшой буфер будущих состояний для других кораблей (обычно 100–200 мс);
   - показывать корабль не по самой свежей точке, а по той, чьё время «наступило»;
   - при нехватке данных — аккуратная экстраполяция, без сложных предсказаний.
3. Визуализация:
   - для начала можно отображать только положение других кораблей с учётом задержки света, без специальных обозначений;
   - сложные эффекты, «голограммы», дорисовка будущего положения — не реализуются.

**Готово (DoD):**

- При увеличении расстояния до другого корабля видно, что события от него доходят до игрока с большей задержкой.
- Клиент держит небольшой запас будущих состояний и использует его для плавного отображения.
- Нет визуальных провалов даже при неровном соединении.

---

### M5. HUD и отладочные индикаторы

**Цель:** дать игроку и разработчикам минимально необходимые показатели для полёта и отладки.

**Содержание:**

1. Основные элементы HUD:
   - скорость корабля и отношение к скорости света c′ (в процентах);
   - направление движения и ориентация корабля;
   - прочность корпуса (Hull HP) — одна шкала;
   - состояние помощника пилота (обычный режим / повышенное вмешательство);
   - для выбранной цели:
     - дистанция;
     - задержка света t_light.
2. Отладочный режим:
   - переключатель (например, клавиша), который:
     - показывает примерное время отклика (туда-обратно);
     - показывает глубину буфера будущих состояний;
     - показывает расхождение между предсказанным и серверным состоянием своего корабля.
3. Принцип:
   - HUD максимально прост, без боевых деталей, щитов, брони, сложной графики.

**Готово (DoD):**

- Все ключевые показатели полёта отображаются стабильно и обновляются без рывков.
- При включении отладочного режима видно, как сеть и буфер будущих состояний влияют на отображение.

---

### M6. Минимальный бой и самые простые боты

**Цель:** проверить фундамент под бой, не вводя полноценную боевую модель. Сделать только то, что нужно для тестирования архитектуры.

#### 6.1. Минимальный бой (заглушка)

**Содержание:**

1. Захват цели:
   - выбор цели по щелчку или по горячей клавише/кнопке;
   - сервер знает, какая цель у какого игрока сейчас выбрана.
2. Команда «огонь»:
   - одна кнопка/клавиша;
   - один условный «ствол» для каждого корабля (без характеристик оружия).
3. Проверка на сервере:
   - если:
     - у игрока есть выбранная цель,
     - расстояние до цели меньше фиксированной дальности (одна константа),
     - и команда «огонь» активна,
   - тогда:
     - раз в заданный интервал уменьшать прочность корпуса цели на фиксированное число (например, 1 единицу или другой простой параметр);
     - при достижении нуля — помечать корабль как уничтоженный.
4. Никаких щитов, брони и типов урона:
   - никаких дополнительных слоёв защиты;
   - никаких сложных формул попадания;
   - никаких характеристик оружия — только константы «дальность» и «урон за выстрел».

**Готово (DoD):**

- Можно выбрать цель и, находясь в пределах заданной дальности, «стрелять» по ней.
- На сервере корректно уменьшается прочность корпуса и наступает состояние «уничтожен».
- Клиент получает и показывает изменение прочности и факт уничтожения.

#### 6.2. Простейшие боты

**Содержание:**

1. Поведение:
   - бот выбирает ближайшую доступную цель;
   - летит к цели по прямой;
   - на определённой дистанции (например, половина «дальности огня») периодически нажимает «огонь»;
   - при уничтожении цели выбирает следующую.
2. Простейшее управление:
   - бот использует те же команды, что и игрок:
     - команды движения;
     - команды поворота;
     - команду «огонь»;
   - помощник пилота работает для ботов так же, как и для людей.
3. Случайность:
   - допускается добавить немного случайности в поведение (например, небольшие отклонения курса), чтобы не выглядеть полностью механическим.
   - сложного планирования, формаций и взаимодействия между ботами нет.

**Готово (DoD):**

- Несколько ботов могут летать и периодически вступать в бой с игроком или друг с другом.
- Нагрузка на сервер при таком бою остаётся в пределах допустимых значений (без заметных задержек).
- Нет сложных зависаний или ошибок при уничтожении ботов и появлении новых.

---

## 4. Резерв под будущие версии (M7+)

Следующие подсистемы сознательно не планируются в 0.8.6, но должны учитываться как возможные расширения:

- тепло и охлаждение;
- щиты и броня;
- развитая модель оружия и баллистики;
- сложные режимы помощника пилота (в том числе Coupled-режим);
- продвинутый ИИ ботов (тактика, взаимодействие в отряде);
- сложные визуальные эффекты наблюдения и боя.

Для ИИ-агентов важно:

- в текущей версии не реализовывать эти системы;
- закладывать интерфейсы и точки расширения так, чтобы их можно было добавить без переписывания фундаментальных слоёв (физика, сеть, базовое управление).

