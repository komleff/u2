# U2 — План для ИИ-агентов

Версия: 0.8.3\
Дата: 2025‑11‑15

Документ описывает план разработки с участием ИИ‑агентов для прототипа космического симулятора **Universe Unlimited**. План согласован с архитектурой версии 0.8 (с учётом последних правок) и документом по целевым ощущениям от режима управления **Stabilized**.

Документ адресован:

- архитекторам и программистам клиент‑серверных приложений;
- техническим дизайнерам;
- ИИ‑агентам, которым нужны чёткие задачи, входные и выходные данные и критерии готовности.

Во всех разделах акцент делается на:

- прозрачном разделении обязанностей между модулями;
- детерминированности (одинаковый результат на клиенте и сервере);
- минимальной зависимости ранних этапов от сложных будущих систем.

---

## 1. Исходные допущения

### 1.1. Мир, физика и скорость света

1. Игра стартует в одной звёздной системе в плоской двумерной проекции (вид сверху). В дальнейшем возможно расширение до трёхмерной модели.
2. Сервер мира авторитетен: он хранит «истину» по состоянию объектов и проверяет все команды игроков.
3. Используется замедленный свет с **эффективной скоростью c′**, но **c′ считается постоянной для всей области мира** (для текущей сессии / шарада). Скорость света **не зависит от координаты и не подстраивается под нагрузку**.
4. Значение c′ задаётся в настройках мира и может изменяться только при конфигурировании сценария, а не динамически во время игры.
5. Эффекты относительности учитываются через коэффициент γ, но локальная вариация скорости света по пространству и «адаптивное поле скорости света» исключены из минимальной версии.

### 1.2. Наблюдение и интерфейс

1. Клиент учитывает задержку распространения света, используя постоянную c′ и расстояние до объекта.
2. Для сглаживания движения используется очередь **будущих состояний**, но **специальной «голограммы будущего» в интерфейсе нет**. Игрок видит обычные метки кораблей и целеуказание.
3. Отладочные элементы панели приборов (скорость в долях c′, задержка связи, вклад ассистента пилота) присутствуют, но могут быть скрыты в обычном режиме.

### 1.3. Управление и ассистенты

1. Источники команд:
   - локальный игрок;
   - удалённый оператор (для беспилотных и захваченных кораблей);
   - автопилот;
   - сценарные и отладочные скрипты (для ботов и тестов).
2. Ассистенты пилота не являются самостоятельным источником команд. Они — промежуточный слой между источниками управления и двигателями.
3. Для минимальной версии фиксируются два режима ассистента:
   - **Стабилизированный режим (Stabilized)** — режим по умолчанию для игроков;
   - **Свободный режим** — минимум ограничений, для опытных пилотов и специальных сценариев.
4. Расширенные схемы управления (сложный «сопряжённый»/«управляемый занос» как отдельный режим для хардкорных боёв) выносятся за рамки M0–M8 и рассматриваются после появления базового прототипа.

### 1.4. Ограничения по перегрузкам

1. Для пилотируемых кораблей вводятся предельные перегрузки, зависящие от архетипа корабля и заданные в его характеристиках.
2. Ограничения по перегрузке применяются в ассистенте пилота и при расчёте физики: при превышении пределов тяга уменьшается, манёвр растягивается по времени или включается аварийный режим.
3. Возможность временно отключить ограничение перегрузок рассматривается как отдельная настройка (опция «рисковый режим»), которая может быть реализована позднее и по умолчанию выключена.

---

## 2. Этапы M0–M8 (краткий обзор)

Этапы идут последовательно. Каждый следующий этап дополняет предыдущий, но не ломает зафиксированные интерфейсы.

| Этап | Суть этапа |
|------|-----------|
| **M0** | Каркас проекта, общая математика, простая ньютоновская физика, ядро компонентной системы, базовая структура для ИИ‑агентов. |
| **M1** | Серверная физика с релятивистской надстройкой (γ), автономный клиент без сети. |
| **M2** | Сетевой протокол, согласование клиента и сервера, предсказание на стороне клиента. |
| **M3** | Обработка управления, приоритеты источников, базовые режимы ассистента пилота. |
| **M4** | Наблюдение с учётом задержки света (при постоянной c′), очередь будущих состояний, расширенная телеметрия. |
| **M5** | Расширенный ассистент пилота в режиме Stabilized, аварийные режимы и защита от критических перегрузок. |
| **M6** | Базовый бой с захватом цели и вероятностью попадания, простые боты. |
| **M7** | Модель нагрева и повреждений, распределение тяги по двигателям. |
| **M8** | Оптимизация производительности и поддержка целевых платформ (ПК, браузер, мобильные). |

---

## 3. Сквозные требования к архитектуре

1. **Фиксация интерфейсов по этапам.** После завершения этапа интерфейсы считаются замороженными. В дальнейшем можно только добавлять новые поля, не ломая старые.
2. **Детерминизм.** Любой общий код (для клиента и сервера) при одинаковых входных данных даёт одинаковый результат.
3. **Тесты до интерфейса.** Прежде чем выводить новую функцию в пользовательский интерфейс, должны быть готовы модульные и интеграционные тесты.
4. **Отладка как часть готовности.** Для каждого этапа фиксируется минимальный набор телеметрии: задержки, частоты вызовов, журналы, отладочные элементы панели приборов.
5. **Возможность отключения сложных режимов.** Релятивистская надстройка, расширенный ассистент пилота и дополнительные отладочные панели включаются через настройки и могут быть выключены для упрощённого режима.
6. **Постоянная скорость света.** В минимальной версии не реализуется поле скорости света, зависящее от координат или нагрузки. Вместо этого используется одно значение c′ для всей сцены, задаваемое в конфигурации мира.

---

## 4. План задач для ИИ‑агентов по этапам

Для каждого этапа перечислены ИИ‑агенты и их задачи. Под «агентом» понимается отдельный поток работ, который может выполнять как человек‑разработчик, так и ИИ‑система.

### M0. Основа проекта

**Агент «Структура проекта»**

Задачи:
- создать структуру директорий `shared/`, `server/`, `client/`;
- настроить автоматическую сборку и запуск тестов;
- зафиксировать правила оформления кода.

Результат:
- репозиторий с рабочей сборкой и базовым конвейером тестирования.

Критерии готовности:
- проект собирается «с нуля» одной командой;
- тесты выполняются автоматически при изменениях.

**Агент «Математика»**

Задачи:
- реализовать базовые операции над векторами (сложение, вычитание, длина, нормализация, скалярное произведение);
- добавить простые численные фильтры для сглаживания резких изменений сигналов (управление, шумные данные).

Результат:
- общая библиотека математики в `shared/` с тестами.

Критерии готовности:
- все операции покрыты модульными тестами;
- фильтры демонстрируют предсказуемое сглаживание на тестовых данных.

**Агент «Параметр скорости света»**

Задачи:
- ввести глобальный параметр `cPrime` (c′) как часть конфигурации мира;
- реализовать вспомогательные функции пересчёта скорости в доли c′ и время пролёта света по расстоянию;
- добавить проверки инвариантов: скорость корабля не может превышать выбранную долю c′.

Результат:
- модуль конфигурации с параметром c′ и набором функций `vToFractionOfC`, `lightTravelTime(distance)`;
- базовые тесты на корректность вычислений и соблюдение ограничений по скорости.

Критерии готовности:
- изменение значения c′ в конфигурации меняет показания относительной скорости, но не ломает тесты;
- попытка разогнать корабль выше допустимой доли c′ отсекается проверками.

**Агент «Компонентная система»**

Задачи:
- ввести базовые компоненты: положение, скорость, масса, параметры силовой установки;
- реализовать простейший цикл обновления систем (обработчиков);
- реализовать сохранение и восстановление состояния мира (для отладки и будущей сети).

Результат:
- набор компонент и систем, позволяющих обновлять состояние объектов по шагам времени;
- функции сохранения/загрузки состояния.

Критерии готовности:
- несколько тестовых объектов корректно обновляются из кадра в кадр;
- состояние мира можно сохранить и восстановить без расхождений.

---

### M1. Физика и автономный клиент

**Агент «Физика сервера»**

Задачи:
- реализовать ньютоновский расчёт движения кораблей на сервере;
- добавить переключаемую релятивистскую надстройку (коэффициент γ, разложение силы на продольную и поперечную компоненты) с использованием глобального c′;
- учесть инвариант: скорость всегда меньше допустимой доли от c′.

Результат:
- модуль физики, одинаково работающий на сервере и в офлайн‑клиенте;
- набор тестов на простые сценарии разгона и поворотов.

Критерии готовности:
- при отключённой релятивистской надстройке результаты совпадают с чистой ньютоновской моделью;
- при включённой надстройке соблюдаются ограничения по скорости и устойчивости вычислений.

**Агент «Автономный клиент»**

Задачи:
- создать простую двумерную сцену: фон, корабль, несколько неподвижных объектов;
- вывести панель приборов с показанием скорости, доли скорости от c′, γ (если включён релятивистский режим), температуры;
- обеспечить запуск симуляции без подключения к серверу.

Результат:
- офлайн‑режим для отладки физики и управления.

Критерии готовности:
- разработчик может воспроизвести стандартные сценарии (разгон, торможение, разворот) локально;
- показания панели приборов согласованы с расчётами физики.

---

### M2. Сеть и согласование клиента и сервера

**Агент «Сетевой протокол»**

Задачи:
- описать форматы сообщений: команды управления, снимки состояния мира, служебные сообщения;
- выбрать транспорт (надёжный поток или датаграммы) и реализовать минимальный обмен;
- обеспечить устойчивость к расширению форматов (добавление полей без поломки старых клиентов).

**Агент «Согласование и предсказание»**

Задачи:
- реализовать на клиенте предсказание своего состояния между приходящими с сервера снимками;
- реализовать мягкое подтягивание к серверному состоянию при расхождениях;
- ввести очередь будущих состояний для чужих кораблей с задержкой порядка 100–150 мс.

Критерии готовности:
- при задержке до 150 мс движение выглядит плавным;
- при увеличении задержки видны лаги, но без «телепортов» собственного корабля.

---

### M3. Управление и базовый ассистент

**Агент «Источники управления и приоритеты»**

Задачи:
- формализовать набор источников управления (игрок, удалённый оператор, автопилот, скрипты);
- описать приоритеты: игрок → удалённый оператор → автопилот → сценарии;
- реализовать для каждой оси управления выбор единственного активного источника с плавным переключением.

Критерии готовности:
- при переключении источников не возникает резких скачков тяги;
- приоритет игрока соблюдается во всех сценариях.

**Агент «Базовый ассистент пилота»**

Задачи:
- реализовать режим Stabilized, уменьшающий неконтролируемое вращение и резкие ускорения;
- реализовать свободный режим с минимальным вмешательством;
- интегрировать ограничения по перегрузкам из конфигурации корабля: ассистент должен предотвращать выход за допустимые значения.

Критерии готовности:
- при отпускании органов управления корабль предсказуемо стабилизируется;
- при попытке задать чрезмерные ускорения ассистент мягко ограничивает команду.

---

### M4. Наблюдение с задержкой света и телеметрия

**Агент «Наблюдение с учётом задержки света»**

Задачи:
- реализовать расчёт времени пролёта света от объекта до наблюдателя как `t = distance / cPrime` с использованием глобальной c′;
- сервер должен помечать снимки состояния меткой времени «по свету»;
- клиент должен складывать такие снимки в очередь будущих состояний и показывать их с учётом сетевой задержки и времени пролёта света.

Ограничения:
- никаких полей скорости света, зависящих от координат или нагрузки;
- на уровне интерфейса не вводить отдельную «голограмму будущего», только аккуратно сглаженное движение.

**Агент «Телеметрия и отладочная панель»**

Задачи:
- расширить панель приборов показателями: текущий режим ассистента, доля его влияния, активный источник управления, RTT и разброс задержки;
- реализовать сбор телеметрии по клиенту и серверу (частоты, задержки, число объектов, время шага симуляции).

Критерии готовности:
- отладочная информация помогает воспроизводить и анализировать сетевые проблемы;
- включение/выключение телеметрии не влияет на основную физику.

---

### M5. Расширенный ассистент и аварийные режимы

**Агент «Расширенный Stabilized»**

Задачи:
- уточнить поведение режима Stabilized в бою согласно документу о целевых ощущениях: контроль, инерция без «каши», спортивность, читаемость;
- реализовать сглаживание манёвров, напоминающих поведение спортивного автомобиля в контролируемом заносе, но без превращения режима в полностью самостоятельный автопилот;
- обеспечить настройку параметров ассистента по архетипу корабля (более «острый» для истребителя, более плавный для фрегата).

**Агент «Аварийные режимы»**

Задачи:
- ввести пороговые значения для угловой скорости, скольжения, перегрузок, опасной близости к препятствиям;
- реализовать усиленный режим ассистента при выходе за пороги: выравнивание курса, снижение скорости, построение безопасной траектории;
- обеспечить плавный возврат к обычному режиму после выхода из опасной зоны.

Критерии готовности:
- в тестовых сценариях ассистент надёжно предотвращает потерю контроля над кораблём;
- игрок понимает, когда и почему ассистент временно усилил своё влияние.

---

### M6. Базовый бой и боты

**Агент «Бой с захватом цели и вероятностью попадания»**

Задачи:
- реализовать систему захвата цели: выбор, удержание и отображение цели;
- реализовать стрельбу только по захваченной цели;
- реализовать расчёт вероятности попадания и ожидаемого урона на сервере на основе характеристик оружия и цели, прежде всего калибра и сигнатуры цели, а также дистанции и относительной скорости.

Критерии готовности:
- при «удобной» дистанции и умеренной относительной скорости вероятность попадания находится в разумном диапазоне (например, 50–80 %);
- при увеличении дистанции или росте относительной скорости вероятность плавно уменьшается.

**Агент «Простые боты»**

Задачи:
- реализовать ботов, использующих те же механизмы, что и игроки: те же ассистенты, те же ограничения по скоростям, перегрузкам и задержке света;
- реализовать сценарии патрулирования, преследования, ухода от преследования;
- обеспечить корректное поведение ботов в простых боевых сценариях (1 на 1, 2 на 1).

Критерии готовности:
- бот способен удерживать цель, вести огонь, отступать и приближаться в зависимости от ситуации;
- бой с одним‑двумя ботами интересен и не вызывает очевидных багов в поведении.

---

### M7. Нагрев, повреждения и распределение тяги

**Агент «Нагрев и повреждения»**

Задачи:
- ввести для подсистем корабля рабочие диапазоны температур и перегрузок;
- связать нагрев с работой двигателей и оружия, а охлаждение — с конструкцией корабля;
- реализовать последствия выхода за пределы: урезание тяги, защитные режимы, частичные отказы.

**Агент «Распределение тяги по двигателям»**

Задачи:
- реализовать модуль, переводящий требуемые силы и моменты в команды для отдельных двигателей с учётом их положения и состояния;
- реализовать сообщение об ошибке, если требуемая команда физически невыполнима;
- покрыть модуль тестами на достижимость команд и поведение при отказах двигателей.

Критерии готовности:
- при штатной работе суммарная тяга и моменты соответствуют запросам ассистента;
- при отказах отдельных двигателей корабль ведёт себя предсказуемо, а система сообщает о невозможных командах.

---

### M8. Оптимизация и платформы

**Агент «Оптимизация»**

Задачи:
- собрать телеметрию по производительности: время шага симуляции, время работы основных систем, использование памяти;
- найти «узкие места» и переписать критические участки;
- убедиться, что при целевой нагрузке (4 игрока + 8 ботов) сервер укладывается во временной бюджет шага.

**Агент «Платформенные сборки»**

Задачи:
- подготовить сборки для персональных компьютеров, браузера и мобильных устройств;
- настроить управление и качество графики под каждую платформу;
- проверить сетевое поведение и плавность управления на целевых устройствах.

---

## 5. Глоссарий

**Ассистент пилота** — модуль, который помогает игроку управлять кораблём, сглаживает команды и ограничивает опасные режимы.

**Автопилот** — программа, которая самостоятельно управляет кораблём по заданным целям (например, следование по маршруту).

**Время пролёта света** — время, за которое свет проходит расстояние от объекта до наблюдателя. В игре вычисляется как расстояние, делённое на эффективную скорость света c′.

**Детерминизм** — свойство системы давать один и тот же результат при одинаковых исходных данных.

**Инвариант** — условие, которое всегда должно быть выполнено (например, скорость корабля не превышает выбранную долю от c′).

**Компонентная система** — способ описания объектов через набор простых компонент, каждая отвечает за один аспект (положение, физика, управление).

**Коэффициент γ (гамма)** — множитель, отражающий релятивистские эффекты при скоростях, близких к скорости света.

**Эффективная скорость света c′** — заниженная по сравнению с реальной скорость света, используемая в игре. В минимальной версии считается постоянной для всего мира и задаётся в конфигурации.

**Очередь будущих состояний** — небольшой буфер на клиенте, в котором хранятся состояния объектов с учётом задержки связи и времени пролёта света. Используется для плавного отображения движения.

**Панель приборов** — основная часть интерфейса, где пилот видит ключевые параметры корабля и окружающей обстановки.

**Сетевой протокол** — набор правил, по которым клиент и сервер обмениваются данными.

**Снимок состояния** — набор данных, описывающий мир в конкретный момент времени.

**Телеметрия** — служебные данные о работе системы (задержки, частоты, нагрузка), используемые для анализа и оптимизации.

**Этапы M0–M8** — логические шаги развития проекта. Каждый этап расширяет систему, не ломая зафиксированное поведение предыдущих этапов.

