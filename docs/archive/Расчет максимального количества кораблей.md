# Расчет пропускной способности сервера при 30 Hz

## Исходные данные после корректировок

**Частота:** 30 Hz → **33.3 мс на тик**

**Упрощения:**

- Нет трассировки снарядов
- Lock-target бой с вероятностным попаданием
- Коллизии только "крупные" (корабль-корабль, корабль-станция)

------

## Детализированный бюджет времени на один корабль

### 1. **Релятивистская физика** (~1.0-1.5 мс)

Что входит:

```
- Чтение c′(position) из поля: ~0.05 мс
- Расчет γ = 1/√(1 - v²/c′²): ~0.1 мс
- Разложение силы F∥ и F⊥: ~0.15 мс
- Интеграция импульса p' = p + F·dt: ~0.2 мс
- Обратное преобразование v = p/(γm): ~0.15 мс
- Интеграция позиции x' = x + v·dt: ~0.1 мс
- Ограничение |v| < 0.999·c′: ~0.05 мс
- Угловая динамика (yaw/pitch/roll): ~0.2 мс
```

**Итого:** ~1.0 мс (оптимистично) до ~1.5 мс (с кэш-промахами)

### 2. **Тепловая модель** (~0.3-0.5 мс)

```
- Q̇_gen = Σ(thruster_heat + weapon_heat): ~0.1 мс
- Q̇_cool = f(radiators, T_ambient): ~0.05 мс
- Интеграция Q' = Q + (Q̇_gen - Q̇_cool)·dt: ~0.05 мс
- Проверка порогов и троттлинг: ~0.1 мс
- Обновление состояний систем: ~0.1 мс
```

**Итого:** ~0.4 мс

### 3. **Управление и ассистенты** (~0.5-1.0 мс)

```
- Арбитраж источников команд: ~0.1 мс
- Расчет Decoupled/Stabilized assist: ~0.2 мс
  (PD-контроллеры, jerk-limiting)
- Coupled assist (если активен): ~0.4-0.6 мс
  (β*, yaw-lead, динамическая капа)
- Формирование ForceCommand: ~0.1 мс
```

**Итого:** 0.5 мс (простые режимы) до 1.0 мс (Coupled)

### 4. **Thrust Allocation** (~0.2-0.4 мс)

Только для кораблей с несколькими двигателями:

```
- Квадратичный распределитель по соплам: ~0.3 мс
- (Для большинства кораблей можно упростить до линейного: ~0.1 мс)
```

**Итого:** ~0.2 мс (среднее)

### 5. **Lock-target combat** (~0.1-0.2 мс на стрельбу)

```
- Проверка условий выстрела: ~0.05 мс
- Расчет P_hit = f(калибр, дальность, relVel, сигнатура, γ): ~0.1 мс
- Бросок кубика и применение урона: ~0.05 мс
```

**Замечание:** Не каждый корабль стреляет каждый тик.

- При стрельбе ~1 раз в 0.5-2 секунды
- В среднем ~10% кораблей стреляют на данном тике

**Среднее по флоту:** ~0.02 мс на корабль

------

## Крупные коллизии: N² проблема

### Naive подход (все со всеми):

```
Для N кораблей:
- Проверок: N(N-1)/2
- Одна проверка "корабль-корабль": ~0.05 мс (AABB → circle)
```

**Сложность:** O(N²)

| Кораблей | Проверок | Время (naive) |
| -------- | -------- | ------------- |
| 10       | 45       | 2.25 мс       |
| 20       | 190      | 9.5 мс        |
| 50       | 1225     | 61 мс ❌       |

**Вывод:** Naive не масштабируется.

### Spatial hashing / Grid:

```
- Разбиение пространства на ячейки ~1-5 км
- Проверки только внутри ячейки + соседние
- Среднее число соседей на корабль: ~4-8
```

**Время на корабль:** ~0.3-0.5 мс

| Кораблей | Время (grid) |
| -------- | ------------ |
| 10       | 3-5 мс       |
| 20       | 6-10 мс      |
| 50       | 15-25 мс     |

**Допущение:** Корабли распределены неравномерно (60% в "горячих зонах").

------

## Суммарный бюджет на один корабль

### Базовый случай (без Coupled, редкая стрельба):

```
Физика:          1.0-1.5 мс
Тепло:           0.3-0.5 мс
Управление:      0.5-0.7 мс
Thrust Alloc:    0.2 мс
Combat:          0.02 мс
Коллизии (grid): 0.3-0.5 мс
────────────────────────────
Итого:           2.3-3.4 мс/корабль
```

### Худший случай (Coupled активен, частая стрельба):

```
Физика:          1.5 мс
Тепло:           0.5 мс
Управление:      1.0 мс (Coupled)
Thrust Alloc:    0.4 мс
Combat:          0.2 мs (активная стрельба)
Коллизии (grid): 0.5 мс
────────────────────────────
Итого:           4.1 мс/корабль
```

------

## Расчет максимального числа кораблей

### Бюджет времени: 33.3 мс на тик

**Накладные расходы (~20% бюджета):**

```
- Обновление c′(x) поля: ~1 мс
- Сетевая сериализация: ~2-3 мс
- AI/автопилот (10% кораблей): ~1-2 мс
- Garbage Collection запас: ~2 мс
- Прочее (логирование, метрики): ~1 мс
────────────────────────────────────────
Итого оверхед: ~7-9 мс
```

**Доступно на корабли:** 33.3 - 8 = **25.3 мс**

### Сценарии:

#### **Оптимистичный** (большинство в Decoupled/Stabilized):

```
25.3 мс / 2.3 мс = ~11 кораблей
```

#### **Реалистичный** (средний микс режимов):

```
Средний бюджет: 2.8 мс/корабль
25.3 мс / 2.8 мс = ~9 кораблей
```

#### **Пессимистичный** (все в Coupled, активный бой):

```
25.3 мс / 4.1 мс = ~6 кораблей
```

------

## Оптимизации для масштабирования

### 1. **Асинхронные уровни обновления**

Не все системы нужно считать каждый тик:

```
Каждый тик (30 Hz):
- Физика, управление, коллизии

Каждый 2-й тик (15 Hz):
- Тепловая модель (медленно меняется)
- Thrust allocation (можно интерполировать)

Каждый 3-й тик (10 Hz):
- AI/автопилот решения
- Обновление c′(x) поля
```

**Экономия:** ~15-20% CPU

**Новый лимит:** 9 → **10-11 кораблей**

------

### 2. **Зоны интереса (Areas of Interest)**

Полная физика только для кораблей в радиусе ~20-50 км друг от друга:

```
Близкие корабли (<20 км): Полная симуляция
Средние (20-100 км):      Упрощенная физика (без Coupled, без коллизий)
Дальние (>100 км):        Только кинематика (v·dt)
```

**Пример:**

- 20 кораблей всего
- 8 в "горячей зоне" → полная симуляция
- 12 на периферии → упрощенная

**Средний бюджет:**

```
8 * 2.8 мс + 12 * 0.5 мс = 22.4 + 6 = 28.4 мс
```

**Лимит:** **до 20 кораблей** с AoI

------

### 3. **Job System / параллелизация**

Если сервер многоядерный (4+ ядра):

```csharp
// Псевдокод
Parallel.For(0, ships.Count, i => {
    UpdatePhysics(ships[i]);
    UpdateHeat(ships[i]);
    UpdateControl(ships[i]);
});

// Потом синхронно:
ResolveCollisions();
```

**Gain:** ~2-3x на 4-ядерном CPU (не линейный из-за синхронизации)

**Новый лимит:** 9 → **18-25 кораблей**

------

### 4. **SIMD / vectorization**

Обрабатывать 4-8 кораблей за раз через SIMD (System.Numerics.Vectors):

```csharp
// Псевдокод
Vector4 velocitiesX = new Vector4(v1.x, v2.x, v3.x, v4.x);
// Одна операция для 4 кораблей
```

**Gain:** ~30-50% для математики (не для всей логики)

**Новый лимит:** 9 → **12-14 кораблей**

------

## Итоговая таблица пропускной способности

| Конфигурация               | Кораблей  | Примечания                      |
| -------------------------- | --------- | ------------------------------- |
| **Базовая (30 Hz, naive)** | 6-9       | Текущий план без оптимизаций    |
| + Асинхронные уровни       | 10-11     | Простая оптимизация             |
| + Spatial grid             | 12-14     | Обязательна при N>10            |
| + Зоны интереса            | 15-20     | Требует дизайна геймплея        |
| + Job System (4 ядра)      | 20-30     | Сложность синхронизации         |
| + SIMD                     | 25-35     | Требует рефакторинга математики |
| **Все оптимизации**        | **30-40** | Предел для 30 Hz сервера        |

------

## Рекомендации

### Для вашего прототипа (4 игрока + 10 ботов = 14 кораблей):

**Минимальный набор:**

1. ✅ 30 Hz вместо 60 Hz
2. ✅ Spatial grid для коллизий
3. ✅ Асинхронное обновление тепла (15 Hz)

**Этого достаточно для 14 кораблей** без параллелизации.

------

### Для масштабирования до 20-30 кораблей:

Добавить: 4. Зоны интереса (фазы боя: engagement/pursuit/travel) 5. Job System для физики (если .NET 8 сервер)

------

### Для 50+ кораблей (future):

Потребуется: 6. Шардирование пространства (разные серверы для разных зон) 7. SIMD оптимизации математики 8. Переход на ECS-архитектуру (Unity DOTS на сервере?)

------

## Ответ на ваш вопрос

> Сколько кораблей можно обсчитывать при 30 Hz?

**Без оптимизаций:** 6-9 кораблей
 **С базовыми оптимизациями (grid + async):** 12-14 кораблей
 **С Job System:** 20-30 кораблей
 **С полным набором:** 30-40 кораблей (потолок для 30 Hz)

**Для вашего прототипа (14 кораблей):**

- ✅ Достижимо при 30 Hz
- ✅ Нужны: spatial grid + асинхронное обновление
- ✅ Без параллелизации (проще отлаживать)

**Запас:** ~8-10 мс на добавление фич (эффекты, логирование, etc.)