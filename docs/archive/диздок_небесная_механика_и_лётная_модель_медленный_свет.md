# Дизайн-документ: небесная механика и лётная модель в космосе с медленной скоростью света

> Версия 0.1 • Серверный тик: **Δt ≈ 32 ms** (≈ 1/31.25 с) • Базовая константа по умолчанию: **c = 10 000 м/с (10 км/с)**. Все величины параметризуемы.

---

## 0) Цели и принципы

**Пояснение (простыми словами):** мы считаем физику на сервере кусочками по 32 мс. Свет летит медленно (по выбранной нами константе), поэтому игрок видит не «сейчас», а «как было чуть раньше». Мы не вводим жёсткие запреты на скорость — вместо этого техника сама «не тянет» слишком быстрый манёвр из‑за ограничений мощности, тепла и перегрузок для пилота. Все формулы написаны так, чтобы их можно было применять по шагам, без сложной математики.

- **Единая физика для PvP/PvE**: сервер-авторитет с фиксированным тиком, детерминированный интегратор.
- **Медленный свет**: игроки и сенсоры видят прошлое состояние по задержке \(t_{age} = d/c\); симуляция при этом идёт в «истинном» времени сервера.
- **Без жёстких капов скорости**: пределы рождаются из **мощности/тепла**, **пропелланта**, **био‑лимитов** и **СТО**.
- **Итеративная формулировка**: все уравнения заданы в дискретном, тик‑ориентированном виде.

---

## 1) Система координат, состояния и единицы

### 1.1. Состояние корабля (сервер)

**Пояснение:** думайте об этом как о «карточке» корабля, где лежат все нужные числа. `x` — где мы находимся; `p` и `v` — как быстро и куда летим; `q` — куда «смотрим»; `m` — масса (топливо меняет её); `Q` и `T` — сколько накопили энергии/тепла; `M_fuel` — сколько осталось топлива. Эти поля обновляются каждый тик по формулам ниже.

\[\mathbf{S} = \{\mathbf{x},\ \mathbf{p},\ \mathbf{q},\ \mathbf{L},\ m,\ Q,\ T,\ M_{fuel},\ ...\}\]
- \(\mathbf{x}\) — позиция; \(\mathbf{p} = \gamma m \mathbf{v}\) — импульс; \(\gamma = 1/\sqrt{1-(v/c)^2}\).
- \(\mathbf{q}\) — ориентация (кватернион); \(\mathbf{L}\) — угловой импульс.
- \(m\) — текущая масса (с учётом топлива); \(Q\) — энергия, накопленная в буфере бурст‑тяги; \(T\) — температура радиаторов; \(M_{fuel}\) — запас пропелланта.

### 1.2. Единицы (HUD/геймдизайн)

**Пояснение:** чтобы игроку было понятно, мы показываем дистанции и в метрах/км, и как «световое время». При `c = 10 км/с`: 1 **ls** = 10 км, 1 **lms** = 10 м. Значит 1 км = 0.1 ls = 100 lms. Возраст картинки (AGE) на 2 км будет 0.2 с, на 500 м — 50 мс.

- Дистанция: м/км + дублирование в **ls** (light‑second по нашей \(c\)) и **lms** (light‑millisecond). При \(c=10\ км/с\): **1 ls = 10 км**, **1 lms = 10 м**.
- Возраст изображения: **AGE** в сек/мс.

---

## 2) Небесная механика

### 2.1. Гравитация

**Пояснение:** каждый большой объект «тянет» к себе, и чем он тяжелее и ближе — тем сильнее. Мы просто суммируем вклады всех тел. По умолчанию поле считается «мгновенным», чтобы не грузить сервер, но при желании можно включить «запоздание» положения планет (это дороже, и для PvP обычно не нужно).
- Базово — ньютоновская суперпозиция с таблицей массивных тел \(M_k\):
\[\mathbf{a}_g(\mathbf{x}) = -\sum_k G M_k \frac{\mathbf{r}_k}{\lVert\mathbf{r}_k\rVert^3},\quad \mathbf{r}_k = \mathbf{x} - \mathbf{x}_k\]
- **Опционально**: «патчёные коники» для полётов у планет, либо предвычисленные эфемериды.
- **Медленный свет для гравитации** (упрощённо): по умолчанию — **статические поля** (без ретарда). Для динамичных тел можно включить «ретардированные позиции» \(\mathbf{x}_k(t_r)\), где \(t_r = t - \lVert\mathbf{x}-\mathbf{x}_k\rVert/c\), но это дороже.

### 2.2. Давление излучения/солнечный ветер (по желанию)

**Пояснение:** это слабые «подталкивания» от света и частиц звезды. Для боевых кораблей эффект мал и по умолчанию выключен; его можно включать для специальных миссий/парусов.

\[\mathbf{a}_{rad} = C_{rad} \frac{1}{\lVert\mathbf{r}_\odot\rVert^2}\,\hat{\mathbf{r}}_\odot\]\
(коэфф. по материалам/площади; по умолчанию выключено для боевых кораблей)

### 2.3. Интегратор (позиция/скорость)

**Пояснение:** каждый тик мы делаем три шага: (1) прибавляем силу к импульсу, (2) пересчитываем скорость с учётом СТО (через γ), (3) сдвигаем позицию. Такой порядок даёт устойчивые траектории без «накачивания» энергии и легко реализуется в коде.

Используем **симплектический полууявный Эйлер** (устойчивый для сил, зависящих от положения):
1) \(\mathbf{p}_{n+1} = \mathbf{p}_n + \mathbf{F}_n\,\Delta t\)
2) \(\gamma_{n+1} = \sqrt{1 + \lVert\mathbf{p}_{n+1}\rVert^2/(m^2 c^2)}\)
3) \(\mathbf{v}_{n+1} = \mathbf{p}_{n+1}/(\gamma_{n+1} m)\)
4) \(\mathbf{x}_{n+1} = \mathbf{x}_n + \mathbf{v}_{n+1}\,\Delta t\)

Где \(\mathbf{F}_n = \mathbf{F}_{grav} + \mathbf{F}_{thrust} + \mathbf{F}_{drag?}\). Для космоса сопротивление отключено.

---

## 3) Двигатели, мощность, тяга и тепло

Мы поддерживаем **два класса движителей** (можно смешивать на корабле):

### 3.1. Энергетический (power‑limited, «полевой/плазменный»)

**Пояснение:** этот тип упирается в доступную мощность. Если давим вдоль скорости — скорость растёт, но не быстрее, чем позволяет `P_prop`. Если пытаемся резко повернуть на большой скорости — ограничивает `P_turn`, поэтому «на больших v крутится хуже». Это естественный ограничитель без капов.

- Ограничение мощностью: **механическая** мощность, переданная кораблю, не превышает \(P_{mech}\le P_{prop}\) (после КПД).
- В проекции на скорость: \(P_{mech}=\mathbf{F}\cdot\mathbf{v}\). Для чисто поперечного манёвра \((\mathbf{F}\perp\mathbf{v})\) корабль не меняет кинетическую энергию, но движитель всё равно ограничен **электрически/теплово** — задаём потолок по **величине тяги** \(\lVert\mathbf{F}\rVert\le F_{max}\).
- **Кэп мощности для поворотов** (геймплейно полезный): ограничиваем нормальное ускорение по мощности
\[a_\perp\le \frac{P_{turn}}{m\,\max(v,\varepsilon_v)}\quad\Rightarrow\quad \lVert\mathbf{F}_\perp\rVert \le \frac{P_{turn}\,m}{\max(v,\varepsilon_v)}\]
— это делает высокоскоростной бой менее «вертким» без жёстких капов.

**Итоговая тяга за тик (энергетический):**
\[\mathbf{F}^{(E)} = \operatorname{clip\_by\_magnitude}\Big(\mathbf{F}_\text{жел},\ \min\{F_{max},\ F_{P\parallel},\ F_{P\perp}\}\Big)\]
где
\(F_{P\parallel} = \frac{P_{prop}}{\max(\lvert\mathbf{v}\cdot\hat{\mathbf{u}}\rvert,\varepsilon_v)}\) — вдоль \(\hat{\mathbf{u}}=\mathbf{F}_\text{жел}/\lVert\mathbf{F}_\text{жел}\rVert\);
\(F_{P\perp} = \frac{P_{turn}\,m}{\max(v,\varepsilon_v)}\) — на поперечную составляющую.

### 3.2. Реактивный (propellant‑limited, «ракетный/ЯРД/ЭРД»)

**Пояснение:** тут всё через реактивную струю: тяга = расход × скорость истечения. Хочешь большую тягу — или лей больше массы, или разгоняй струю, но за это платишь мощностью и топливом. Формулы подскажут верхнюю планку по паспортам двигателя.

- Связь тяги и мощности через эффективную скорость истечения \(v_e\):
\[P_{jet} = \tfrac{1}{2}\dot m v_e^2,\quad F = \dot m v_e,\quad \Rightarrow\quad P_{jet} = \tfrac{F\,v_e}{2}\]
- С учётом КПД \(\eta\): требуемая электротермическая мощность \(P_{prop} = \frac{P_{jet}}{\eta} = \frac{F v_e}{2\eta}\).
- Расход пропелланта: \(\dot m = F/v_e\). Ограничения: \(F\le F_{max}\), \(\dot m\le \dot m_{max}\), \(P_{prop}\le P_{avail}\), \(M_{fuel}\ge 0\).

**Итоговая тяга за тик (реактивный):**
\[F^{(R)} \le \min\Big(F_{max},\ v_e\,\dot m_{max},\ \frac{2\eta P_{avail}}{v_e}\Big),\quad M_{fuel}^{n+1} = M_{fuel}^n - \dot m\,\Delta t\]

### 3.3. Био‑ и СТО‑лимиты ускорения

**Пояснение:** при высоких скоростях «эффективное» ускорение вдоль полёта падает как 1/γ³, поперёк — как 1/γ. Это требование СТО: чем ближе к скорости света, тем труднее прибавлять скорость и «ломать» траекторию. Отдельно мы следим за перегрузкой пилота (α) и, если она выше порога, автоматически уменьшаем тягу.

**Мини‑шпаргалка γ:** при 0.1c — γ≈1.005 (почти без эффекта), 0.5c — γ≈1.155 (вдоль в ~1.5× хуже), 0.8c — γ≈1.667 (вдоль в ~4.6× хуже), 0.9c — γ≈2.294 (вдоль в ~12× хуже).

Разложим желаемую тягу на параллельную/перпендикулярную к скорости: \(\mathbf{F}_\parallel,\ \mathbf{F}_\perp\). Тогда координатное ускорение:
\[a_\parallel = \frac{\lVert\mathbf{F}_\parallel\rVert}{\gamma^3 m},\qquad a_\perp = \frac{\lVert\mathbf{F}_\perp\rVert}{\gamma m}\]
**Собственное ускорение** (то, что чувствует пилот) по норме:
\[\alpha = \sqrt{\gamma^6 a_\parallel^2 + \gamma^4 a_\perp^2}\]
Ограничиваем \(\alpha \le \alpha_{max}\) (например, 6–12 g в бурсте, 2–3 g устойчиво). Если превышено — масштабируем \(\mathbf{F}\leftarrow \mathbf{F}\cdot(\alpha_{max}/\alpha)\).

### 3.4. Тепло и радиаторы

**Пояснение:** любая мощность превращается в тепло. Радиаторы сбрасывают его излучением ~T⁴. Если греться быстрее, чем остывать — температура растёт, и мы автоматически снижаем доступную мощность движителей. Поэтому «жарить на полную» можно недолго — нужен тайминг.

- Излучательная мощность \(P_{rad} = \sigma\,\varepsilon\,A\,T^4\) (Стефан–Больцман).
- Баланс тепла (дискретно):
\[Q_{n+1} = Q_n + (P_{in} - P_{rad}(T_n))\,\Delta t,\quad T_{n+1} = T_n + \frac{Q_{n+1}-Q_n}{C_{th}}\]
Где \(P_{in} = P_{prop} + P_{систем}\). Если \(T\to T_{max}\) — авто‑дерейтинг \(P_{prop}\) и/или вынужденный кулдаун.

### 3.5. Буфер «бурст‑тяги»

**Пояснение:** это «аккумулятор» для коротких рывков. Вы можете поднять тягу сверх средней на несколько секунд, но потом буфер опустеет и придётся ждать зарядки/остывания. Так мы даём эффект «спурта» без бесконечного форсажа.

- Энергоблок с ёмкостью \(E_{burst}\). За тик: \(E_{burst}^{n+1} = E_{burst}^n - P_{prop}\,\Delta t\) при бурсте, иначе — зарядка \(\min(P_{charge}, P_{rad} - P_{систем})\).

---

## 4) Итеративное обновление за тик (поступательная динамика)

**Пояснение:** один тик — это маленький шаг времени (32 мс). За него мы считаем гравитацию, применяем ограниченную тягу, обновляем импульс/скорость/позицию и тепловое состояние. Такой «конвейер» повторяется 30+ раз в секунду и даёт гладкое движение у всех клиентов.


**Входы тика**: состояние \(\mathbf{S}_n\), вход игрока/ИІ (вектор тяги/тяги РУД), список массивных тел.

1. **Гравитация**: \(\mathbf{F}_{grav} = m\,\mathbf{a}_g(\mathbf{x}_n)\).
2. **Желаемая тяга** из управления: \(\mathbf{F}_{жел} = F_{cmd}\,\hat{\mathbf{u}}_{cmd}\).
3. **Ограничения двигателя**: вычислить \(\mathbf{F}_{thrust}\) по 3.1/3.2, учесть 3.3 (\(\alpha_{max}\)).
4. **Суммарная сила**: \(\mathbf{F}_n = \mathbf{F}_{grav} + \mathbf{F}_{thrust}\).
5. **Импульс/скорость/позиция**: по шагам 2.3 (симпл. Эйлер на импульсе).
6. **Тепловой шаг**: 3.4; **Топливо/бурст**: 3.5.
7. **Квантование и сериализация** снапшота для клиентов (с меткой \(t_n\)).

---

## 5) Повороты, ориентация и мощность на приводах

**Пояснение:** чтобы повернуть быстро, нужны и момент, и мощность. На больших угловых скоростях вас ограничивает именно мощность приводов (`P_gimbal`): чем быстрее уже крутитесь, тем меньше «запаса» для добавочного ускорения. Это делает сверхбыстрые развороты дорогими и редкими.


- Состояние: \(\mathbf{q},\ \mathbf{L}\). Тяговые приводы/реакц. колёса: максимум момента \(\tau_{max}\), мощность \(P_{gimbal}\).
- Связь «мощность–угловое ускорение»: \(P = \boldsymbol{\tau}\cdot\boldsymbol{\omega}\). Ограничиваем
\[\lVert\boldsymbol{\tau}\rVert \le \min\Big(\tau_{max},\ \frac{P_{gimbal}}{\max(\lVert\boldsymbol{\omega}\rVert,\varepsilon_\omega)}\Big)\]
- Дискретно:
\[\mathbf{L}_{n+1}=\mathbf{L}_n + \boldsymbol{\tau}_n\,\Delta t,\quad \boldsymbol{\omega}_{n+1}=\mathbf{I}^{-1}\mathbf{L}_{n+1},\quad \mathbf{q}_{n+1}=\exp\!\Big(\tfrac{1}{2}\,[0,\boldsymbol{\omega}_{n+1}]\,\Delta t\Big)\otimes\mathbf{q}_n\]

---

## 6) Медленный свет: сенсоры, HUD, хитрег

### 6.1. Возраст изображения и дальномер

**Пояснение:** AGE = расстояние / c. При `c = 10 км/с`: 1 км → 0.1 с, 500 м → 50 мс, 2 км → 0.2 с. HUD всегда показывает, насколько «старую» сцену вы видите, и дублирует дистанцию в обычных метрах/км для привычности.

- Возраст фотона: \(t_{age} = d/c\). HUD показывает **AGE** крупно и **RANGE** в км + эквивалент в ls/lms. Автоподбор единиц.

### 6.2. «Ретардированные» снапшоты на клиентах

**Пояснение:** сервер шлёт состояние с отметкой времени. Клиент специально ждёт `d/c + Δ`, чтобы все видели «одинаково старую» картинку, и сеть не давала скрытых преимуществ. Параллельно рисуется прогноз на «сейчас», который мягко сходится к реальности, когда доходит свет/пакет.

- Сервер шлёт снапшоты с меткой \(t_0\). Клиент отображает их **по расписанию**: \(t_{disp} = t_0 + d/c + \Delta\) (\(\Delta\) — унифицированный лаг‑буфер 2–3 тика).
- «Призрачный прогноз» на клиенте интерполирует к \(t_{now}\), но при приходе света сходится к реальности.

### 6.3. Стрельба

**Пояснение:** для лучей урон приходит одновременно с тем, как вы видите вспышку (визуально честно). Для снарядов урон позже — им надо долететь. Сервер решает всё по своей «линейке времени», так что читы с лагом не помогают.

- **Лучи**: попадание засчитывается, если событие лежит на пересечении луча и мировой линии цели при времени эмиссии (уровень сервера). Игрок видит вспышку и урон одновременно.
- **Снаряды**: сервер считает баллистику; попадание по факту контакта; визуально выстрел видно раньше урона.

---

## 7) Типичные диапазоны скоростей (баланс, при c = 10 км/с)

**Пояснение:** эти коридоры подобраны так, чтобы (а) скины и силуэты читались, (б) окна стрельбы были 1–3 с, (в) движки не уходили в бесконечный перегрев. Вы можете двигать границы через параметры мощности/радиаторов/перегрузок.


| Стиль | Скорость | Доля c | Перегрузки |
|---|---:|---:|---|
| Boom‑n‑Zoom | 0.8–1.5 км/с | 0.08–0.15 | устойчиво ≤1 g, бурсты 8–12 g (5–15 с) |
| Two‑circle | 0.22–0.32 км/с | 0.022–0.032 | устойчиво 2–3 g, бурст 5–6 g |
| One‑circle | 0.18–0.26 км/с | 0.018–0.026 | устойчиво 2–3 g, бурст 6–8 g |
| Scissors | 0.12–0.22 км/с | 0.012–0.022 | устойчиво 3–4 g, бурст 8–10 g |

*(Диапазоны настраиваются; логика ограничения — мощность/тепло/\(\alpha_{max}\).)*

---

## 8) Псевдокод тика (сервер)

**Как читать:** комментарии справа — смысл строки. Даже если вы не физик, просто повторите порядок: сила → ограничение тягой → СТО/перегрузка → импульс → скорость → позиция → тепло → снапшот. Это ровно то, что делает игра каждые 32 мс.


```pseudo
const dt = 0.032  // 32 ms
for each entity E:
  // 1) Гравитация
  Fg = m * gravity_accel(E.x)

  // 2) Желаемая тяга
  u_cmd = normalized(input.thrust_dir)
  F_des = input.thrust_level * F_capability  // 0..1 * паспорт

  // 3) Ограничения по типу движителя
  if engine.type == POWER_LIMITED:
     v = E.p / (gamma(E.p)*m)
     v_par = max(abs(dot(v,u_cmd)), eps_v)
     F_Ppar = P_prop / v_par
     F_Pperp = (P_turn * m) / max(|v|, eps_v)
     F_lim = min(F_max, F_Ppar, F_Pperp)
  else if engine.type == PROPELLANT:
     F_lim = min(F_max, ve*mdot_max, 2*eta*P_avail/ve)
     mdot = F_lim / ve; fuel -= mdot*dt
     P_prop = F_lim * ve / (2*eta)

  F_thr = clamp_mag(F_des, F_lim)

  // 3b) СТО/био-лимит
  v = E.p / (gamma(E.p)*m)
  F_par = proj(F_thr, v)
  F_perp = F_thr - F_par
  a_par = |F_par| / (gamma(E.p)^3 * m)
  a_perp = |F_perp| / (gamma(E.p) * m)
  alpha = sqrt( gamma^6 * a_par^2 + gamma^4 * a_perp^2 )
  if alpha > alpha_max:
     F_thr *= alpha_max / alpha

  // 4) Суммарная сила
  F = Fg + F_thr

  // 5) Импульс/скорость/позиция
  p += F * dt
  v = p / (gamma(p)*m)
  x += v * dt

  // 6) Тепло/радиаторы/бурст-энергия
  Prad = sigma*eps*A*T^4
  Q += (P_in - Prad)*dt
  T += (Q_delta)/Cth
  if T>Tmax: derate P_prop

  // 7) Serialize snapshot (x, v, etc) @ t_n
```

---

## 9) Сетевой контур

**Пояснение:** сервер — «истина». Клиенты получают снимки мира и выводят их с одинаковым запозданием (d/c + Δ), чтобы игра казалась честной и «медленный свет» ощущался как особенность мира, а не как лаг.


- **Авторитет**: сервер. Кадр мира фиксируется с частотой тиков.
- **Снапшоты**: содержат \((\mathbf{x},\mathbf{v}, m, T, ...), t_0\).
- **Клиент**: рендерит с \(t_{disp} = t_0 + d/c + \Delta\), где \(\Delta\) — общий буфер (2–3 тика). Дополнительно включён «призрак‑прогноз» до \(t_{now}\).
- **Хитрег**: по серверному времени. Для лучей — проверка пересечения светового конуса.

---

## 10) Инварианты и тест‑кейсы

**Пояснение:** это список самопроверок. Если что‑то из этого ломается — ищите баг в интеграторе или лимитерах.

1. **Энергетика**: при чисто поперечной тяге \((\mathbf{F}\perp\mathbf{v})\) скорость по модулю не растёт в power‑limited режиме, но растёт тепло/расход по паспорту движителя.
2. **СТО**: \(|\mathbf{v}|<c\) всегда; при постоянной \(\mathbf{F}_\parallel\) ускорение по величине падает с ростом \(\gamma\).
3. **Тепло**: при \(P_{in} > P_{rad}\) температура растёт и вызывает дерейтинг.
4. **Сеть**: урон по лучу никогда не приходит раньше видимой вспышки (AGE‑согласованность).

---

## 11) Таблица символов

- \(\mathbf{x},\mathbf{v},\mathbf{p}\) — позиция, скорость, импульс; \(m\) — масса; \(\gamma\) — лоренцев фактор; \(c\) — скорость света в игре.
- \(\mathbf{F}_{grav},\mathbf{F}_{thrust}\) — силы; \(P_{prop}, P_{turn}, P_{mech}\) — мощности.
- \(\alpha\) — собственное ускорение (g‑нагрузка); \(A, T, \varepsilon\) — площадь/температура/эмисс. радиаторов; \(\sigma\) — константа Стефана–Больцмана.
- \(v_e, \dot m, \eta\) — скорость истечения, расход, КПД реактивного движителя.
- \(E_{burst}\) — энергия буфера бурста; \(\Delta t\) — длительность тика; \(\Delta\) — общий сетевой лаг‑буфер.

---

### Примечания по балансировке

**Пояснение:** если бой кажется «слишком липким» — поднимите `P_turn` или `A` радиаторов. Если слишком аркадный — уменьшите `P_turn` или ужесточите `α_max/бурсты`. «Корнер‑скорость» естественно вылезет сама из этих ручек.

- «Корнер‑скорость» для устойчивых 2–3 g рождается из предела мощности/тепла и легко твикается через \(P_{turn}\), \(A\), \(T_{max}\).
- Boom‑n‑zoom получает короткие, но читабельные окна контакта при 0.8–1.5 км/с (AGE ≈ 80–150 мс/км).
- Все формулы собраны так, чтобы менять \(c,\ \Delta t\) без перелома механики.

