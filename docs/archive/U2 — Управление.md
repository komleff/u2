# **U2 — Управление**

**Версия:** 0.8  
**Дата:** 2025‑11‑14

Да. Решение — развести «приоритет источника команд» и «приоритет коррекции/ограничений». Ассистент не должен конкурировать с пилотом как отдельный «источник», он работает **после** арбитража источников, преобразуя объединённые команды в реализуемые и безопасные.

---

## **Вертикаль приоритетов (жёсткая)**

1. **Safety/Envelope**: инварианты сервера (|v|\<0.999·c′, бюджеты тяги/тепла, jerk‑лимиты) и ассистент.

2. **Allocator**: распределение по движкам.

3. **Thrusters**.

Команды из любых источников (пилот, автопилот, удалённый) всегда проходят через п.1. Поэтому ассистент «выше» пилота функционально, даже если пилот «старше» в списке источников.

---

## **Горизонталь источников (мягкая)**

Лестница применима только к **источникам сырого управления**:  
 **Remote ≥ Autopilot ≥ Local Devices**.  
 Ассистент в эту лестницу **не входит** — он модуль пост‑обработки.

Передача между источниками — «stateful takeover» с подхватом текущих тяг и cross‑fade 150–200 мс по осям.

---

## **Математика смешивания ассистента**

Пусть `u_fused` — вектор команд после арбитража источников (ось Tx, Ty, Rz),  
 `u_assist` — скорректированный ассистентом вектор,  
 `w_a ∈ [0..1]` — доля влияния ассистента.

u\_out \= (1 − w\_a) · u\_fused \+ w\_a · u\_assist  
u\_out \= envelopeClamp(u\_out, heat, damage, jerk, v\_lim, c′\_local)

### **Базовые веса по режимам**

* **Decoupled:** `w_a = 0` (только clamp по безопасности).

* **Stabilized:** `w_a_rot = 0.4…0.7`, `w_a_trans = 0.0…0.2`.

* **Coupled:** `w_a = 0.5…0.85` (по пресету: sport/balanced/truck/heavy).

### **Эскалация влияния (до 100%)**

`w_a` растёт быстро при «выходе из‑под контроля» и спадает медленно:

* |β| \> β\*+Δβ\_thr, |ω| \> ω\_thr, перегрев/деградации, близость к объектам (низкая c′, докинг/узкое пространство).

* Рост `w_a`: τ\_up ≈ 100–150 мс; спад `w_a`: τ\_down ≈ 350–500 мс.

* Режимы докинга/аварии: принудительно `w_a → 1` локально по осям/каналам.

---

## **Как это выглядит для пилота**

* Пилот всегда «старше» на этапе ввода, но его команды формулируют **намерение**. Ассистент преобразует намерение в устойчивую траекторию внутри огибающей.

* «Hold RAW» (настраиваемая клавиша): временно принудительно `w_a=0` (кроме Safety‑клапов) — для продвинутых манёвров.

* HUD: индикатор **ASSIST AUTH** (0–100 %), причины эскалации (β, ω, тепло, близость), осевые бары влияния.

---

## **Автопилот и удалённый оператор**

* **Autopilot** — это источник намерений (целевые ускорения/траектория). Проходит через ассистента и envelope так же, как пилот. Может запрашивать `strict` (минимизировать пилотский вклад, но не обходить Safety).

* **Remote** — тот же подход; приоритет только на этапе источников. Envelope/ассистент всё равно «над» ним.

---

## **Сервер и детерминизм**

* Клиент и сервер исполняют один и тот же код ассистента; в командах указываются `assist_mode`, `preset_id`, ключевые параметры.

* Сервер пересчитывает `u_assist`, `w_a` и проверяет, что `u_out` достижим ThrusterLayout при текущих тепловых/повреждённых капах. При расхождении — мягкая коррекция.

---

## **Итоговые дефолты (если не возражаете)**

* Источники: **Remote ≥ Autopilot ≥ Local** (ассистент вне лестницы).

* Decoupled: `w_a=0`. Stabilized: `w_a_rot=0.6`, `w_a_trans=0.1`.

* Coupled: `w_a=0.7` базово; эскалация до `1.0` при `|β|>β*+5°` или `|ω|>ω_thr`.

* Cross‑fade takeover по осям: 150–200 мс, jerk‑лимит включён.

* «Hold RAW»: удержание снижает `w_a` к 0 за 120 мс, отпуск — возврат за 300 мс.

* HUD: **ASSIST AUTH**, причины эскалации, отдельные кольца влияния для вращения и трансляции.

Так ассистент всегда помогает (и при необходимости — доминирует), не отбирая у пилота право задавать намерение и не ломая идею «ассистенты — корректоры, а не второй пилот».

