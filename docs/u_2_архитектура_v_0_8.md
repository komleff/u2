# U2 — Архитектура

Версия: 0.8.1
Дата: 2025‑11‑14

Документ описывает архитектуру прототипа космического симулятора **Universe Unilimited**: как устроен игровой мир с замедленной и переменной скоростью света, как взаимодействуют клиент и сервер, как рассчитывается физика, управление и помощник пилота, как работают бой, интерфейс и наблюдаемость системы.

Текст рассчитан на архитекторов и разработчиков клиент‑серверных приложений, но написан более простым и понятным языком, чтобы его можно было прочитать без глубоких знаний в игровой разработке и физике. Специализированные термины вынесены в глоссарий (см. раздел «Глоссарий»).

---

## 0. Назначение и границы документа

Цели документа:

1. Зафиксировать целевую архитектуру минимальной версии игры (далее **минимальная версия** или **M0**).
2. Описать ключевые технические решения простым языком: как устроен мир с замедленным светом, как считается движение кораблей, как устроен бой и интерфейс.
3. Дать общую картину для всех участников команды: гейм‑дизайнеров, программистов, художников и тестировщиков.

Документ **не** описывает:

- Детали реализации пользовательского интерфейса (конкретный визуальный стиль, иконки, анимации).
- Полный перечень видов оружия, кораблей и экономических механик.
- Конкретный выбор библиотек и фреймворков для сети, визуализации и хранения данных.

Эти детали оформляются в отдельных документах по дизайну, техническим заданиям и спецификациям.

---

## 1. Итоговое видение минимальной версии

Минимальная версия нужна, чтобы как можно раньше проверить «скелет» игры: физику полёта, управление, сеть и помощников пилота.

### 1.1. Масштаб мира и нагрузка

- Одна звёздная система, представляемая в двумерной плоскости (вид сверху). В будущем предполагается расширение до трёхмерной модели.
- Один сервер мира обслуживает небольшой «остров» вселенной (шард).
- Целевая нагрузка для минимальной версии: **до 4 живых игроков** и **порядка 10 управляемых сервером кораблей‑ботов** на одном шарде.

Этого достаточно, чтобы проверить:

- стабильность физики и управления;
- корректность сетевого обмена и скрытие задержек;
- работу боевой системы и помощника пилота.

### 1.2. Игровой цикл и офлайн‑режим

Для разработки и отладки важен **офлайн‑режим**:

- симуляция мира и управление кораблём работают на одной машине;
- разработчик может воспроизводить сложные полётные ситуации без поднятия сервера и без сети;
- поведение корабля в офлайн‑режиме должно максимально совпадать с поведением в онлайн‑режиме при тех же входных данных.

Онлайн‑режим использует ту же физику и логику, но вводит:

- задержки сети,
- обмен состояниями между клиентом и сервером,
- проверки на стороне сервера.

---

## 2. Частоты работы системы, задержки и буферы

Разные части системы работают с разной частотой. Это позволяет экономить ресурсы и при этом обеспечивать плавный полёт и приемлемые задержки.

### 2.1. Основные частоты

Условные целевые значения частот для минимальной версии:

- **Шаг физики на сервере:** 30–60 шагов в секунду. На каждом шаге перерасчитывается положение и скорость кораблей, тепло и другие параметры.
- **Обновление состояния по сети:** примерно 15 раз в секунду для каждого активного объекта. Этого достаточно, если клиент между обновлениями интерполирует движение.
- **Кадры изображения на клиенте:** 60 кадров в секунду. Это частота отрисовки для плавного движения камеры и объектов.
- **Клиентский интегратор / предсказатель:** работает с частотой, кратной частоте отрисовки (например, те же 60 шагов в секунду), чтобы сглаживать движение между приходящими по сети состояниями.

Конкретные численные значения можно уточнять, но важен принцип: **сервер считает физику часто, сеть отправляет состояния реже, клиент дорисовывает движение между пришедшими состояниями**.

### 2.2. Задержки и очереди состояний

Задержка между сервером и клиентом состоит из:

- времени передачи данных по сети;
- времени обработки пакета на сервере и клиенте;
- времени до ближайшего шага браузера или игрового цикла.

Чтобы при этом движение кораблей казалось плавным, клиент использует **очередь будущих состояний**:

- состояния чужих кораблей отображаются с небольшой задержкой (например, 100–150 миллисекунд),
- за это время клиент успевает заранее получить несколько состояний и плавно интерполировать движение.

Свой корабль клиент при необходимости **предсказывает** (см. глоссарий: «предсказание»). При расхождении с серверным состоянием применяется мягкая подтяжка, а не резкий скачок.

---

## 3. Мир с замедленным и переменным светом

В игре используется модель, где **скорость света значительно ниже привычной** и может **меняться в разных частях пространства**.

### 3.1. Базовая скорость света

- Для удобства расчётов базовая скорость света в игре принимается порядка **10 000 метров в секунду** (10 километров в секунду).
- Это значение достаточно велико, чтобы корабли могли разгоняться до значительных скоростей и чувствовать эффекты относительности, но достаточно мало, чтобы задержки сигналов и видимые эффекты от них были заметны игроку.

### 3.2. Переменная скорость света и фактор γ

Скорость света в игре обозначается как **c′** и может зависеть от координаты (c′(x)). Вблизи массивных объектов (звёзды, крупные планеты, стационарные станции)

- c′ может быть ниже,
- фактор растяжения времени **γ** (гамма) возрастает.

Это даёт:

- более «тяжёлый», вязкий полёт вблизи крупных объектов;
- возможность сделать отдельные зоны космоса более «быстрыми» или «медленными» по ощущениям.

Формула для γ может соответствовать классической формуле специальной теории относительности:

> γ = 1 / √(1 − v² / c′²)

Важное **инвариантное условие** (см. глоссарий: «инвариант»): **скорость корабля не может превышать 0,999 от местной скорости света**.

Помимо физических причин, скорость света может плавно меняться и по технологическим причинам. Если в небольшой области пространства одновременно находится слишком много активных кораблей и сервер не успевает точно просчитать все их взаимодействия в заданное время, локальное значение c′ в этой области может быть временно снижено. Для игрока это выглядит как увеличение задержки прохождения света и сигналов от объектов, а не как сетевые проблемы. Когда нагрузка падает и серверу снова хватает времени на расчёты, значение c′ плавно возвращается к обычным настройкам для этой зоны.

### 3.3. Переходы между зонами

Мир делится на зоны, в каждой из которых c′ примерно постоянно. На границах зон:

- c′ изменяется **плавно**,
- γ и все производные величины (ускорения, нагрев) также меняются без скачков.

Это защищает игрока от неожиданных «рывков» при пересечении границ зон и делает модель более предсказуемой.

---

## 4. Сетевая модель: кто прав, что видно и когда

Основной принцип: **сервер хранит «истину», клиент показывает удобное для игрока приближение**.

### 4.1. Роли сервера и клиента

- **Сервер мира**:

  - хранит точное состояние всех объектов (положение, скорость, тепло, состояние систем);
  - принимает команды манёвра от игроков;
  - рассчитывает их последствия по физической модели;
  - проверяет команды на корректность и соблюдение ограничений игры.

- **Клиент игрока**:

  - собирает ввод (управление кораблём, выбор целей, действия интерфейса);
  - отправляет команды на сервер;
  - получает от сервера состояния объектов;
  - дорисовывает движение между полученными состояниями.

### 4.2. Маскировка сетевых задержек

Чтобы сетевые задержки были менее заметны, применяются следующие приёмы:

1. **Интерполяция**. Для чужих кораблей клиент отображает движение с небольшой задержкой, якобы обусловленной низкой скоростью света, плавно перемещая корабль между известными состояниями.
2. **Предсказание своего корабля**. Собственный корабль при необходимости рассчитывается на клиенте вперёд на один‑два шага. Когда приходит серверное состояние, клиент мягко подстраивает движение.
3. **Сглаживание ошибок**. Резкие отличия между прогнозируемым и серверным состоянием выравниваются за несколько кадров, чтобы игрок не видел резких скачков.

При этом сервер остаётся единственным источником истины: при существенном расхождении клиент обязан доверять серверу.

---

## 5. Физика, движение и тепло

Физическая модель должна быть достаточно простой для вычислений и достаточно выразительной, чтобы игрок чувствовал разницу между кораблями.

### 5.1. Движение корабля

В основе движения — классический закон изменения импульса:

- изменение импульса равно приложенной силе;
- скорость корабля получается из импульса и массы с учётом фактора γ.

Ускорение делится на две составляющие:

- вдоль направления скорости (продольное);
- поперёк направления скорости (поперечное).

Это позволяет задать разные пределы для разгона «вперёд» и для боковых манёвров и крена. Истребитель может иметь высокие поперечные ускорения, а грузовой корабль — более тяжёлый и медленный в поворотах.

### 5.2. Ограничения по перегрузке

Каждый корабль имеет:

- максимально допустимую продольную перегрузку;
- максимально допустимую поперечную перегрузку.

Если расчетное ускорение превышает эти значения, система либо уменьшает тягу двигателей, либо растягивает манёвр по времени, чтобы не выходить за пределы.

Для пилотируемых кораблей пределы перегрузки зависят от архетипа и задаются в их тактико-технических характеристиках: самые высокие значения — у спортивных кораблей, далее идут боевые истребители, самые низкие — у пассажирских и грузовых судов. В критической ситуации пилот может получить возможность временно отключить ограничение по перегрузке, осознанно рискуя кораблём и экипажем.

### 5.3. Тепло и охлаждение

Двигатели и оружие выделяют тепло. Для каждого корабля ведётся **баланс тепла**:

- при работе двигателя и оружия тепло растёт;
- системы охлаждения отводят тепло, скорость отвода зависит от конструкции корабля и окружающей среды.

При приближении температуры к критическому значению:

- уменьшается доступная тяга;
- снижается максимальная скорострельность оружия;
- возможны временные отключения отдельных систем.

Это создаёт понятную игроку связь: «сильнее давишь на газ и стреляешь — больше греешься — начинаешь терять эффективность».

---

## 6. Управление: источники команд и арбитраж

Кораблём управляют несколько типов источников команд:

1. Игрок (ручное управление из кабины).
2. Автопилот (например, следование по маршруту или выполнение стандартного манёвра).
3. Удалённый оператор (для беспилотных кораблей и кораблей, временно захваченных или переданных на дистанционное управление).
4. Сценарные или отладочные скрипты (для тестов и ботов).

### 6.1. Правила приоритета

Чтобы не возникало конфликтов, вводится **арбитраж команд**:

- на каждой оси управления (продольное ускорение, боковые манёвры, поворот) может быть **только один активный источник команд**;
- прямое управление игрока имеет наивысший приоритет и при необходимости вытесняет автопилот, удалённого оператора и сценарные скрипты;
- при отсутствии прямого управления активным источником могут быть автопилот, удалённый оператор или сценарий в зависимости от выбранного режима.

Ассистенты пилота при этом **не считаются отдельным источником управления**. Они образуют промежуточный слой между источниками команд и контроллерами двигателей: принимают команды от любого источника, сглаживают их, ограничивают по перегрузкам и теплу и следят за тем, чтобы корабль не уходил в неконтролируемое вращение или чрезмерный занос. Подробные схемы см. в документе «U2 — Управление».

Когда игрок отпускает органы управления, активный источник может переключиться (например, с прямого управления на автопилот или удалённого оператора), а ассистенты пилота обеспечивают плавный переход без резких скачков.

### 6.2. Плавное переключение

Переключение между источниками должно быть **плавным**:

- запрещены резкие скачки ускорений при смене источника;
- исходное состояние (скорость, угловая скорость) всегда учитывается новой системой управления;
- переход может растягиваться на несколько кадров, чтобы игрок не чувствовал «подмены».

---

## 7. Помощники пилота

Помощник пилота облегчает управление кораблём, особенно в режиме с высокой скоростью и в бою.

### 7.1. Стабилизация и удержание курса

Основные функции помощника пилота:

- удержание заданного курса и угловой скорости;
- подавление мелких колебаний и дрожания корабля;
- выполнение стандартных манёвров (разворот на 180°, выравнивание по цели, подведение к точке).

Игрок при этом сохраняет возможность **перехватить управление** в любой момент.

### 7.2. «Сопряжённый» режим ассистента пилота

Это один из режимов работы ассистента пилота. В «сопряжённом» режиме помощник пилота стремится:

- двигать корабль в направлении носа;
- автоматически компенсировать боковые и обратные скорости;
- помогать пилоту «чувствовать» корабль как спортивный автомобиль в контролируемом заносе.

Этот режим подходит для большинства игроков и используется как режим по умолчанию. Более сложный режим с полностью независимым движением по осям остаётся для опытных пилотов и тестирования.

---

## 8. Боевая модель и захват цели

Игроки и боты могут сражаться между собой с помощью бортового вооружения.

### 8.1. Захват цели

Система захвата цели выполняет:

- выбор объекта (корабль, станция, снаряд) как активной цели;
- отслеживание цели во времени;
- передачу данных о цели в прицел, помощник пилота и оружие.

При захвате цели могут отображаться дополнительные подсказки:

- вероятность попадания по текущей траектории;
- рекомендуемое упреждение;
- указатель на цель, если она вышла из поля зрения.

Стрельба бортовым оружием в базовой модели ведётся только по захваченной цели. Расчёт вероятности попадания и ожидаемого нанесённого урона зависит от тактико-технических характеристик атакующего корабля и цели, в первую очередь от калибра выбранного оружия и величины сигнатуры цели.

### 8.2. Ограничения на боевые манёвры

При расчёте боевых манёвров учитываются:

- физические ограничения по перегрузке и теплу;
- локальная скорость света и фактор γ;
- сетевые задержки (чтобы исключить использование задержек связи в качестве преимущества).

Сервер проверяет:

- допустимость команд стрельбы по дистанции, углу и скорости сближения;
- превышение физических ограничений корабля;
- попытки явно невозможных манёвров.

При нарушении условий команда может быть отвергнута или скорректирована.

---

## 9. Интерфейс пилота и сенсоры

Интерфейс пилота показывает информацию о состоянии корабля и окружающего мира.

### 9.1. Основные элементы интерфейса

На экране пилота должны быть видны:

- скорость и направление движения;
- угловая скорость и ориентация корабля;
- текущая перегрузка (продольная и поперечная);
- уровни тепла и состояния систем охлаждения;
- выбранная цель и её основные параметры (дистанция, относительная скорость);
- сетевые показатели (задержка до сервера, разброс задержки).

### 9.2. «Голограмма будущего»

Для лучшего понимания происходящего бортовой компьютер показывает игроку не только **видимое** положение объектов (с учётом задержки распространения света), но и **голограмму будущего** — приближённое представление о том, где объекты находятся «прямо сейчас».

В состав этой голограммы входят:

- примерное текущее положение  других кораблей с учётом последней известной скорости и светового расстояния до них (которое определяет задержку);
- ожидаемая траектория выбранной цели на несколько секунд вперёд;
- зоны, в которых при текущих скоростях возможен перехват цели или выход на оптимальную дистанцию.

Эти подсказки не обязаны быть абсолютно точными, но должны помогать игроку интуитивно понимать, чем отличается то, что он видит с задержкой, от того, как на самом деле может выглядеть обстановка в данный момент, и как нынешние манёвры отразятся на ситуации через мгновение.

---

## 10. Схемы данных и сообщения

В архитектуре выделяются несколько типов данных, которые постоянно передаются между клиентом и сервером и сохраняются.

Основные группы:

1. **Профиль корабля и игрока.** Масса, тяга двигателей, пределы перегрузки, тепловые характеристики и другие статические параметры. Эти параметры меняются редко: при ремонте и модернизации корабля на верфи или при получении серьёзных боевых повреждений. В обычном полёте они не обновляются по сети, что позволяет экономить трафик. Игрок привязан к выбранному при вылете со станции кораблю; при изменении профиля корабля сервер отправляет клиенту обновлённые данные.
2. **Снимки состояния мира.** Положение, скорость, ориентация и состояние систем всех активных объектов.
3. **Команды управления.** Запросы манёвров, активация вооружения, смена цели, действия по интерфейсу.
4. **Телеметрия и отладка.** Данные для анализа: задержки, частоты, расхождения между клиентом и сервером, события ошибок.

Сами форматы (поля, типы, двоичное или текстовое представление) описываются в отдельных технических спецификациях. Важно, чтобы:

- форматы были компактными по размеру;
- были устойчивы к расширению (возможность добавить поле без поломки старых клиентов);
- одинаково интерпретировались на сервере и клиенте.

---

## 11. Проверка и защита от нарушений правил

Сервер осуществляет базовую защиту от нарушений правил игры (античит).

Основные направления проверок:

- **физические ограничения:** скорость, ускорение, перегрузка, тепло не выходят за допустимые рамки;
- **честность управления:** команды приходят с разумной частотой и не противоречат предыдущим состояниям;
- **целостность данных:** сообщения не повреждены и не содержат невозможных комбинаций.

При обнаружении нарушений сервер может:

- отклонить конкретную команду;
- переслать клиенту исправленное состояние;
- зафиксировать событие в журнале для анализа и, при повторении, применить санкции к игроку.

---

## 12. Тестирование и повторяемость

Для уверенности в корректности работы системы важно, чтобы при одинаковых входных данных симуляция вела себя одинаково.

Это свойство называется **детерминизм** (см. глоссарий). Для его обеспечения:

- используется один и тот же порядок вычисления на сервере и в офлайн‑режиме;
- источники случайности или отключаются, или явно фиксируются (задание начальных значений);
- измеряется расхождение клиентского и серверного состояния после подстройки.

На основе этого строится набор приёмочных тестов:

- стандартные сценарии полёта и боя;
- серии переключений между режимами управления;
- воспроизведение записанных сессий.

---

## 13. Развёртывание и наблюдаемость

Даже для минимальной версии важна наблюдаемость работы системы.

### 13.1. Развёртывание минимальной версии

Минимальный набор для развёртывания:

- один сервер мира;
- один или несколько компонентов, отвечающих за приём подключений и балансировку нагрузки;
- система хранения журналов и телеметрии.

### 13.2. Наблюдаемость

Сервер и клиенты должны передавать телеметрию:

- частоты шагов симуляции и отрисовки;
- задержки и их разброс;
- расход процессорного времени и памяти;
- количество активных объектов в мире.

Это позволяет вовремя обнаруживать проблемные места и оценивать, как меняются характеристики системы при росте числа игроков.

---

## 14. Значения «по умолчанию» для минимальной версии

Для ускорения разработки вводятся типовые значения, которые можно использовать «из коробки» и изменять по мере необходимости.

Примеры таких значений:

- тестовая скорость света c′: 1 000 м/с для прототипа;
- базовая скорость света c′: 3 000-10 000 м/с в «обычном» космосе;
- повышенная скорость света c′: до 100 000–300 000 м/с в «быстрых» зонах (межзвёздные области);
- шаг физики на сервере: 30–60 раз в секунду;
- частота передачи состояний по сети: около 15 раз в секунду;
- задержка отображения чужих кораблей на клиенте: 100–150 миллисекунд.

Эти значения задаются в конфигурационных файлах и могут быть изменены без изменения архитектуры.

---

## 15. Что можно выбирать и менять без изменения архитектуры

Некоторые решения относятся к уровню архитектуры и зафиксированы в этом документе (например, принцип «сервер хранит истину» или разделение частот). Другие решения можно менять без изменения архитектуры:

- конкретный формат кодирования сообщений (двоичный или текстовый);
- библиотеку для отправки и приёма сетевых пакетов;
- способ хранения журналов и телеметрии;
- конкретные приёмочные тесты и их набор.

Всё это можно дорабатывать в ходе разработки, не ломая договорённости между клиентом, сервером, физикой и интерфейсом.

---

## Глоссарий

Ниже приведены термины, которые часто используются в документе.

**Игровой мир**\
Математическая модель космоса, в которой рассчитываются положение и движения кораблей, действие сил и скорость света.

**Шаг симуляции**\
Один цикл вычислений физики и логики на сервере. На каждом шаге пересчитываются положения и состояния объектов.

**Кадр визуализации**\
Один цикл отрисовки изображения на клиенте. Кадры могут идти чаще, чем шаги симуляции, чтобы движение выглядело плавно.

**Сервер мира**\
Программа, которая хранит и обновляет состояние игрового мира, принимает команды от игроков и рассылает им новые состояния.

**Клиент**\
Программа на стороне игрока. Показывает мир, принимает ввод управления и обменивается данными с сервером.

**Скорость света c′**\
Эффективная скорость распространения сигналов в игровом мире. Намеренно занижена по сравнению с реальной и может меняться в разных зонах.

**Местная скорость света**\
Текущее значение скорости света c′ в данной точке пространства. От него зависят допустимые скорости кораблей и величина факторов относительности.

**Фактор γ (гамма)**\
Число, показывающее, насколько сильно проявляются эффекты относительности при данной скорости и скорости света. Чем ближе скорость к скорости света, тем больше γ.

**Инвариант**\
Величина или условие, которое не должно нарушаться при работе системы. В нашем случае — ограничение скорости корабля сверху относительно местной скорости света.

**Перегрузка**\
Отношение ускорения к ускорению свободного падения. Показывает, насколько «давит» манёвр на корабль и экипаж.

**Тепловой режим**\
Состояние корабля с точки зрения нагрева и охлаждения: сколько тепла выделяют двигатели и оружие и как быстро системы охлаждения его отводят.

**Очередь будущих состояний**\
Небольшой буфер на клиенте, в котором хранятся будущие состояния объектов, уже полученные от сервера. Используется для плавного отображения движения с небольшой задержкой.

**Предсказание состояния**\
Расчёт клиентом своего состояния вперёд во времени на основе последних известных данных и команд. Нужен, чтобы уменьшить заметность задержки сети.

**Ассистент пилота**\
Подсистема, которая помогает управлять кораблём: стабилизирует его, удерживает курс, выполняет стандартные манёвры и сглаживает управление.

**«Сопряжённый» режим**\
Режим, в котором ассистент пилота стремится двигать корабль в сторону носа и гасить боковые скорости, делая управление более привычным.

**Захват цели**\
Процесс выбора объекта в качестве цели для оружия и помощника пилота. После захвата система отслеживает цель и показывает подсказки для наведения.

**Телеметрия**\
Служебные данные о работе системы: задержки, скорости, частоты, загрузка процессора, число объектов. Используется для анализа и оптимизации.

**Детерминизм**\
Свойство системы, при котором при одинаковых исходных данных результат симуляции всегда один и тот же.

**Развёртывание**\
Процесс установки и настройки серверов и вспомогательных компонентов игры в рабочей среде.

