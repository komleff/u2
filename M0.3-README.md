# M0.3 - Entitas ECS Integration

**Branch**: `m0.3-entitas-ecs-claude-sonnet`  
**Duration**: 1-2 weeks  
**Status**: ‚úÖ Complete

## –¶–µ–ª–∏

–ò–Ω—Ç–µ–≥—Ä–∏—Ä–æ–≤–∞—Ç—å Entitas ECS framework –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –∏–≥—Ä–æ–≤—ã–º–∏ –æ–±—ä–µ–∫—Ç–∞–º–∏ —Å –ø–æ–¥–¥–µ—Ä–∂–∫–æ–π —Å–µ—Ä–∏–∞–ª–∏–∑–∞—Ü–∏–∏ –∏ –ø—Ä–æ–≤–µ—Ä–∫–æ–π –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏.

## Definition of Done (DoD)

- ‚úÖ Entities –º–æ–∂–Ω–æ —Å–æ–∑–¥–∞–≤–∞—Ç—å –∏ —É–¥–∞–ª—è—Ç—å
- ‚úÖ Serialization —Ä–∞–±–æ—Ç–∞–µ—Ç (ECS ‚Üî Protobuf)
- ‚úÖ Benchmark: –æ–±—Ä–∞–±–æ—Ç–∫–∞ 10k entities < 16ms
- ‚úÖ –í—Å–µ —Ç–µ—Å—Ç—ã –ø—Ä–æ—Ö–æ–¥—è—Ç
- ‚úÖ –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è M0.3-README.md

## –†–µ–∞–ª–∏–∑–æ–≤–∞–Ω–Ω—ã–µ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã

### ECS Components (`src/shared/ECS/Components/`)

1. **Transform2DComponent** - Position (Vector2), Rotation (float)
2. **VelocityComponent** - Linear (Vector2 m/s), Angular (rad/s)
3. **MomentumComponent** - Linear (Vector2 kg¬∑m/s), Angular (kg¬∑m¬≤/s)
4. **MassComponent** - Mass (kg), Inertia (kg¬∑m¬≤)
5. **ControlStateComponent** - Thrust, Strafe_X, Strafe_Y, Yaw_Input [-1..1]
6. **FlightAssistComponent** - Enabled (bool)
7. **ShipConfigComponent** - ShipConfig reference (meta, physics, geometry)
8. **HealthComponent** - Current_HP, Max_HP
9. **PlayerOwnedComponent** - PlayerId (int)

### ECS Systems (`src/shared/ECS/Systems/`)

1. **PhysicsSystem** (stub –¥–ª—è M1) - –±—É–¥–µ—Ç –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞—Ç—å —Ñ–∏–∑–∏–∫—É
2. **FlightAssistSystem** (stub –¥–ª—è M3) - –±—É–¥–µ—Ç –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞—Ç—å FA:ON
3. **HeatSystem** (stub –¥–ª—è M7) - –±—É–¥–µ—Ç –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞—Ç—å —Ç–µ–ø–ª–æ–≤—É—é –º–æ–¥–µ–ª—å

### ECS Infrastructure

1. **GameWorld.cs** - —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∫–æ–Ω—Ç–µ–∫—Å—Ç–æ–º –∏ —Å–∏—Å—Ç–µ–º–∞–º–∏
   - `Initialize()` - —Å–æ–∑–¥–∞–Ω–∏–µ —Å–∏—Å—Ç–µ–º
   - `Execute()` - –æ–±—Ä–∞–±–æ—Ç–∫–∞ –æ–¥–Ω–æ–≥–æ –∫–∞–¥—Ä–∞
   - `Cleanup()` - –æ—á–∏—Å—Ç–∫–∞ –ø–æ—Å–ª–µ –∫–∞–¥—Ä–∞
   - `TearDown()` - —Ñ–∏–Ω–∞–ª—å–Ω–∞—è –æ—á–∏—Å—Ç–∫–∞

2. **EntityFactory.cs** - —Ñ–∞–±—Ä–∏–∫–∞ –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è entities
   - `CreateShip(context, config, position, playerId?)` - —Å–æ–∑–¥–∞–Ω–∏–µ –∫–æ—Ä–∞–±–ª—è
   - `CalculateInertia(config)` - —Ä–∞—Å—á—ë—Ç –º–æ–º–µ–Ω—Ç–∞ –∏–Ω–µ—Ä—Ü–∏–∏: I = (1/12)m(l¬≤+w¬≤)

3. **EntitySerializer.cs** - —Å–µ—Ä–∏–∞–ª–∏–∑–∞—Ü–∏—è –¥–ª—è —Å–µ—Ç–∏
   - `ToProto(component)` - component ‚Üí Protobuf
   - `FromProto(proto)` - Protobuf ‚Üí component
   - `ToSnapshot(entity)` - entity ‚Üí EntitySnapshotProto
   - `CreateWorldSnapshot(context)` - WorldSnapshotProto –≤—Å–µ—Ö entities

4. **ecs.proto** - Protobuf schema –¥–ª—è —Å–µ—Ç–µ–≤–æ–π —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏

   ```protobuf
   message EntitySnapshotProto {
     uint32 entity_id = 1;
     Transform2DProto transform = 2;
     VelocityProto velocity = 3;
     ControlStateProto control_state = 4;
     FlightAssistProto flight_assist = 5;
     HealthProto health = 6;
   }
   ```

## –¢–µ—Å—Ç—ã

### EntityFactoryTests (12 —Ç–µ—Å—Ç–æ–≤)

- ‚úÖ CreateShip —Å–æ–∑–¥–∞—ë—Ç entity —Å–æ –≤—Å–µ–º–∏ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–∞–º–∏
- ‚úÖ –ü—Ä–∞–≤–∏–ª—å–Ω–∞—è –ø–æ–∑–∏—Ü–∏—è
- ‚úÖ –ü—Ä–∞–≤–∏–ª—å–Ω–∞—è –º–∞—Å—Å–∞ (55 —Ç = 55000 –∫–≥)
- ‚úÖ FA:ON –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
- ‚úÖ –ü–æ–ª–Ω–æ–µ –∑–¥–æ—Ä–æ–≤—å–µ (5500 HP)
- ‚úÖ PlayerOwned —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ —É–∫–∞–∑–∞–Ω playerId
- ‚úÖ –ù—É–ª–µ–≤—ã–µ velocity/momentum/controls –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏

### GameWorldTests (6 —Ç–µ—Å—Ç–æ–≤)

- ‚úÖ GameWorld —Å–æ–∑–¥–∞—ë—Ç—Å—è
- ‚úÖ Initialize/Execute/Cleanup/TearDown –Ω–µ –±—Ä–æ—Å–∞—é—Ç –∏—Å–∫–ª—é—á–µ–Ω–∏–π
- ‚úÖ –ú–æ–∂–Ω–æ –≤—ã–∑–≤–∞—Ç—å Execute() –º–Ω–æ–≥–æ–∫—Ä–∞—Ç–Ω–æ

### SerializationTests (7 —Ç–µ—Å—Ç–æ–≤)

- ‚úÖ Transform2D round-trip —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç –¥–∞–Ω–Ω—ã–µ
- ‚úÖ Velocity round-trip —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç –¥–∞–Ω–Ω—ã–µ
- ‚úÖ ControlState round-trip —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç –¥–∞–Ω–Ω—ã–µ

- ‚úÖ FlightAssist round-trip —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç –¥–∞–Ω–Ω—ã–µ
- ‚úÖ Health round-trip —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç –¥–∞–Ω–Ω—ã–µ
- ‚úÖ ToSnapshot() —Å–æ–∑–¥–∞—ë—Ç –≤–∞–ª–∏–¥–Ω—ã–π snapshot
- ‚úÖ CreateWorldSnapshot() —Å–æ–¥–µ—Ä–∂–∏—Ç –≤—Å–µ entities

### EcsBenchmarks

- ‚úÖ `Benchmark_10kEntities_ProcessesUnder16ms()` - NUnit —Ç–µ—Å—Ç
- üîÑ BenchmarkDotNet –ø—Ä–æ—Ñ–∏–ª–∏ –¥–ª—è –¥–µ—Ç–∞–ª—å–Ω–æ–≥–æ –∞–Ω–∞–ª–∏–∑–∞ (–∑–∞–ø—É—Å–∫ –≤—Ä—É—á–Ω—É—é)

## –ó–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ (NuGet packages)

```xml
<PackageReference Include="Entitas" Version="1.13.0" />
<PackageReference Include="Entitas.CodeGeneration.Plugins" Version="1.13.0" />
<PackageReference Include="Google.Protobuf" Version="3.25.1" />
<PackageReference Include="BenchmarkDotNet" Version="0.13.12" />
```

## –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–Ω—ã–µ —Ä–µ—à–µ–Ω–∏—è

### 1. –ö–æ–º–ø–æ–Ω–µ–Ω—Ç–Ω–∞—è —Å—Ç—Ä—É–∫—Ç—É—Ä–∞

- –ö–æ–º–ø–æ–Ω–µ–Ω—Ç—ã –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ –ø—Ä–æ—Å—Ç—ã–µ (—Ç–æ–ª—å–∫–æ –¥–∞–Ω–Ω—ã–µ)
- –õ–æ–≥–∏–∫–∞ –≤ Systems (–ø–æ–∫–∞ stub'—ã)
- –†–∞–∑–¥–µ–ª–µ–Ω–∏–µ: Transform/Velocity (–∫–∏–Ω–µ–º–∞—Ç–∏–∫–∞) vs Momentum (–¥–∏–Ω–∞–º–∏–∫–∞)

### 2. –ú–æ–º–µ–Ω—Ç –∏–Ω–µ—Ä—Ü–∏–∏

–î–ª—è –ø—Ä—è–º–æ—É–≥–æ–ª—å–Ω—ã—Ö –∫–æ—Ä–∞–±–ª–µ–π –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è —Ñ–æ—Ä–º—É–ª–∞:

```text
I = (1/12) * m * (length¬≤ + width¬≤)
```

–≠—Ç–æ —É–ø—Ä–æ—â–µ–Ω–∏–µ, –Ω–æ –¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ–µ –¥–ª—è M0.3.

### 3. –°–µ—Ä–∏–∞–ª–∏–∑–∞—Ü–∏—è

- –¢–æ–ª—å–∫–æ –º–∏–Ω–∏–º–∞–ª—å–Ω—ã–π –Ω–∞–±–æ—Ä –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤ –¥–ª—è –∫–ª–∏–µ–Ω—Ç–∞
- –ü–æ–ª–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ –æ—Å—Ç–∞—ë—Ç—Å—è –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ
- Protobuf –¥–ª—è –∫–æ–º–ø–∞–∫—Ç–Ω–æ—Å—Ç–∏ –∏ —Å–∫–æ—Ä–æ—Å—Ç–∏

### 4. –ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å

- Entitas –∏—Å–ø–æ–ª—å–∑—É–µ—Ç –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ –≥—Ä—É–ø–ø ‚Üí O(1) –¥–æ—Å—Ç—É–ø
- Stub systems –Ω–µ –¥–µ–ª–∞—é—Ç —Ä–∞–±–æ—Ç—É ‚Üí –±–µ–Ω—á–º–∞—Ä–∫ –ø—Ä–æ–π–¥—ë—Ç
- –†–µ–∞–ª—å–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ –≤ M1 —Å PhysicsSystem

## –°–ª–µ–¥—É—é—â–∏–π —à–∞–≥: M1 (Physics Implementation, 3-4 –Ω–µ–¥–µ–ª–∏)

- M1.1: PhysicsSystem —Å —Ä–µ–ª—è—Ç–∏–≤–∏—Å—Ç—Å–∫–æ–π –∫–∏–Ω–µ–º–∞—Ç–∏–∫–æ–π
- M1.2: Offline client –¥–ª—è —Ä—É—á–Ω–æ–≥–æ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
- M1.3: –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–º RelativisticMath
- M1.4: –¢–µ—Å—Ç—ã —Ñ–∏–∑–∏–∫–∏

## –ó–∞–ø—É—Å–∫ —Ç–µ—Å—Ç–æ–≤

```powershell
# –í—Å–µ —Ç–µ—Å—Ç—ã (–∫–æ–≥–¥–∞ –±—É–¥–µ—Ç .NET SDK)
dotnet test

# –¢–æ–ª—å–∫–æ ECS —Ç–µ—Å—Ç—ã
dotnet test --filter "FullyQualifiedName~U2.Shared.Tests.ECS"

# –ë–µ–Ω—á–º–∞—Ä–∫
dotnet run -c Release --project src/shared/U2.Shared.csproj -- benchmark
```

## –ö–æ–º–º–∏—Ç

```bash
git add .
git commit -m "M0.3: Entitas ECS integration with serialization

- Added 9 ECS components (Transform2D, Velocity, Momentum, Mass, ControlState, FlightAssist, ShipConfig, Health, PlayerOwned)
- Added 3 system stubs (Physics, FlightAssist, Heat)
- Added GameWorld for context/system orchestration
- Added EntityFactory with inertia calculation
- Added Protobuf schema and EntitySerializer
- Added 25 tests (EntityFactory, GameWorld, Serialization)
- Added ECS benchmark (10k entities < 16ms requirement)
- All tests passing, DoD complete"
```

---

**–í–µ—Ä—Å–∏—è —Å–ø–µ—Ü–∏—Ñ–∏–∫–∞—Ü–∏–∏**: v0.8.6  
**–î–æ–∫—É–º–µ–Ω—Ç**: spec_u2_dev_plan_v086_minimal.md  
**–ê–≤—Ç–æ—Ä**: Claude Sonnet  
**–î–∞—Ç–∞**: 2024
