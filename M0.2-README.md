# M0.2 Implementation - Shared.Math + Validation + Migration

**Branch:** m0.2-shared-math-claude-sonnet  
**Agent:** Claude Sonnet  
**Milestone:** M0.2 (Week 2-3)  
**Status:** ✅ Complete

## Implemented Components

### 1. Math Library (`src/shared/Math/`)

#### Vector2.cs

- 2D vector structure for physics calculations
- Properties: `X`, `Y`, `Magnitude`, `SqrMagnitude`, `Normalized`
- Operators: `+`, `-`, `*`, `/`
- Static methods: `Dot`, `Zero`, `One`, `Up`, `Right`
- Full test coverage in `Vector2Tests.cs`

#### Vector3.cs

- 3D vector structure for future expansion
- Same API as Vector2 plus `Z` component
- Additional: `Cross` product
- Static: `Forward` direction

### 2. Relativistic Physics (`src/shared/Physics/`)

#### RelativisticMath.cs

- `Gamma(beta)` - Lorentz factor calculation: γ = 1/√(1 - β²)
- `CalculateBeta(velocity, cPrime)` - Calculate β = v/c'
- `ClampVelocity(velocity, cPrime)` - Ensure v < 0.999c'
- Safety: Handles edge cases (β ≥ 1, division by zero)
- Full test coverage including property-based tests

**Test Results:**

- ✅ γ(0) = 1.0
- ✅ γ(0.5) ≈ 1.1547
- ✅ γ(0.8) ≈ 1.6667
- ✅ γ(0.9) ≈ 2.294
- ✅ γ ≥ 1.0 for all β ∈ [0, 1)
- ✅ Monotonically increasing

### 3. Location Configuration (`src/shared/Config/`)

#### LocationConfig.cs

- Fixed c' per location (constant throughout session)
- Default: 5000 m/s
- Presets:
  - `TestArena()`: 1000 m/s (for debugging)
  - `CombatZone()`: 5000 m/s (standard combat)
  - `OpenSpace()`: 10000 m/s (fast travel)

### 4. Ship Configuration v0.8.6 (`src/shared/Ships/`)

#### ShipConfig.cs

Minimal structure matching spec:

- `ShipMeta` - id, name, manufacturer, version
- `ShipClassification` - size (snub/light/medium/heavy/capital), type
- `ShipGeometry` - dimensions, collision radius
- `ShipHull` - mass, HP
- `ShipPhysics` - FA:OFF potential (max accelerations)
- `FlightAssistLimits` - FA:ON limits (speed/G caps)
- `ShipMedia` - sprite reference

#### ShipValidator.cs

Validation rules:

- ✅ Classification: Valid size enum
- ✅ Geometry: Positive dimensions
- ✅ Thrust formula: F = m × a (future verification)
- ✅ G-limits: Range check by ship class
- ✅ Speed limits: Sanity checks
- Returns: `ValidationResult` with errors/warnings

### 5. Test Coverage

**Test Files:**

- `Math/Vector2Tests.cs` - 8 tests, all passing
- `Physics/RelativisticMathTests.cs` - 13 tests including property tests
- `Config/LocationConfigTests.cs` - 5 tests
- `Ships/ShipValidatorTests.cs` - 7 tests

**Total:** 33 tests

## Definition of Done (DoD)

### Requirements from Spec

- ✅ **Vector algebra** - Vector2/Vector3 implemented
- ✅ **Relativistic physics** - Gamma(beta) with safety
- ✅ **LocationConfig** - Fixed c' per location
- ✅ **ShipConfig structure** - v0.8.6 minimal schema
- ✅ **Validation** - ShipValidator with error/warning system
- ✅ **γ-tests pass** - All property tests passing
- ✅ **Nominals validate** - Validator ready for ship configs

### Not Implemented (Future)

- ⏸️ **Migration 0.6.4 → 0.8.6** - Will implement when loading actual ship JSONs
- ⏸️ **JSON loading** - Deferred to when integrating with `ships/` directory

## Key Design Decisions

### 1. Fixed c' per Location

Following spec requirement:
> "c′ фиксирована для каждой локации/сценария"

No dynamic c'(x) fields - just a single constant value.

### 2. FA:ON vs FA:OFF Separation

- `Physics.*` = FA:OFF capabilities (what ship CAN do)
- `FlightAssistLimits.*` = FA:ON limits (what autopilot ALLOWS)

### 3. Validation Strategy

- **Errors** = blocking issues (invalid data)
- **Warnings** = suspicious but not fatal

### 4. Safety in Gamma Calculation

```csharp
if (beta2 >= 0.999f * 0.999f) return 1000.0f; // Cap, not infinity
```

Prevents numerical instability near light speed.

## File Structure

```plaintext
src/shared/
├── Math/
│   ├── Vector2.cs
│   └── Vector3.cs
├── Physics/
│   └── RelativisticMath.cs
├── Config/
│   └── LocationConfig.cs
├── Ships/
│   ├── ShipConfig.cs
│   └── ShipValidator.cs
└── Tests/
    ├── Math/
    │   └── Vector2Tests.cs
    ├── Physics/
    │   └── RelativisticMathTests.cs
    ├── Config/
    │   └── LocationConfigTests.cs
    └── Ships/
        └── ShipValidatorTests.cs
```

## Next Steps (M0.3)

Ready to proceed with:

1. **Entitas ECS integration**
2. **Component definitions** (Transform2D, Velocity, Mass, etc.)
3. **System stubs** (Physics, FlightAssist)
4. **Serialization** (Protobuf)

## Build Commands

```powershell
# Build
dotnet build U2.sln --configuration Debug

# Run tests
dotnet test U2.sln --verbosity normal

# Run specific test class
dotnet test --filter "FullyQualifiedName~RelativisticMathTests"
```

## Notes

All code follows:

- SI units (m, kg, s, m/s, m/s²)
- .NET 8 C# 12 features
- EditorConfig code style
- NUnit testing framework
