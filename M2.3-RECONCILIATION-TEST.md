# M2.3 Reconciliation Manual Test Instructions

## Цель теста
Проверить, что сервер корректно отправляет `lastProcessedSequence` в снапшотах и клиент использует его для reconciliation.

## Pre-requisites
- ✅ Сервер запущен (`U2.Server.exe` на UDP:7777, WS:8080)
- ✅ Клиент открыт в браузере (`http://localhost:5174`)

## Test Steps

### 1. Откройте DevTools Console (F12)

### 2. Проверьте подключение
Ожидаемый вывод в консоли:
```
[NetworkClient] WebSocket connected
[NetworkClient] Connection accepted: clientId=X, entityId=Y
```

### 3. Начните движение (нажмите W/A/S/D)

### 4. Проверьте в консоли следы reconciliation
Должны появиться логи с lastProcessedSequence:

```typescript
// В NetworkManager.ts (src/network/NetworkManager.ts:185)
// Добавьте временный лог для проверки:
console.log(`[Reconcile] seq=${lastProcessed}, state=`, state);
```

### 5. Ожидаемое поведение
- **До изменений (M2.3)**: `lastProcessed` всегда был `0`
- **После изменений**: `lastProcessed` должен увеличиваться по мере обработки инпутов сервером

### 6. Проверка в сетевом трафике
1. DevTools → Network → WS (фильтр WebSocket)
2. Выберите соединение `ws://localhost:8080`
3. Перейдите в Messages
4. Найдите WorldSnapshotProto бинарные сообщения
5. В декодированном виде (через protobuf) должно быть поле `lastProcessedSequence` > 0

## Verification Criteria

### ✅ Success Indicators
1. **Server logs** (в терминале сервера):
   ```
   Applied input for entity X: seq=123, thrust=0.5
   ```
   
2. **Client console** (в DevTools):
   - Reconciliation вызывается с `lastProcessed > 0`
   - Плавное движение корабля без "прыжков"
   
3. **Proto inspection**:
   - `EntitySnapshotProto.lastProcessedSequence` присутствует
   - Значение растет вместе с sequence numbers инпутов

### ❌ Failure Indicators
1. `lastProcessed` всегда равен `0`
2. Ошибки компиляции proto
3. WebSocket disconnects
4. Reconciliation не вызывается

## Code Changes Verified

### Protocol (ecs.proto)
```protobuf
message EntitySnapshotProto {
  // ... existing fields ...
  uint32 last_processed_sequence = 7; // ← NEW
}
```

### Server (C#)
- `ClientConnection.LastProcessedSequence` property
- `MessageProcessor.HandlePlayerInput()` updates sequence
- `EntitySerializer.ToSnapshot()` includes sequence
- `NetworkGameLoop.CreateWorldSnapshot()` queries sequences

### Client (TypeScript)
- `NetworkManager.handleSnapshot()` reads `lastProcessedSequence`
- Passes to `PredictionEngine.reconcile()` instead of hardcoded `0`

## Known Issues (из аудита)

### Finding #2: Integration tests fail (jsdom)
- **Status**: CONFIRMED
- **Impact**: Не блокирует ручное тестирование
- **Solution**: Будет реализовано позже с Node.js + ws library

### Finding #3: Platform-specific path
- **Status**: CONFIRMED
- **Impact**: Не влияет на функциональность reconciliation
- **Solution**: Будет исправлено позже

## Next Steps After Verification

1. ✅ Если reconciliation работает корректно:
   - M2.3 Finding #4 (CRITICAL) → **RESOLVED**
   - Обновить M2.3-AUDIT-REPORT.md со статусом FIXED

2. ⏳ Оставшиеся задачи M2.3:
   - Fix Finding #2 (integration test environment)
   - Fix Finding #3 (cross-platform paths)
   - Implement Finding #5 (unit tests)
   - RTT latency measurement tests
   - Multi-player testing (2+ clients)

## Debug Tips

### Если lastProcessedSequence всегда 0:
1. Проверьте серверные логи: обрабатываются ли инпуты?
2. Проверьте `ConnectionManager.GetAllConnections()` возвращает клиента
3. Проверьте `connection.LastProcessedSequence` обновляется в `HandlePlayerInput()`

### Если WebSocket не подключается:
1. Проверьте `U2.Server.exe` запущен
2. Проверьте порты 7777 (UDP) и 8080 (WS) свободны
3. Проверьте логи сервера на ошибки

### Если reconciliation не вызывается:
1. Проверьте `NetworkManager.config.enablePrediction === true`
2. Проверьте `entityId === this.localEntityId`
3. Проверьте `this.prediction !== null`

---

**Date**: 2025-01-18  
**Milestone**: M2.3 Definition of Done  
**Status**: IMPLEMENTATION COMPLETE, AWAITING MANUAL VERIFICATION
