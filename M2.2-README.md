# M2.2: UDP Transport and Server Infrastructure

**Status**: ðŸš§ Implementation In Progress  
**Tests**: 199/199 passing (100%)  
**Date**: 2025-11-18  
**Spec Compliance**: Aligned with spec_u2_dev_plan_v086_minimal.md (M2.2)

## Overview

M2.2 implements the UDP transport layer and network server infrastructure for the U2 game engine. This builds upon M2.1 (Protobuf Protocol) to enable real-time multiplayer gameplay.

## Specification Alignment

### Mapping to Specification Documents

This implementation aligns with:
- `docs/specs/gameplay/spec_u2_dev_plan_v086_minimal.md` (lines 391-407)
- `docs/specs/tech/spec_u2_architecture_v086_minimal.md` (network architecture sections)

### M2.2 Requirements

From specification:
- **UDP transport** (server â†’ clients) âœ…
- **Client-side prediction** â³ (planned for client implementation)
- **Reconciliation (replay)** â³ (planned for client implementation)
- **Fixed rates**: 30 Hz commands, 15 Hz snapshots âœ…
- **DoD**: 2 players online works, RTT 50ms smooth, RTT 200ms stabilizes in 1-2 sec â³

## Architecture

### Network Flow

```
Client                          Server (UDP Port 7777)
  |                               |
  |-- ConnectionRequestProto ---->|  (via UDP)
  |<-- ConnectionAcceptedProto ---|  (assigns client_id & entity_id)
  |                               |
  |-- PlayerInputProto ---------->|  (30 Hz - not enforced yet)
  |<-- WorldSnapshotProto --------|  (15 Hz broadcast)
  |                               |
```

### Server Components

#### 1. UdpServer
**Location**: `src/server/Network/UdpServer.cs`

Low-level UDP socket server with async message handling.

**Features**:
- Non-blocking async receive loop
- Message-based event system
- Broadcast support for world snapshots
- Graceful shutdown

**API**:
```csharp
var server = new UdpServer(port: 7777, logger);
server.MessageReceived += OnMessageReceived;
server.Start();
await server.SendAsync(data, endpoint);
await server.BroadcastAsync(data);
server.Stop();
```

#### 2. ConnectionManager
**Location**: `src/shared/Network/ConnectionManager.cs`

Manages client connections with automatic ID assignment.

**Features**:
- Automatic client ID generation (monotonic counter)
- Endpoint â†’ Client mapping
- Last-seen tracking for stale connection removal
- Entity ID association for player entities

**API**:
```csharp
var manager = new ConnectionManager(logger);
var connection = manager.UpdateClient(endpoint);  // Creates or updates
var conn = manager.GetClient(clientId);
manager.RemoveStaleConnections(timeout);
```

**Tests**: 9 comprehensive unit tests covering all core functionality

#### 3. MessageProcessor
**Location**: `src/server/Network/MessageProcessor.cs`

Processes incoming Protobuf messages and routes them to game logic.

**Handles**:
- **ConnectionRequestProto**: Creates player entity, sends ConnectionAcceptedProto
- **PlayerInputProto**: Applies input to player's entity (control state + flight assist)

**Integration**:
```csharp
var processor = new MessageProcessor(logger, connectionManager, gameWorld, server);
server.MessageReceived += processor.ProcessMessage;
```

#### 4. NetworkGameLoop
**Location**: `src/server/Network/NetworkGameLoop.cs`

Fixed-rate game loop with snapshot broadcasting.

**Features**:
- Fixed 15 Hz snapshot rate (configurable)
- Physics tick rate: 60 Hz (GameWorld deltaTime)
- Automatic timing compensation for consistent frame rate
- Full world state serialization via EntitySerializer

**Timing**:
```
GameWorld.Execute() â†’ 60 Hz (16.67ms per tick)
Snapshot Broadcast â†’ 15 Hz (66.67ms per snapshot)
```

**Usage**:
```csharp
var loop = new NetworkGameLoop(logger, gameWorld, server, connectionManager, snapshotRate: 15.0f);
loop.Start();
// ... runs until stopped ...
loop.Stop();
```

### Enhanced GameWorld

**Location**: `src/shared/ECS/GameWorld.cs`

Added network-specific methods:

```csharp
// Create player entity with default ship config
GameEntity entity = gameWorld.CreatePlayerEntity(clientId);

// Get entity by ID for input processing
GameEntity? entity = gameWorld.GetEntityById(entityId);

// Get all entities for snapshot serialization
GameEntity[] entities = gameWorld.GetAllEntities();
```

## Server Modes

The server supports two modes via command-line arguments:

### M1 Mode (Default)
```bash
dotnet run --project src/server/U2.Server.csproj
```
Single physics tick demonstration (legacy mode).

### M2.2 Network Mode
```bash
dotnet run --project src/server/U2.Server.csproj -- --network
```
Full network server with UDP transport.

**Server Configuration**:
- Port: 7777
- Physics tick rate: 60 Hz
- Snapshot broadcast rate: 15 Hz
- Speed of light: 5000 m/s (CombatZone)

## Message Flow

### Connection Establishment

```
1. Client sends ConnectionRequestProto:
   {
     player_name: "Player1",
     version: "0.8.6"
   }

2. Server processes request:
   - Creates ClientConnection (assigns client_id)
   - Creates GameEntity for player (assigns entity_id)
   - Stores mapping: client_id â†’ entity_id

3. Server sends ConnectionAcceptedProto:
   {
     client_id: 1,
     entity_id: 42,
     server_time_ms: 1234567890
   }
```

### Input Processing

```
1. Client sends PlayerInputProto (every frame, ~30-60 Hz):
   {
     client_id: 1,
     sequence_number: 123,
     timestamp_ms: 1234567890,
     control_state: {
       thrust: 1.0,
       strafe_x: 0.0,
       strafe_y: 0.0,
       yaw_input: 0.5
     },
     flight_assist: true
   }

2. Server validates:
   - Client is accepted
   - Client ID matches connection
   - Entity exists

3. Server applies input:
   - Updates entity.controlState
   - Updates entity.flightAssist
```

### Snapshot Broadcasting

```
1. Server creates WorldSnapshotProto (every 66.67ms at 15 Hz):
   {
     tick: 456,
     timestamp_ms: 1234567890,
     entities: [
       {
         entity_id: 42,
         transform: { position: {x: 10, y: 20}, rotation: 45 },
         velocity: { linear: {x: 5, y: 0}, angular: 0 },
         control_state: { thrust: 1.0, ... },
         flight_assist: { enabled: true },
         health: { current_hp: 950, max_hp: 1000 }
       },
       // ... more entities ...
     ]
   }

2. Server wraps in ServerMessageProto
3. Server broadcasts to all connected clients
```

## Default Ship Configuration

**Used for all network-spawned players**:
- Class: Default Fighter (Origin M50-like interceptor)
- Mass: 10 tons
- Hull: 1000 HP
- Linear Acceleration: 90 m/sÂ² forward, 67.5 m/sÂ² reverse
- Strafe Acceleration: 85 m/sÂ² lateral
- Angular Acceleration: 240Â°/sÂ² pitch, 200Â°/sÂ² yaw, 325Â°/sÂ² roll
- FA:ON Speed Limits: 260 m/s forward, 180 m/s reverse, 220 m/s lateral
- FA:ON Angular Limits: 95Â°/s pitch, 80Â°/s yaw, 130Â°/s roll
- G-Limit: 11g

See `src/shared/ECS/GameWorld.cs:CreatePlayerEntity()` for full configuration.

## Testing

### Test Coverage

**File**: `src/shared/Tests/Network/ConnectionManagerTests.cs`

**Tests** (9 total):
1. `UpdateClient_NewClient_AssignsClientId` - New client registration
2. `UpdateClient_ExistingClient_UpdatesLastSeen` - Connection keep-alive
3. `UpdateClient_MultipleClients_AssignsUniqueIds` - Concurrent connections
4. `GetClient_ByEndpoint_ReturnsCorrectConnection` - Endpoint lookup
5. `GetClient_ByClientId_ReturnsCorrectConnection` - ID lookup
6. `GetAllEndpoints_ReturnsAllConnectedEndpoints` - Broadcast list
7. `RemoveStaleConnections_RemovesOldConnections` - Timeout cleanup
8. `RemoveStaleConnections_KeepsRecentConnections` - Active protection
9. `ClientConnection_CanSetEntityId` - Entity association

### Running Tests

```bash
dotnet test
```

**Result**: 199/199 tests passing (100%)
- M2.1 tests: 190
- M2.2 tests: 9

## Network Protocol

### Message Sizes

Based on M2.1 specification:

| Message Type | Typical Size | Frequency |
|--------------|--------------|-----------|
| PlayerInputProto | ~40 bytes | 30-60 Hz (per client) |
| ConnectionRequestProto | ~30 bytes | Once per client |
| ConnectionAcceptedProto | ~25 bytes | Once per client |
| EntitySnapshotProto | ~70-100 bytes | Per entity, 15 Hz |
| WorldSnapshotProto (10 entities) | ~800-1000 bytes | 15 Hz broadcast |

### Bandwidth Estimation

**Per Client** (connected):
- Outbound: 40 bytes Ã— 30 Hz = 1,200 bytes/s = 9.6 kbps
- Inbound: 1,000 bytes Ã— 15 Hz = 15,000 bytes/s = 120 kbps

**Server** (10 clients):
- Inbound: 1,200 bytes/s Ã— 10 = 12,000 bytes/s = 96 kbps
- Outbound: 15,000 bytes/s Ã— 10 = 150,000 bytes/s = 1.2 Mbps

Note: No delta compression or interest management yet (planned for future milestones).

## Next Steps

### M2.3: Client-Side Prediction (Planned)

**TypeScript client implementation**:
- WebSocket or WebRTC data channel (browser compatibility)
- Local physics simulation matching server
- Input history buffer for reconciliation
- Smooth interpolation between snapshots

### M2.4: Reconciliation (Planned)

**Server authoritative correction**:
- Compare server snapshot with local prediction
- Detect divergence threshold
- Rewind to server state
- Replay buffered inputs

### M2.5: Optimizations (Future)

- Delta compression for snapshots
- Interest management (spatial culling)
- Adaptive tick rate based on RTT
- Packet loss handling

## Performance Considerations

### Current Implementation

- âœ… Fixed-rate loop with timing compensation
- âœ… Async I/O for non-blocking network operations
- âœ… Minimal memory allocations (reuse Protobuf objects where possible)
- âš ï¸ No delta compression (full snapshots every tick)
- âš ï¸ No spatial culling (all entities to all clients)

### Known Limitations

1. **Full Snapshots**: Every snapshot contains all entities, even if unchanged
2. **No Packet Loss Handling**: UDP is unreliable; lost snapshots are not retransmitted
3. **No Input Acknowledgment**: Server doesn't confirm which inputs were processed
4. **No Interpolation**: Client must implement smooth rendering

These will be addressed in future milestones.

## DoD Verification

| Criterion | Status | Notes |
|-----------|--------|-------|
| UDP transport implemented | âœ… | UdpServer with async receive loop |
| Connection management | âœ… | Auto ID assignment, stale removal |
| Message processing | âœ… | Protobuf deserialization, entity updates |
| World snapshot broadcasting | âœ… | 15 Hz fixed rate |
| Fixed snapshot rate (15 Hz) | âœ… | Configurable NetworkGameLoop |
| Fixed input rate (30 Hz) | â³ | Server accepts at any rate (client-dependent) |
| 2 players online | â³ | Requires client implementation |
| RTT 50ms smooth | â³ | Requires client + testing |
| RTT 200ms stabilizes in 1-2s | â³ | Requires reconciliation |
| Unit tests | âœ… | 9 tests for ConnectionManager |
| Integration tests | â³ | Pending client implementation |
| Documentation | âœ… | This README |

## Running the Server

### Start Network Server

```bash
cd /home/runner/work/u2/u2
dotnet run --project src/server/U2.Server.csproj -- --network
```

**Expected Output**:
```
U2 Server starting...
M0.1 - Repository and build structure initialized
M1 - Relativistic physics and collision systems
M2.1 - Protobuf protocol (190/190 tests passing)
M2.2 - UDP Transport initialization
Running in M2.2 mode (network server)
Location: CombatZone, c' = 5000 m/s
Physics tick rate: 60 FPS (dt = 0.0167s)
Snapshot broadcast rate: 15 Hz
GameWorld initialized
UDP server started on port 7777
Network server running on port 7777
Press any key to stop server...
```

### Test with netcat (UDP)

```bash
# Send test UDP packet to server
echo "test" | nc -u localhost 7777
```

Server should log the received message (though it won't parse as valid Protobuf).

## References

- **Specification**: `docs/specs/gameplay/spec_u2_dev_plan_v086_minimal.md` (lines 391-407)
- **M2.1 README**: `M2.1-README.md` (Protobuf protocol foundation)
- **Architecture**: `docs/specs/tech/spec_u2_architecture_v086_minimal.md`
- **Server Code**: `src/server/Network/`
- **Shared Network Code**: `src/shared/Network/`
- **Tests**: `src/shared/Tests/Network/`

## Changelog

### 2025-11-18: Initial M2.2 Implementation

**Added**:
- UDP server infrastructure with async receive loop
- Connection manager with automatic client ID assignment
- Message processor for Protobuf message routing
- Network game loop with 15 Hz snapshot broadcasting
- Enhanced GameWorld with player entity creation
- 9 comprehensive unit tests for ConnectionManager
- Network mode support in Program.cs

**Status**: Server infrastructure complete, awaiting client implementation for full DoD verification.
